{% extends "base.html" %}
{% block title %}ì˜ìƒ ì—…ë¡œë“œ - MONEYING{% endblock %}

{% block main_class %}max-w-4xl mx-auto px-4 md:px-6 pt-24 md:pt-28 pb-20{% endblock %}

{% block content %}
<style>
  .dropzone.dragover { border-color:#a3e635; box-shadow:0 0 0 3px rgba(163,230,53,0.15); }
</style>

<div class="mb-8">
  <a href="/seller/dashboard" class="text-zinc-500 hover:text-white text-sm">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  <h1 class="text-3xl font-black mt-4">ğŸ“¸ ì§ì´¬ ì˜ìƒ ì—…ë¡œë“œ</h1>
  <p class="text-zinc-400 mt-2">ì œí’ˆ ì˜ìƒê³¼ ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•˜ë©´ í¬ë¦¬ì—ì´í„°ë“¤ì—ê²Œ ë…¸ì¶œë©ë‹ˆë‹¤.</p>
</div>

<!-- ì•ˆë‚´ -->
<div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 mb-8">
  <p class="text-zinc-400 text-sm">
    <strong class="text-white">ğŸ“Œ ì—…ë¡œë“œ ì•ˆë‚´</strong><br>
    â€¢ <span class="text-red-400 font-bold">í•˜ì´ë¼ì´íŠ¸ ìº¡ì²˜ ì´ë¯¸ì§€</span>ì™€ <span class="text-red-400 font-bold">ì¿ íŒ¡ ë§í¬</span>ëŠ” <strong class="text-white">í•„ìˆ˜</strong>ì…ë‹ˆë‹¤.<br>
    â€¢ ì´ë¯¸ì§€ëŠ” 1~5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
    â€¢ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ê°¤ëŸ¬ë¦¬ì— ë…¸ì¶œë©ë‹ˆë‹¤.
  </p>
</div>

<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 md:p-8">
  <div class="grid md:grid-cols-2 gap-6">

    <!-- ì™¼ìª½: ì •ë³´ ì…ë ¥ -->
    <div>
      <label class="text-xs font-black tracking-widest text-zinc-500 uppercase">ì¹´í…Œê³ ë¦¬</label>
      <div class="mt-2 w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-[#a3e635] font-bold">
        ğŸ“¸ íŒë§¤ì ì§ì´¬
      </div>
      <p class="text-zinc-500 text-xs mt-2">íŒë§¤ì ì˜ìƒì€ ìë™ìœ¼ë¡œ "íŒë§¤ì ì§ì´¬" ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.</p>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì œëª© <span class="text-red-400">*</span></label>
      <input id="title" type="text" placeholder="ì˜ˆ: ë¯¸ë‹ˆ ì†ì„ í’ê¸°"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-black focus:border-[#a3e635] focus:outline-none"/>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì¿ íŒ¡ ë§í¬ <span class="text-red-400">*</span></label>
      <input id="coupang" type="text" placeholder="link.coupang.com/a/..."
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-bold focus:border-[#a3e635] focus:outline-none"/>
      <p class="text-zinc-500 text-xs mt-2">ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì°¸ê³  ì˜ìƒ ë§í¬ (ì„ íƒ, ìµœëŒ€ 3ê°œ)</label>
      <p class="text-zinc-500 text-xs mt-1 mb-2">í‹±í†¡, ë„ìš°ì¸, ì¸ìŠ¤íƒ€, ìœ íŠœë¸Œ, ë„¤ì´ë²„ MYBOX ë“± ì§€ì›</p>
      <input id="link1" type="text" placeholder="ë§í¬ 1"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
      <input id="link2" type="text" placeholder="ë§í¬ 2"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
      <input id="link3" type="text" placeholder="ë§í¬ 3"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
    <div>
      <label class="text-xs font-black tracking-widest text-zinc-500 uppercase">í•˜ì´ë¼ì´íŠ¸ ìº¡ì²˜ ì—…ë¡œë“œ (1~5ì¥) <span class="text-red-400">*</span></label>

      <div id="dropzone" class="dropzone mt-2 bg-zinc-900/60 border border-zinc-700 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-[#a3e635] transition min-h-[200px]">
        <i class="fas fa-cloud-upload-alt text-3xl text-[#a3e635] mb-3"></i>
        <p class="font-black">ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì´ë¯¸ì§€ ì˜¬ë¦¬ê¸°</p>
        <p class="text-xs text-zinc-500 mt-1">ë˜ëŠ” í´ë¦­í•´ì„œ ì„ íƒ (jpg/png/webp/gif)</p>
        <input id="fileInput" type="file" accept="image/*" multiple class="hidden"/>
      </div>

      <div class="mt-4">
        <div class="flex items-center justify-between">
          <p class="text-sm font-black">ì—…ë¡œë“œëœ ì´ë¯¸ì§€</p>
          <p id="countText" class="text-xs text-zinc-500">0/5</p>
        </div>
        <div id="preview" class="mt-3 grid grid-cols-3 gap-3"></div>
        <p class="text-[11px] text-zinc-500 mt-3">* ì²« ë²ˆì§¸ ì´ë¯¸ì§€ê°€ ì¹´ë“œ ì¸ë„¤ì¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
      </div>

      <button id="saveBtn" class="mt-6 w-full bg-[#a3e635] text-black py-4 rounded-xl font-black text-lg hover:bg-white transition">
        ì˜ìƒ ë“±ë¡í•˜ê¸°
      </button>

      <div id="msg" class="mt-3 text-sm font-bold text-zinc-400"></div>
    </div>

  </div>
</div>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");
const countText = document.getElementById("countText");
const msg = document.getElementById("msg");
const saveBtn = document.getElementById("saveBtn");

let uploadedFiles = [];

// ë“œë˜ê·¸ì•¤ë“œë¡­
dropzone.addEventListener("click", () => fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
dropzone.addEventListener("dragleave", e => { e.preventDefault(); dropzone.classList.remove("dragover"); });
dropzone.addEventListener("drop", e => {
  e.preventDefault();
  dropzone.classList.remove("dragover");
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener("change", e => handleFiles(e.target.files));

function handleFiles(files) {
  for (const f of files) {
    if (uploadedFiles.length >= 5) break;
    if (!f.type.startsWith("image/")) continue;
    uploadFile(f);
  }
}

async function uploadFile(file) {
  const fd = new FormData();
  fd.append("file", file);
  msg.textContent = "ì—…ë¡œë“œ ì¤‘...";
  
  try {
    const res = await fetch("/api/upload_public", { method: "POST", body: fd });
    const data = await res.json();
    if (data.ok) {
      uploadedFiles.push(data.filename);
      renderPreview();
      msg.textContent = "";
    } else {
      msg.textContent = "ì—…ë¡œë“œ ì‹¤íŒ¨: " + (data.error || "");
    }
  } catch (e) {
    msg.textContent = "ì—…ë¡œë“œ ì˜¤ë¥˜";
  }
}

function renderPreview() {
  preview.innerHTML = "";
  uploadedFiles.forEach((fn, i) => {
    const div = document.createElement("div");
    div.className = "relative aspect-[9/16] rounded-lg overflow-hidden border border-zinc-700 group";
    // ë³€ê²½ í›„
const imgUrl = fn.startsWith('http') || fn.startsWith('/r2/') ? fn : `/static/uploads/${fn}`;
div.innerHTML = `
  <img src="${imgUrl}" class="w-full h-full object-cover"/>
      ${i === 0 ? '<span class="absolute top-1 left-1 bg-[#a3e635] text-black text-[10px] font-black px-1.5 py-0.5 rounded">MAIN</span>' : ''}
      <button onclick="removeImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full text-xs font-bold opacity-0 group-hover:opacity-100 transition">Ã—</button>
    `;
    preview.appendChild(div);
  });
  countText.textContent = uploadedFiles.length + "/5";
}

function removeImg(i) {
  uploadedFiles.splice(i, 1);
  renderPreview();
}

// ì €ì¥
saveBtn.addEventListener("click", async () => {
  const title = document.getElementById("title").value.trim();
  const coupang = document.getElementById("coupang").value.trim();
  const link1 = document.getElementById("link1").value.trim();
  const link2 = document.getElementById("link2").value.trim();
  const link3 = document.getElementById("link3").value.trim();

  // í•„ìˆ˜ê°’ ê²€ì¦
  if (!title) {
    msg.textContent = "âŒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    msg.className = "mt-3 text-sm font-bold text-red-400";
    return;
  }
  if (uploadedFiles.length === 0) {
    msg.textContent = "âŒ í•˜ì´ë¼ì´íŠ¸ ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ 1ì¥ ì´ìƒ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.";
    msg.className = "mt-3 text-sm font-bold text-red-400";
    return;
  }
  if (!coupang) {
    msg.textContent = "âŒ ì¿ íŒ¡ ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
    msg.className = "mt-3 text-sm font-bold text-red-400";
    return;
  }

  const links = [link1, link2, link3].filter(x => x);

  const fd = new FormData();
  fd.append("title", title);
  fd.append("coupang_link", coupang);
  fd.append("images_json", JSON.stringify(uploadedFiles));
  fd.append("links_json", JSON.stringify(links));

  saveBtn.disabled = true;
  saveBtn.textContent = "ë“±ë¡ ì¤‘...";

  try {
    const res = await fetch("/seller/upload", { 
      method: "POST",
      body: fd
    });
    const data = await res.json();
    if (data.ok) {
      msg.textContent = "âœ… ë“±ë¡ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ê°¤ëŸ¬ë¦¬ì— ë…¸ì¶œë©ë‹ˆë‹¤.";
      msg.className = "mt-3 text-sm font-bold text-green-400";
      setTimeout(() => {
        window.location.href = "/seller/dashboard";
      }, 1500);
    } else {
      msg.textContent = "âŒ " + (data.error || "ë“±ë¡ ì‹¤íŒ¨");
      msg.className = "mt-3 text-sm font-bold text-red-400";
      saveBtn.disabled = false;
      saveBtn.textContent = "ì˜ìƒ ë“±ë¡í•˜ê¸°";
    }
  } catch (e) {
    msg.textContent = "âŒ ì„œë²„ ì˜¤ë¥˜";
    msg.className = "mt-3 text-sm font-bold text-red-400";
    saveBtn.disabled = false;
    saveBtn.textContent = "ì˜ìƒ ë“±ë¡í•˜ê¸°";
  }
});
</script>
{% endblock %}
