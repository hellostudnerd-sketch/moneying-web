{% extends "admin_base.html" %}
{% block title %}ê´€ë¦¬ì í™ˆ - MONEYING{% endblock %}

{% block page_title %}ê´€ë¦¬ì í™ˆ{% endblock %}
{% block page_desc %}MONEYING í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.{% endblock %}

{% block content_admin %}

<div class="space-y-6">

  <!-- ì˜¤ëŠ˜ì˜ í˜„í™© -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-white">ğŸ“Š ì˜¤ëŠ˜ì˜ í˜„í™©</h2>
      <span class="text-zinc-500 text-sm">{{ today.strftime('%Y-%m-%d') }}</span>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-zinc-800/50 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-[#c4ff00]">+{{ today_users }}</div>
        <div class="text-zinc-500 text-xs mt-1">ì‹ ê·œ ê°€ì…</div>
      </div>
      <div class="bg-zinc-800/50 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-blue-400">+{{ today_links }}</div>
        <div class="text-zinc-500 text-xs mt-1">ë§í¬ìš”ì²­</div>
      </div>
      <div class="bg-zinc-800/50 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-purple-400">{{ pending_sellers }}</div>
        <div class="text-zinc-500 text-xs mt-1">íŒë§¤ì ëŒ€ê¸°</div>
      </div>
      <div class="bg-zinc-800/50 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-green-400">{{ pending_rewards }}</div>
        <div class="text-zinc-500 text-xs mt-1">ìˆ˜ìµì¸ì¦ ëŒ€ê¸°</div>
      </div>
    </div>
  </div>

  <!-- ì²˜ë¦¬ í•„ìš” -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="px-5 py-3 border-b border-zinc-800">
      <h2 class="font-bold text-white">ğŸ”” ì²˜ë¦¬ í•„ìš”</h2>
    </div>
    
    <a href="/admin/link-requests" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ”—</span>
        <div>
          <div class="font-medium text-white text-sm">ë§í¬ìš”ì²­</div>
          <div class="text-zinc-500 text-xs">{{ pending_links }}ê±´ ëŒ€ê¸°ì¤‘</div>
        </div>
      </div>
      {% if pending_links > 0 %}
        <span class="px-2 py-1 bg-red-500/20 text-red-400 text-xs font-bold rounded-full">{{ pending_links }}</span>
      {% else %}
        <span class="text-zinc-600 text-xs">ì™„ë£Œ âœ“</span>
      {% endif %}
    </a>
    
    <a href="/admin/sellers" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸª</span>
        <div>
          <div class="font-medium text-white text-sm">íŒë§¤ì ì‹ ì²­</div>
          <div class="text-zinc-500 text-xs">{{ pending_sellers }}ê±´ ëŒ€ê¸°ì¤‘</div>
        </div>
      </div>
      {% if pending_sellers > 0 %}
        <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs font-bold rounded-full">{{ pending_sellers }}</span>
      {% else %}
        <span class="text-zinc-600 text-xs">ì™„ë£Œ âœ“</span>
      {% endif %}
    </a>
    
    <a href="/admin/pending-posts" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ“¸</span>
        <div>
          <div class="font-medium text-white text-sm">íŒë§¤ì ê²Œì‹œë¬¼</div>
          <div class="text-zinc-500 text-xs">{{ pending_posts }}ê±´ ìŠ¹ì¸ëŒ€ê¸°</div>
        </div>
      </div>
      {% if pending_posts > 0 %}
        <span class="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs font-bold rounded-full">{{ pending_posts }}</span>
      {% else %}
        <span class="text-zinc-600 text-xs">ì™„ë£Œ âœ“</span>
      {% endif %}
    </a>
    
    <a href="/admin/revenue-proofs" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ’¸</span>
        <div>
          <div class="font-medium text-white text-sm">ìˆ˜ìµì¸ì¦ ìŠ¹ì¸</div>
          <div class="text-zinc-500 text-xs">{{ pending_rewards }}ê±´ ëŒ€ê¸°ì¤‘</div>
        </div>
      </div>
      {% if pending_rewards > 0 %}
        <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded-full">{{ pending_rewards }}</span>
      {% else %}
        <span class="text-zinc-600 text-xs">ì™„ë£Œ âœ“</span>
      {% endif %}
    </a>
  </div>

  <!-- ì „ì²´ í†µê³„ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
    <h2 class="font-bold text-white mb-4">ğŸ“ˆ ì „ì²´ í†µê³„</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <a href="/admin/users" class="text-center group cursor-pointer">
        <div class="text-3xl font-black text-white group-hover:text-[#c4ff00] transition">{{ user_count }}</div>
        <div class="text-zinc-500 text-sm group-hover:text-zinc-300 transition">ê°€ì…ì</div>
      </a>
      <a href="/admin/subscriptions" class="text-center group cursor-pointer">
        <div class="text-3xl font-black text-[#c4ff00] group-hover:text-white transition">{{ subscriber_count }}</div>
        <div class="text-zinc-500 text-sm group-hover:text-zinc-300 transition">êµ¬ë…ì</div>
      </a>
      <a href="/admin/gallery" class="text-center group cursor-pointer">
        <div class="text-3xl font-black text-white group-hover:text-[#c4ff00] transition">{{ gallery_count }}</div>
        <div class="text-zinc-500 text-sm group-hover:text-zinc-300 transition">ê°¤ëŸ¬ë¦¬</div>
      </a>
      <a href="/admin/store" class="text-center group cursor-pointer">
        <div class="text-3xl font-black text-white group-hover:text-[#c4ff00] transition">{{ store_count }}</div>
        <div class="text-zinc-500 text-sm group-hover:text-zinc-300 transition">ìŠ¤í† ì–´</div>
      </a>
    </div>
  </div>



  <!-- ìµœê·¼ í™œë™ -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    
    <!-- ìµœê·¼ ê°¤ëŸ¬ë¦¬ -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b border-zinc-800">
        <div class="flex items-center gap-3">
          <h3 class="font-bold text-sm">ìµœê·¼ ê°¤ëŸ¬ë¦¬</h3>
          <button id="homeBulkDeleteBtn" onclick="homeBulkDelete()" class="hidden px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs font-bold hover:bg-red-500/30 transition">
            <span id="homeSelectedCount">0</span>ê°œ ì‚­ì œ
          </button>
        </div>
        <a href="/admin/gallery" class="text-[#c4ff00] text-xs hover:underline">ì „ì²´ ë³´ê¸° â†’</a>
      </div>
      <div class="divide-y divide-zinc-800/50">
        {% for post in recent_posts %}
        <div class="px-5 py-3 flex items-center justify-between home-post-row" data-id="{{ post.id }}">
          <div class="flex items-center gap-3 min-w-0">
            <input type="checkbox" class="home-post-checkbox w-4 h-4 rounded accent-[#c4ff00]" value="{{ post.id }}" onchange="updateHomeSelectedCount()">
            {% if post.thumbnail_url %}
            <img src="{{ post.thumbnail_url }}" class="w-10 h-10 rounded-lg object-cover shrink-0">
            {% else %}
            <div class="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center shrink-0">ğŸ¬</div>
            {% endif %}
            <div class="min-w-0">
              <div class="text-white text-sm font-medium truncate">{{ post.title }}</div>
              <div class="text-zinc-500 text-xs">{{ post.category }}</div>
            </div>
          </div>
          <a href="/admin/posts/{{ post.id }}/edit" class="text-zinc-500 hover:text-[#c4ff00] text-xs shrink-0">ìˆ˜ì •</a>
        </div>
        {% endfor %}
        {% if not recent_posts %}
        <div class="px-5 py-6 text-center text-zinc-500 text-sm">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
        {% endif %}
      </div>
    </div>

    <!-- ìµœê·¼ ë§í¬ìš”ì²­ -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b border-zinc-800">
        <h3 class="font-bold text-sm">ìµœê·¼ ë§í¬ìš”ì²­</h3>
        <a href="/admin/link-requests" class="text-[#c4ff00] text-xs hover:underline">ì „ì²´ ë³´ê¸° â†’</a>
      </div>
      <div class="divide-y divide-zinc-800/50">
        {% for lr in recent_link_requests %}
        <div class="px-5 py-3 flex items-center justify-between">
          <div class="min-w-0">
            <div class="text-white text-sm truncate">{{ lr.requester_email }}</div>
            <div class="text-zinc-500 text-xs truncate">{{ lr.original_url[:40] }}...</div>
          </div>
          {% if lr.coupang_url %}
            <span class="text-green-400 text-xs shrink-0">ì™„ë£Œ âœ“</span>
          {% else %}
            <span class="text-yellow-400 text-xs shrink-0">ëŒ€ê¸°ì¤‘</span>
          {% endif %}
        </div>
        {% endfor %}
        {% if not recent_link_requests %}
        <div class="px-5 py-6 text-center text-zinc-500 text-sm">ë§í¬ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>
        {% endif %}
      </div>
    </div>

  </div>

</div>

<!-- ì¼ê´„ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="homeBulkDeleteModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4 text-center">
    <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
    <h3 class="text-xl font-black text-white mb-2">ì¼ê´„ ì‚­ì œ</h3>
    <p class="text-zinc-400 mb-6"><span id="homeDeleteCountText">0</span>ê°œì˜ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="flex gap-3">
      <button onclick="closeHomeBulkDeleteModal()" class="flex-1 py-3 rounded-xl font-bold bg-zinc-800 text-white hover:bg-zinc-700 transition">ì·¨ì†Œ</button>
      <button onclick="confirmHomeBulkDelete()" class="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-400 transition">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="homeResultModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4 text-center">
    <div id="homeResultIcon" class="text-5xl mb-4">âœ…</div>
    <h3 id="homeResultTitle" class="text-xl font-black text-white mb-2">ì‚­ì œ ì™„ë£Œ</h3>
    <p id="homeResultMessage" class="text-zinc-400 mb-6"></p>
    <button onclick="closeHomeResultModal()" class="w-full py-3 rounded-xl font-bold bg-[#c4ff00] text-black hover:bg-white transition">í™•ì¸</button>
  </div>
</div>

<script>
function updateHomeSelectedCount() {
  const checkboxes = document.querySelectorAll('.home-post-checkbox:checked');
  const count = checkboxes.length;
  const btn = document.getElementById('homeBulkDeleteBtn');
  const countSpan = document.getElementById('homeSelectedCount');
  
  if (count > 0) {
    btn.classList.remove('hidden');
    countSpan.textContent = count;
  } else {
    btn.classList.add('hidden');
  }
}

function homeBulkDelete() {
  const checkboxes = document.querySelectorAll('.home-post-checkbox:checked');
  document.getElementById('homeDeleteCountText').textContent = checkboxes.length;
  document.getElementById('homeBulkDeleteModal').classList.remove('hidden');
  document.getElementById('homeBulkDeleteModal').classList.add('flex');
}

function closeHomeBulkDeleteModal() {
  document.getElementById('homeBulkDeleteModal').classList.add('hidden');
  document.getElementById('homeBulkDeleteModal').classList.remove('flex');
}

async function confirmHomeBulkDelete() {
  const checkboxes = document.querySelectorAll('.home-post-checkbox:checked');
  const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
  
  closeHomeBulkDeleteModal();
  
  try {
    const res = await fetch('/admin/gallery/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids })
    });
    const data = await res.json();
    
    if (data.ok) {
      showHomeResult('success', 'ì‚­ì œ ì™„ë£Œ', `${data.count}ê°œì˜ ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      ids.forEach(id => {
        const row = document.querySelector(`.home-post-row[data-id="${id}"]`);
        if (row) row.remove();
      });
      updateHomeSelectedCount();
    } else {
      showHomeResult('error', 'ì‚­ì œ ì‹¤íŒ¨', data.error);
    }
  } catch (err) {
    showHomeResult('error', 'ì˜¤ë¥˜ ë°œìƒ', err.message);
  }
}

function showHomeResult(type, title, message) {
  document.getElementById('homeResultIcon').textContent = type === 'success' ? 'âœ…' : 'âŒ';
  document.getElementById('homeResultTitle').textContent = title;
  document.getElementById('homeResultMessage').textContent = message;
  document.getElementById('homeResultModal').classList.remove('hidden');
  document.getElementById('homeResultModal').classList.add('flex');
}

function closeHomeResultModal() {
  document.getElementById('homeResultModal').classList.add('hidden');
  document.getElementById('homeResultModal').classList.remove('flex');
}
</script>

{% endblock %}