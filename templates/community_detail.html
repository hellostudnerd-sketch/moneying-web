{% extends "base.html" %}
{% block title %}{{ post.title }} - ì»¤ë®¤ë‹ˆí‹°{% endblock %}

{% block content %}

<div class="max-w-3xl mx-auto">

  <div class="mb-6"><a href="/community" class="text-zinc-500 hover:text-white transition">â† ëª©ë¡ìœ¼ë¡œ</a></div>

  <article class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 md:p-8">
    
    <div class="flex items-center gap-2 mb-4">
      <span class="text-xs bg-zinc-800 text-gray-200 px-2 py-1 rounded border border-zinc-700 font-bold">
        {% if post.category == 'notice' %}ğŸ“¢ ê³µì§€{% elif post.category == 'deal' %}ğŸ›ï¸ ê³µêµ¬{% elif post.category == 'revenue' %}ğŸ’¸ ìˆ˜ìµ{% elif post.category == 'tips' %}ğŸ’¡ ê¿€íŒ{% elif post.category == 'qna' %}â“ ì§ˆë¬¸{% else %}ğŸ—£ ììœ {% endif %}
      </span>
      {% if post.category == 'deal' and post.deal_subscribers_only %}
        <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded border border-purple-500/30 font-bold">ğŸ‘‘ êµ¬ë…ì ì „ìš©</span>
      {% endif %}
    </div>

    <h1 class="text-2xl md:text-3xl font-black mb-4">{{ post.title }}</h1>

    <div class="flex items-center justify-between text-sm text-zinc-500 mb-6 pb-6 border-b border-zinc-800">
      <span>{{ get_nickname(post.author_email) }}</span>
      <span>{{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
    </div>

    <div class="prose prose-invert max-w-none mb-6">
      <p class="whitespace-pre-wrap text-zinc-300 leading-relaxed">{{ post.content }}</p>
    </div>

    {% if post.images() and post.images()|length > 0 %}
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
        {% for img in post.images() %}<a href="{{ img }}" target="_blank"><img src="{{ img }}" class="rounded-lg border border-zinc-700 hover:border-zinc-500 transition w-full aspect-square object-cover"></a>{% endfor %}
      </div>
    {% endif %}

    <!-- ê³µêµ¬/í˜‘ì°¬ ì‹ ì²­ ì„¹ì…˜ -->
    {% if post.category == 'deal' %}
      <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-5 mb-6">
        
        <!-- ê³µêµ¬/í˜‘ì°¬ ì •ë³´ -->
        <div class="flex items-center gap-2 mb-4">
          <span class="text-xl">ğŸ›ï¸</span>
          <span class="font-bold text-purple-400">ê³µêµ¬/í˜‘ì°¬ ì •ë³´</span>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 text-sm">
          <div>
            <div class="text-zinc-500">ë§ˆê°ì¼</div>
            <div class="text-white font-bold">
              {% if post.deal_deadline %}
                {{ post.deal_deadline.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                ìˆ˜ë™ ë§ˆê°
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-zinc-500">ëª¨ì§‘ ì¸ì›</div>
            <div class="text-white font-bold">
              {% if post.deal_max_people %}
                {{ deal_apply_count }}/{{ post.deal_max_people }}ëª…
              {% else %}
                ì œí•œ ì—†ìŒ
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-zinc-500">ìƒíƒœ</div>
            <div class="font-bold {% if post.is_deal_available %}text-green-400{% else %}text-red-400{% endif %}">
              {% if post.deal_closed %}
                ë§ˆê°ë¨
              {% elif post.deal_deadline and post.deal_deadline < now %}
                ê¸°ê°„ ë§Œë£Œ
              {% elif post.deal_max_people and deal_apply_count >= post.deal_max_people %}
                ì¸ì› ë§ˆê°
              {% else %}
                ì‹ ì²­ ê°€ëŠ¥
              {% endif %}
            </div>
          </div>
        </div>

        <div class="border-t border-purple-500/20 pt-4">
          
          <!-- ì´ë¯¸ ì‹ ì²­í•œ ê²½ìš° -->
          {% if user_applied %}
            <div class="text-center py-4">
              <div class="text-2xl mb-2">âœ…</div>
              <div class="text-green-400 font-bold">ì‹ ì²­ ì™„ë£Œ!</div>
              <div class="text-zinc-400 text-sm mt-1">íŒë§¤ìê°€ í™•ì¸ í›„ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</div>
            </div>
          
          <!-- ë§ˆê°ëœ ê²½ìš° -->
          {% elif not post.is_deal_available %}
            <div class="text-center py-4">
              <div class="text-2xl mb-2">â°</div>
              <div class="text-red-400 font-bold">ì‹ ì²­ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤</div>
            </div>
          
          <!-- ë¹„ë¡œê·¸ì¸ -->
          {% elif not session.get('user_id') %}
            <div class="text-center py-4">
              <div class="text-zinc-400 mb-3">ì‹ ì²­í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
              <a href="/login?next=/community/{{ post.id }}" class="inline-block bg-[#c4ff00] text-black font-bold px-6 py-3 rounded-xl hover:bg-white transition">ë¡œê·¸ì¸í•˜ê¸°</a>
            </div>
          
          <!-- êµ¬ë…ì ì „ìš©ì¸ë° ë¹„êµ¬ë…ì -->
          {% elif post.deal_subscribers_only and not session.get('subscriber') and not session.get('is_trial') and not session.get('admin') %}
            <div class="text-center py-4">
              <div class="text-2xl mb-2">ğŸ‘‘</div>
              <div class="text-purple-400 font-bold mb-2">êµ¬ë…ì ì „ìš© ê³µêµ¬/í˜‘ì°¬</div>
              <div class="text-zinc-400 text-sm mb-4">ì´ ê³µêµ¬/í˜‘ì°¬ì€ êµ¬ë…ìë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
              <a href="/pricing" class="inline-block bg-[#c4ff00] text-black font-bold px-6 py-3 rounded-xl hover:bg-white transition">êµ¬ë…í•˜ê¸°</a>
            </div>
          
          <!-- ì‹ ì²­ í¼ -->
          {% else %}
            <form id="dealApplyForm" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold text-zinc-400 mb-1">ì´ë¦„ *</label>
                  <input type="text" name="name" required class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none" placeholder="ì‹¤ëª… ì…ë ¥">
                </div>
                <div>
                  <label class="block text-sm font-bold text-zinc-400 mb-1">ì—°ë½ì²˜ *</label>
                  <input type="tel" name="phone" required class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none" placeholder="010-0000-0000">
                </div>
              </div>
              <div>
                <label class="block text-sm font-bold text-zinc-400 mb-1">ì´ë©”ì¼ *</label>
                <input type="email" name="email" required class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" value="{{ session.get('user_email', '') }}">
              </div>
              <div>
                <label class="block text-sm font-bold text-zinc-400 mb-1">SNS ê³„ì • (ì„ íƒ)</label>
                <input type="url" name="sns_url" class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none" placeholder="https://instagram.com/...">
              </div>
              <div>
                <label class="block text-sm font-bold text-zinc-400 mb-1">ë©”ì‹œì§€ (ì„ íƒ)</label>
                <textarea name="message" rows="2" class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none resize-none" placeholder="íŒë§¤ìì—ê²Œ ì „í•  ë©”ì‹œì§€"></textarea>
              </div>
              <button type="submit" id="dealApplyBtn" class="w-full py-3 bg-purple-500 hover:bg-purple-400 text-white font-bold rounded-xl transition">
                ì‹ ì²­í•˜ê¸°
              </button>
            </form>
          {% endif %}
          
        </div>
      </div>
    {% endif %}

    <!-- ìˆ˜ìµ ì¸ì¦ ë¦¬ì›Œë“œ ì„¹ì…˜ -->
    {% if post.category == 'revenue' and post.author_email == session.get('user_email') %}
      <div id="revenueProofSection" class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 mb-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-bold text-green-400 mb-1">ğŸ’¸ ìˆ˜ìµ ì¸ì¦ ë¦¬ì›Œë“œ</div>
            <p class="text-zinc-400 text-sm">ìŠ¹ì¸ë˜ë©´ 7ì¼ êµ¬ë… ì—°ì¥!</p>
          </div>
          {% if session.get('subscriber') or session.get('admin') %}
            {% if post.reward_requested %}
              <span class="px-4 py-2 bg-zinc-700 text-zinc-400 font-bold rounded-lg">âœ“ ì‹ ì²­ ì™„ë£Œ</span>
            {% else %}
              <button id="applyRewardBtn" onclick="applyRevenueProof({{ post.id }})" class="px-4 py-2 bg-green-500 hover:bg-green-400 text-black font-bold rounded-lg transition">ë¦¬ì›Œë“œ ì‹ ì²­</button>
            {% endif %}
          {% else %}
            <button onclick="showSubscribeModal()" class="px-4 py-2 bg-green-500 hover:bg-green-400 text-black font-bold rounded-lg transition">ë¦¬ì›Œë“œ ì‹ ì²­</button>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <div class="flex items-center justify-between pt-6 border-t border-zinc-800">
      <button id="likeBtn" onclick="toggleLike()" class="flex items-center gap-2 px-4 py-2 rounded-lg transition {% if user_liked %}bg-red-500/20 text-red-400 border border-red-500/30{% else %}bg-zinc-800 text-zinc-400 hover:text-red-400 border border-zinc-700{% endif %}">
          <i class="fas fa-heart"></i><span id="likeCount">{{ like_count }}</span>
      </button>
      {% if post.author_email == session.get('user_email') or session.get('admin') %}
  <div class="flex items-center gap-3">
    <a href="/community/{{ post.id }}/edit" class="text-zinc-500 hover:text-[#c4ff00] text-sm transition">ìˆ˜ì •</a>
    <form method="POST" action="/community/{{ post.id }}/delete" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" class="inline"><button type="submit" class="text-zinc-600 hover:text-red-500 text-sm transition">ì‚­ì œ</button></form>
    {% if post.category == 'deal' and post.is_deal_available %}<button onclick="closeDeal()" class="text-zinc-500 hover:text-red-400 text-sm transition">ë§ˆê°í•˜ê¸°</button>{% endif %}
  </div>
{% endif %}
    </div>

  </article>

  <section class="mt-8">
    <h3 class="text-lg font-bold mb-4">ğŸ’¬ ëŒ“ê¸€ {{ comments|length }}ê°œ</h3>

    {% if session.get('user_id') %}
      <form method="POST" action="/community/{{ post.id }}/comment" class="mb-6">
        <div class="flex gap-3">
          <input type="text" name="content" required placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-[#a3e635] focus:outline-none">
          <button type="submit" class="px-6 bg-[#a3e635] text-black font-bold rounded-lg hover:bg-white transition">ë“±ë¡</button>
        </div>
      </form>
    {% else %}
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-lg p-4 mb-6 text-center">
        <a href="/login?next=/community/{{ post.id }}" class="text-[#a3e635] font-bold hover:underline">ë¡œê·¸ì¸</a>í•˜ê³  ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
      </div>
    {% endif %}

    <div class="space-y-4">
      {% for c in comments %}
        <div class="bg-zinc-900/40 border border-zinc-800/50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-bold text-zinc-300">{{ get_nickname(c.author_email) }}</span>
            <div class="flex items-center gap-3">
              <span class="text-xs text-zinc-600">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
              {% if c.author_email == session.get('user_email') or session.get('admin') %}
                <form method="POST" action="/community/comment/{{ c.id }}/delete" class="inline"><button type="submit" class="text-zinc-600 hover:text-red-500 text-xs">ì‚­ì œ</button></form>
              {% endif %}
            </div>
          </div>
          <p class="text-zinc-400 text-sm">{{ c.content }}</p>
        </div>
      {% endfor %}
      {% if comments|length == 0 %}<div class="text-center text-zinc-600 py-8">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>{% endif %}
    </div>
  </section>

</div>

<!-- êµ¬ë… í•„ìš” ëª¨ë‹¬ -->
<div id="subscribeModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4 text-center">
    <div class="text-4xl mb-4">ğŸ‘‘</div>
    <h3 class="text-xl font-black text-white mb-2">êµ¬ë…ì ì „ìš© ê¸°ëŠ¥</h3>
    <p class="text-zinc-400 text-sm mb-6">ìˆ˜ìµ ì¸ì¦ ë¦¬ì›Œë“œëŠ” êµ¬ë…ìë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="flex gap-3">
      <button onclick="closeSubscribeModal()" class="flex-1 py-3 rounded-xl font-bold border border-zinc-600 text-white hover:bg-zinc-800 transition">ë‹«ê¸°</button>
      <a href="/pricing" class="flex-1 py-3 rounded-xl font-bold bg-[#c4ff00] text-black hover:bg-white transition text-center">êµ¬ë…í•˜ê¸°</a>
    </div>
  </div>
</div>

<script>
function showSubscribeModal() {
  document.getElementById('subscribeModal').classList.remove('hidden');
  document.getElementById('subscribeModal').classList.add('flex');
}

function closeSubscribeModal() {
  document.getElementById('subscribeModal').classList.add('hidden');
  document.getElementById('subscribeModal').classList.remove('flex');
}

async function applyRevenueProof(postId) {
  const btn = document.getElementById('applyRewardBtn');
  btn.disabled = true; btn.textContent = 'ì‹ ì²­ ì¤‘...';
  try {
    const res = await fetch(`/revenue-proof/apply/${postId}`, { method: 'POST' });
    const data = await res.json();
    if (res.ok && data.ok) {
      btn.textContent = 'âœ“ ì‹ ì²­ ì™„ë£Œ';
      btn.classList.remove('bg-green-500', 'hover:bg-green-400');
      btn.classList.add('bg-zinc-700', 'text-zinc-400', 'cursor-not-allowed');
      showAlert('ì‹ ì²­ ì™„ë£Œ! ğŸ‰', 'ê´€ë¦¬ì ìŠ¹ì¸ í›„ 7ì¼ì´ ì—°ì¥ë©ë‹ˆë‹¤.', 'âœ…');
    } else if (res.status === 403) {
      showSubscribeModal();
      btn.disabled = false; btn.textContent = 'ë¦¬ì›Œë“œ ì‹ ì²­';
    } else {
      alert(data.error || 'ì‹ ì²­ ì‹¤íŒ¨');
      btn.disabled = false; btn.textContent = 'ë¦¬ì›Œë“œ ì‹ ì²­';
    }
  } catch (e) { 
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
    btn.disabled = false; btn.textContent = 'ë¦¬ì›Œë“œ ì‹ ì²­'; 
  }
}

// ê³µêµ¬/í˜‘ì°¬ ì‹ ì²­
const dealForm = document.getElementById('dealApplyForm');
if (dealForm) {
  dealForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('dealApplyBtn');
    btn.disabled = true;
    btn.textContent = 'ì‹ ì²­ ì¤‘...';
    
    const formData = new FormData(this);
    
    try {
      const res = await fetch('/community/{{ post.id }}/apply', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      
      if (data.ok) {
        showAlert('ì‹ ì²­ ì™„ë£Œ! ğŸ‰', 'íŒë§¤ìê°€ í™•ì¸ í›„ ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.', 'âœ…');
        setTimeout(() => location.reload(), 2000);
      } else {
  if (data.error === 'already_applied') {
    showAlert('ì•Œë¦¼', 'ì´ë¯¸ ì‹ ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.', 'âš ï¸');
  } else if (data.error === 'subscribers_only') {
    showAlert('êµ¬ë…ì ì „ìš©', 'êµ¬ë…ìë§Œ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'ğŸ‘‘');
  } else if (data.error === 'closed') {
    showAlert('ë§ˆê°', 'ì‹ ì²­ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'â°');
  } else {
    showAlert('ì˜¤ë¥˜', 'ì‹ ì²­ ì‹¤íŒ¨: ' + data.error, 'âŒ');
  }
        btn.disabled = false;
        btn.textContent = 'ì‹ ì²­í•˜ê¸°';
      }
    } catch (e) {
      alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      btn.disabled = false;
      btn.textContent = 'ì‹ ì²­í•˜ê¸°';
    }
  });
}
</script>



<script>

let liked = {{ 'true' if user_liked else 'false' }};

function toggleLike() {

  fetch('/community/{{ post.id }}/like', {method:'POST'})

    .then(r => r.json())

    .then(data => {

      liked = data.liked;

      const btn = document.getElementById('likeBtn');

      document.getElementById('likeCount').textContent = data.count;

      if (liked) {

        btn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition bg-red-500/20 text-red-400 border border-red-500/30';

      } else {

        btn.className = 'flex items-center gap-2 px-4 py-2 rounded-lg transition bg-zinc-800 text-zinc-400 hover:text-red-400 border border-zinc-700';

      }

    });

}

function closeDeal() {
  if (!confirm("ì´ ê³µêµ¬/í˜‘ì°¬ì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë” ì´ìƒ ì‹ ì²­ì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
  fetch("/my/deals/{{ post.id }}/close", { method: "POST" })
    .then(r => r.json())
    .then(data => {
      if (data.ok) { alert("ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
      else { alert("ì˜¤ë¥˜: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")); }
    });
}
</script>

{% endblock %}
