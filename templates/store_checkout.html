
{% extends "base.html" %}

{% block title %}결제 - {{ product.title }} - MONEYING{% endblock %}

{% block content %}

<div class="max-w-lg mx-auto px-4 pt-24 pb-20">

  <div class="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-6 md:p-8">

    <h1 class="text-2xl font-black mb-6">결제하기</h1>

    <div class="bg-zinc-800/50 rounded-xl p-4 mb-6">

      <div class="flex justify-between items-center mb-2">

        <span class="text-zinc-400">상품</span>

        <span class="font-bold text-white">{{ product.title }}</span>

      </div>

      <div class="border-t border-zinc-700 my-3"></div>

      <div class="flex justify-between items-center">

        <span class="text-zinc-400">결제 금액</span>

        <span class="text-2xl font-black text-[#c4ff00]">{{ "{:,}".format(product.price) }}원</span>

      </div>

    </div>

    <div id="payment-widget"></div>

    <div id="agreement-widget" class="mt-4"></div>

    <button id="payBtn" onclick="doPayment()" class="w-full py-4 rounded-xl font-black bg-[#c4ff00] text-black hover:bg-white transition text-lg mt-6">

      결제하기

    </button>

    <a href="/store/{{ product.id }}" class="block text-center text-zinc-500 hover:text-white text-sm mt-4 transition">돌아가기</a>

  </div>

</div>

<script src="https://js.tosspayments.com/v2/standard"></script>

<script>

const tossPayments = TossPayments("{{ client_key }}");

async function main() {

  const widgets = tossPayments.widgets({customerKey: "{{ customer_key }}"});

  await widgets.setAmount({currency: "KRW", value: {{ product.price }}});

  await widgets.renderPaymentMethods({selector: "#payment-widget", variantKey: "DEFAULT"});

  await widgets.renderAgreement({selector: "#agreement-widget", variantKey: "AGREEMENT"});

  window._widgets = widgets;

}

main();

async function doPayment() {

  const btn = document.getElementById('payBtn');

  btn.disabled = true;

  btn.textContent = '처리 중...';

  try {

    await window._widgets.requestPayment({

      orderId: "store_{{ product.id }}_" + Date.now(),

      orderName: "{{ product.title }}",

      successUrl: window.location.origin + "/store/payment/success?productId={{ product.id }}",

      failUrl: window.location.origin + "/store/payment/fail",

      customerEmail: "{{ session.get('user_email', '') }}",

    });

  } catch(e) {

    btn.disabled = false;

    btn.textContent = '결제하기';

    if (e.code !== 'USER_CANCEL') alert(e.message || '결제 요청 중 오류가 발생했습니다.');

  }

}

</script>

{% endblock %}

