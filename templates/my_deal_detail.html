{% extends "base.html" %}
{% block title %}ì‹ ì²­ì ê´€ë¦¬ - MONEYING{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">

  <div class="mb-8">
    <a href="javascript:history.back()" class="text-zinc-500 hover:text-white transition text-sm">â† ë’¤ë¡œê°€ê¸°</a>
    
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mt-4">
      <div>
        <div class="flex items-center gap-2 mb-2">
          {% if post.deal_closed %}
            <span class="px-2 py-1 rounded text-xs font-bold bg-zinc-700 text-zinc-400">ë§ˆê°</span>
          {% else %}
            <span class="px-2 py-1 rounded text-xs font-bold bg-green-500/20 text-green-400">ì§„í–‰ì¤‘</span>
          {% endif %}
        </div>
        <h1 class="text-2xl md:text-3xl font-black">{{ post.title }}</h1>
      </div>
      
      {% if not post.deal_closed %}
      <button onclick="closeDeal()" class="px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/30 font-bold rounded-lg hover:bg-red-500/30 transition text-sm">
        ë§ˆê°í•˜ê¸°
      </button>
      {% endif %}
    </div>
    
    <!-- í†µê³„ -->
    <div class="grid grid-cols-3 gap-4 mt-6">
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-white">{{ applications|length }}</div>
        <div class="text-xs text-zinc-500">ì´ ì‹ ì²­</div>
      </div>
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-green-400">{{ applications|selectattr('status', 'equalto', 'approved')|list|length }}</div>
        <div class="text-xs text-zinc-500">ìŠ¹ì¸</div>
      </div>
      <div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 text-center">
        <div class="text-2xl font-black text-yellow-400">{{ applications|selectattr('status', 'equalto', 'pending')|list|length }}</div>
        <div class="text-xs text-zinc-500">ëŒ€ê¸°</div>
      </div>
    </div>
  </div>

  <!-- ì‹ ì²­ì ëª©ë¡ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="px-5 py-4 border-b border-zinc-800">
      <h2 class="font-bold">ì‹ ì²­ì ëª©ë¡</h2>
    </div>
    
    {% if applications|length == 0 %}
    <div class="p-10 text-center">
      <div class="text-4xl mb-4">ğŸ“‹</div>
      <div class="text-zinc-500 font-bold">ì•„ì§ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
    {% else %}
    <div class="divide-y divide-zinc-800/70">
      {% for app in applications %}
      <div class="p-5 hover:bg-zinc-800/30 transition" id="app-{{ app.id }}">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-2">
              {% if app.status == 'approved' %}
                <span class="px-2 py-1 rounded text-xs font-bold bg-green-500/20 text-green-400">ìŠ¹ì¸ë¨</span>
              {% elif app.status == 'rejected' %}
                <span class="px-2 py-1 rounded text-xs font-bold bg-red-500/20 text-red-400">ê±°ì ˆë¨</span>
              {% else %}
                <span class="px-2 py-1 rounded text-xs font-bold bg-yellow-500/20 text-yellow-400">ëŒ€ê¸°ì¤‘</span>
              {% endif %}
              <span class="text-xs text-zinc-500">{{ app.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div>
                <div class="text-zinc-500 text-xs">ì´ë¦„</div>
                <div class="text-white font-bold">{{ app.name }}</div>
              </div>
              <div>
                <div class="text-zinc-500 text-xs">ì—°ë½ì²˜</div>
                <div class="text-white">{{ app.phone }}</div>
              </div>
              <div>
                <div class="text-zinc-500 text-xs">ì´ë©”ì¼</div>
                <div class="text-white truncate">{{ app.user_email }}</div>
              </div>
              {% if app.sns_url %}
              <div>
                <div class="text-zinc-500 text-xs">SNS</div>
                <a href="{{ app.sns_url }}" target="_blank" class="text-[#c4ff00] hover:underline truncate block">{{ app.sns_url[:30] }}...</a>
              </div>
              {% endif %}
            </div>
            
            {% if app.message %}
            <div class="mt-3 p-3 bg-zinc-800/50 rounded-lg">
              <div class="text-zinc-500 text-xs mb-1">ë©”ì‹œì§€</div>
              <div class="text-zinc-300 text-sm">{{ app.message }}</div>
            </div>
            {% endif %}
          </div>
          
          {% if app.status == 'pending' %}
          <div class="flex gap-2 shrink-0">
            <button onclick="approveApp({{ app.id }})" class="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-bold">ìŠ¹ì¸</button>
            <button onclick="rejectApp({{ app.id }})" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-bold">ê±°ì ˆ</button>
          </div>
          {% endif %}
          
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

</div>

<!-- í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4 text-center">
    <div id="modalIcon" class="text-5xl mb-4">âœ…</div>
    <h3 id="modalTitle" class="text-xl font-black text-white mb-2">ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
    <p id="modalDesc" class="text-zinc-400 text-sm mb-6"></p>
    <div class="flex gap-3">
      <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-bold border border-zinc-600 text-white hover:bg-zinc-800 transition">ì·¨ì†Œ</button>
      <button id="modalConfirmBtn" onclick="confirmAction()" class="flex-1 py-3 rounded-xl font-bold bg-green-500 text-black hover:bg-green-400 transition">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
let currentAction = '';
let currentAppId = null;

function approveApp(appId) {
  currentAction = 'approve';
  currentAppId = appId;
  showModal('ìŠ¹ì¸', 'ì´ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'green');
}

function rejectApp(appId) {
  currentAction = 'reject';
  currentAppId = appId;
  showModal('ê±°ì ˆ', 'ì´ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'red');
}

function closeDeal() {
  currentAction = 'close';
  showModal('ë§ˆê°', 'ì´ ê³µêµ¬/í˜‘ì°¬ì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë” ì´ìƒ ì‹ ì²­ì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'red');
}

function showModal(title, desc, color) {
  document.getElementById('modalIcon').textContent = color === 'green' ? 'âœ…' : 'âŒ';
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalDesc').textContent = desc;
  
  const btn = document.getElementById('modalConfirmBtn');
  btn.className = color === 'green' 
    ? 'flex-1 py-3 rounded-xl font-bold bg-green-500 text-black hover:bg-green-400 transition'
    : 'flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-400 transition';
  
  document.getElementById('confirmModal').classList.remove('hidden');
  document.getElementById('confirmModal').classList.add('flex');
}

function closeModal() {
  document.getElementById('confirmModal').classList.add('hidden');
  document.getElementById('confirmModal').classList.remove('flex');
  currentAction = '';
  currentAppId = null;
}

function confirmAction() {
  let url = '';
  
  if (currentAction === 'approve') {
    url = `/my/deals/{{ post.id }}/approve/${currentAppId}`;
  } else if (currentAction === 'reject') {
    url = `/my/deals/{{ post.id }}/reject/${currentAppId}`;
  } else if (currentAction === 'close') {
    url = `/my/deals/{{ post.id }}/close`;
  }
  
  fetch(url, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        location.reload();
      } else {
        alert('ì˜¤ë¥˜: ' + (data.error || 'unknown'));
      }
    });
}

// ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ì‹œ ë‹«ê¸°
document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>

{% endblock %}