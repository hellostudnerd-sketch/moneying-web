{% extends "base.html" %}
{% block title %}ë§í¬ìš”ì²­ í•˜ê¸° - MONEYING{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">

  <!-- í—¤ë” -->

  <a href="/link-requests" class="text-zinc-500 hover:text-white transition text-sm mb-4 inline-block">â† ë’¤ë¡œê°€ê¸°</a>

  <h1 class="text-2xl font-black mb-1">ë§í¬ìš”ì²­ í•˜ê¸°</h1>

  <p class="text-zinc-400 text-sm mb-6">ì˜¤í”ˆë°© ì¸ì¦ í›„ ì›ë³¸ ë§í¬ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for msg in messages %}
        <div class="bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl mb-4 text-sm">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  </div>

  <!-- ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰ í‘œì‹œ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 mb-6 max-w-4xl mx-auto">
    <div class="flex items-center justify-between mb-2">
      <span class="text-sm font-bold text-zinc-400">ì´ë²ˆ ë‹¬ ìš”ì²­</span>
      <span class="font-black 
        {% if (monthly_used or 0) >= (monthly_limit or 3) %}text-red-400{% else %}text-white{% endif %}">
        {{ monthly_used or 0 }} / {{ monthly_limit or 3 }}íšŒ
      </span>
    </div>
    <div class="w-full bg-zinc-800 rounded-full h-2 overflow-hidden">
      {% set percent = ((monthly_used or 0) / (monthly_limit or 3) * 100)|int %}
      <div class="h-full rounded-full 
        {% if percent >= 100 %}bg-red-500{% elif percent >= 70 %}bg-yellow-500{% else %}bg-[#a3e635]{% endif %}"
        style="width: {{ percent if percent <= 100 else 100 }}%">
      </div>
    </div>
  </div>

{% if (monthly_used or 0) >= (monthly_limit or 3) %}
    <!-- í•œë„ ì´ˆê³¼ -->
    <div class="bg-red-500/10 border border-red-500/30 rounded-2xl p-8 text-center max-w-4xl mx-auto">
      <div class="text-4xl mb-4">âš </div>
      {% if session.get("is_trial") %}
      <h2 class="text-xl font-black text-red-400 mb-2">ë§í¬ìš”ì²­ í•œë„ ì´ˆê³¼</h2>
      <p class="text-zinc-400 mb-6">
        ë¬´ë£Œì²´í—˜ ê¸°ê°„ ì¤‘ ë§í¬ìš”ì²­ 3íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”.<br>
        êµ¬ë…í•˜ì‹œë©´ ì›” 10~20íšŒê¹Œì§€ ìš”ì²­í•  ìˆ˜ ìˆì–´ìš”!
      </p>
      {% else %}
      <h2 class="text-xl font-black text-red-400 mb-2">ì´ë²ˆ ë‹¬ í•œë„ ì´ˆê³¼</h2>
      <p class="text-zinc-400 mb-6">
        ì´ë²ˆ ë‹¬ ë§í¬ìš”ì²­ í•œë„({{ monthly_limit }}íšŒ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”.<br>
        ë‹¤ìŒ ë‹¬ 1ì¼ì— ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
      </p>
      {% endif %}
      
      {% if not (session.get("subscriber") or session.get("is_trial")) %}
        <div class="bg-zinc-800/50 rounded-xl p-4 mb-6">
          <p class="text-sm text-zinc-400">
            ğŸ’¡ <strong class="text-[#a3e635]">êµ¬ë…í•˜ë©´ ì›” 10íšŒ</strong>ê¹Œì§€ ìš”ì²­í•  ìˆ˜ ìˆì–´ìš”!
          </p>
        </div>
        <a href="/pricing" class="inline-block bg-[#a3e635] text-black font-black px-6 py-3 rounded-lg hover:bg-white transition">
          ìš”ê¸ˆì œ ë³´ê¸° â†’
        </a>
      {% endif %}
      
      <a href="/link-requests" class="block mt-4 text-zinc-500 hover:text-white text-sm">
        â† ë’¤ë¡œê°€ê¸°
      </a>
    </div>
    
  {% else %}
    <!-- í¼ -->
    <form method="POST" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 space-y-6 max-w-4xl mx-auto">

      <!-- ì˜¤í”ˆë°© ì¸ì¦ ì„¹ì…˜ (ë¹„êµ¬ë…ìë§Œ) -->
      {% if not session.get('subscriber') and not session.get('is_trial') %}
      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-2">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-yellow-400">âš </span>
          <span class="font-bold text-yellow-200">ì˜¤í”ˆì±„íŒ…ë°© ë©¤ë²„ ì¸ì¦</span>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-yellow-200/70 font-bold mb-2">ì˜¤í”ˆë°© ë‹‰ë„¤ì„ *</label>
            <input type="text" name="kakao_nickname" required
                   value="{{ form_data.get('kakao_nickname', '') if form_data else '' }}"
                   placeholder="ì˜¤í”ˆì±„íŒ…ë°©ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë‹‰ë„¤ì„"
                   class="w-full p-3 rounded-lg bg-black/50 border border-yellow-500/30 text-white focus:border-yellow-400 focus:outline-none transition"/>
          </div>
          <div>
            <label class="block text-sm text-yellow-200/70 font-bold mb-2">ì¸ì¦ ì•”í˜¸ *</label>
            <input type="text" name="kakao_password" required
                   placeholder="ê³µì§€ì‚¬í•­ì—ì„œ í™•ì¸"
                   class="w-full p-3 rounded-lg bg-black/50 border border-yellow-500/30 text-white focus:border-yellow-400 focus:outline-none transition"/>
          </div>
        </div>
        <p class="text-yellow-200/50 text-xs mt-2">ğŸ’¡ ì¸ì¦ ì•”í˜¸ëŠ” ì˜¤í”ˆì±„íŒ…ë°© ê³µì§€ì‚¬í•­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>
      </div>
      {% endif %}

      <!-- ìš”ì²­ ì •ë³´ -->
      <div>
        <label class="block text-sm text-zinc-400 font-bold mb-2">ìš”ì²­ ì œëª© *</label>
        <input type="text" name="title" required maxlength="200"
               value="{{ form_data.get('title', '') if form_data else '' }}"
               placeholder="ì˜ˆ: ë¯¸êµ­ ì£¼ë°©ìš©í’ˆ ë¦¬ë·° ì˜ìƒ"
               class="w-full p-4 rounded-lg bg-black border border-zinc-700 text-white focus:border-[#a3e635] focus:outline-none transition"/>
        <p class="text-zinc-500 text-xs mt-2">ì–´ë–¤ ì˜ìƒ/ìƒí’ˆì¸ì§€ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”.</p>
      </div>

      <div>
        <label class="block text-sm text-zinc-400 font-bold mb-2">ì›ë³¸ ë§í¬ *</label>
        <input type="url" name="original_url" required maxlength="2000"
               value="{{ form_data.get('original_url', '') if form_data else '' }}"
               placeholder="https://..."
               class="w-full p-4 rounded-lg bg-black border border-zinc-700 text-white focus:border-[#a3e635] focus:outline-none transition"/>
        <p class="text-zinc-500 text-xs mt-2">í•´ì™¸ ì˜ìƒ ë§í¬, ìƒí’ˆ ë§í¬ ë“±ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
      </div>

      <!-- ì•ˆë‚´ -->
      <div class="bg-zinc-800/50 rounded-xl p-4">
        <div class="text-sm text-zinc-400 space-y-2">
          <div class="flex items-start gap-2">
            <span class="text-[#a3e635]">âœ“</span>
            <span>ìš”ì²­í•˜ì‹  ë§í¬ëŠ” í™•ì¸ í›„ ì¿ íŒ¡ì— ìƒí’ˆì„ ë“±ë¡í•´ë“œë ¤ìš”.</span>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-[#a3e635]">âœ“</span>
            <span>ì™„ë£Œë˜ë©´ "ë‚´ ìš”ì²­ ëª©ë¡"ì—ì„œ ì¿ íŒ¡ ë§í¬ë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.</span>
          </div>
          <div class="flex items-start gap-2">
            <span class="text-[#a3e635]">âœ“</span>
            <span>ì²˜ë¦¬ ì‹œê°„ì€ 1~3ì¼ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
          </div>
        </div>
      </div>

      <!-- ë²„íŠ¼ -->
      <div class="flex gap-3 pt-2">
        <button type="submit" id="submitBtn"
                class="flex-1 bg-[#a3e635] text-black font-black py-4 rounded-lg hover:bg-white transition">
          ìš”ì²­í•˜ê¸° ({{ (monthly_limit or 3) - (monthly_used or 0) }}íšŒ ë‚¨ìŒ)
        </button>
        <a href="/link-requests"
           class="flex-1 bg-zinc-800 text-white font-bold py-4 rounded-lg hover:bg-zinc-700 transition text-center">
          ì·¨ì†Œ
        </a>
      </div>

    </form>
    <script>
    document.querySelector('form').addEventListener('submit', function() {
      var btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'ìš”ì²­ ì¤‘...';
      btn.classList.add('opacity-50', 'cursor-not-allowed');
    });
    </script>
  {% endif %}

</div>


  <!-- my request list -->
  {% if items %}
  <div class="max-w-4xl mx-auto mt-10">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-black">ë‚´ ìš”ì²­ ëª©ë¡</h2>
    </div>
    <div class="space-y-2">
      {% for it in items %}
      <a href="/link-requests/{{ it.id }}" class="block bg-zinc-900/60 border border-zinc-800 rounded-xl p-4 hover:border-zinc-700 transition">
        <div class="flex items-center justify-between">
          <div class="flex-1 min-w-0">
            <div class="font-medium text-white text-sm truncate">{{ it.title or it.original_url[:40] }}</div>
            <div class="text-zinc-600 text-xs mt-1">{{ it.created_at.strftime("%Y-%m-%d") }}</div>
          </div>
          {% if it.coupang_url %}
            <span class="bg-[#c4ff00]/10 text-[#c4ff00] text-xs font-bold px-3 py-1 rounded-full shrink-0 ml-3">ì™„ë£Œ</span>
          {% else %}
            <span class="bg-yellow-500/10 text-yellow-400 text-xs font-bold px-3 py-1 rounded-full shrink-0 ml-3 whitespace-nowrap">ëŒ€ê¸°ì¤‘</span>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
  </div>
  {% endif %}

{% endblock %}
