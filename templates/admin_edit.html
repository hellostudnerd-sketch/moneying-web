{% extends "admin_base.html" %}
{% block title %}ê²Œì‹œë¬¼ ìˆ˜ì • - MONEYING Admin{% endblock %}
{% block page_title %}ê²Œì‹œë¬¼ ìˆ˜ì •{% endblock %}
{% block page_desc %}#{{ post.id }} {{ post.title }}{% endblock %}

{% block page_actions %}
<a href="{{ next_url or '/admin/gallery' }}" class="px-4 py-2 rounded-xl bg-zinc-800 text-gray-200 hover:bg-zinc-700 transition font-bold">
  â† ë’¤ë¡œê°€ê¸°
</a>
{% endblock %}

{% block head_extra %}
<style>
  .dropzone.dragover { border-color:#a3e635; box-shadow:0 0 0 3px rgba(163,230,53,0.15); }
</style>
{% endblock %}

{% block content_admin %}
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 md:p-8">
  <div class="grid md:grid-cols-2 gap-6">

    <div>
      <label class="text-xs font-black tracking-widest text-zinc-500 uppercase">ì¹´í…Œê³ ë¦¬</label>
      <div class="flex gap-2 mt-2">
        <select id="category" class="flex-1 bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-bold focus:border-[#a3e635] focus:outline-none">
          <option value="all">ì „ì²´</option>
          {% for cat in categories %}
            <option value="{{ cat.key }}" {{ "selected" if post.category == cat.key else "" }}>{{ cat.name }}</option>
          {% endfor %}
        </select>
        <button type="button" onclick="openCategoryModal()" class="px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white hover:bg-zinc-700 transition" title="ì¹´í…Œê³ ë¦¬ ì¶”ê°€">
          +
        </button>
      </div>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì œëª©</label>
      <input id="title" type="text" value="{{ post.title or '' }}" placeholder="ì˜ˆ: ë¨¸ë¦¬ì¹´ë½ ì˜ ë¹ ì§€ëŠ” ë¹—"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-black focus:border-[#a3e635] focus:outline-none"/>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì¿ íŒ¡ ë§í¬(ì„ íƒ)</label>
      <input id="coupang" type="text" value="{{ post.coupang_link or '' }}" placeholder="link.coupang.com/a/..."
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-bold focus:border-[#a3e635] focus:outline-none"/>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì°¸ê³  ë§í¬ ìµœëŒ€ 3ê°œ</label>
      <p class="text-zinc-500 text-xs mt-1 mb-2">í‹±í†¡, ë„ìš°ì¸, ì¸ìŠ¤íƒ€, ìœ íŠœë¸Œ, ìƒ¤ì˜¤í™ìŠˆ, ë„¤ì´ë²„ MYBOX ë“± ëª¨ë“  ë§í¬ ì§€ì›</p>
      <input id="link1" type="text" placeholder="ë§í¬ 1"
             value="{{ (post_data['links'][0]) if post_data and (post_data['links']|length>0) else '' }}"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
      <input id="link2" type="text" placeholder="ë§í¬ 2"
             value="{{ (post_data['links'][1]) if post_data and (post_data['links']|length>1) else '' }}"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
      <input id="link3" type="text" placeholder="ë§í¬ 3"
             value="{{ (post_data['links'][2]) if post_data and (post_data['links']|length>2) else '' }}"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>

      <div class="mt-6 p-4 bg-zinc-900/50 border border-zinc-700 rounded-xl">
        <label class="flex items-center gap-3 cursor-pointer">
          <input id="isFree" type="checkbox" class="w-5 h-5 accent-[#a3e635]" {{ "checked" if post.is_free else "" }}/>
          <div>
            <span class="font-black text-white">ë¬´ë£Œ ê³µê°œ</span>
            <p class="text-xs text-zinc-500 mt-1">ì²´í¬í•˜ë©´ ë¹„êµ¬ë…ìë„ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
          </div>
        </label>
      </div>

      <div id="tagBox" class="hidden"></div>
    </div>

    <div>
      <div class="flex flex-col h-full">
      <label class="text-xs font-black tracking-widest text-zinc-500 uppercase">ë¯¸ë¦¬ë³´ê¸° ì˜ìƒ ì—…ë¡œë“œ</label>
      <p class="text-zinc-500 text-xs mt-1 mb-3">1080pë¡œ ìë™ ì••ì¶•, ìµœëŒ€ 60ì´ˆ</p>

      <div class="grid grid-cols-2 gap-3 items-stretch">
        <!-- ì˜ìƒ -->
        <div id="videoDropzone" class="border-2 border-dashed border-zinc-700 rounded-2xl p-4 bg-zinc-950/40 flex flex-col min-h-[400px]">
          <p class="text-sm font-black text-zinc-300 mb-2">ì˜ìƒ</p>

          <div id="videoUploadArea" class="flex-1 flex flex-col items-center justify-center text-center cursor-pointer {{ 'hidden' if post.preview_video else '' }}">
            <i class="fas fa-video text-2xl text-[#a3e635] mb-2"></i>
            <p class="font-black text-sm">ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì˜ìƒ ì˜¬ë¦¬ê¸°</p>
            <p class="text-xs text-zinc-500 mt-1">ë˜ëŠ” í´ë¦­í•´ì„œ ì„ íƒ</p>
            <input id="videoInput" type="file" accept="video/*" class="hidden"/>
          </div>

          <div id="videoPreviewArea" class="flex-1 flex flex-col {{ '' if post.preview_video else 'hidden' }}">
            <video id="previewVideo" src="{{ post.preview_video or '' }}" class="w-full flex-1 bg-black rounded-lg object-contain" controls controlsList="nodownload"></video>
            <div class="mt-2 flex gap-2">
              <button type="button" id="captureThumbBtn" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-2 py-1.5 rounded-lg text-xs font-bold">ğŸ“¸ ì¸ë„¤ì¼ë¡œ</button>
              <button type="button" id="removeVideo" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1.5 rounded-lg text-xs font-bold">ì‚­ì œ</button>
            </div>
          </div>
          <canvas id="captureCanvas" class="hidden"></canvas>
        </div>

        <!-- ì¸ë„¤ì¼ -->
        <div id="thumbSection" class="border-2 border-dashed border-zinc-700 rounded-2xl p-4 bg-zinc-950/40 flex flex-col min-h-[400px] {{ '' if post.preview_video else 'opacity-50' }}">
          <p class="text-sm font-black text-zinc-300 mb-2">ì¸ë„¤ì¼</p>

          <div class="flex-1 flex items-center justify-center">
            {% set current_thumb = post_data['images'][0] if post_data and post_data['images'] and post_data['images']|length > 0 else '' %}
            <img id="thumbImg" src="{{ current_thumb }}" class="max-h-full max-w-full object-contain rounded-lg border border-zinc-700 {{ '' if current_thumb else 'hidden' }}" />
            <div id="thumbPlaceholder" class="text-center text-zinc-500 {{ 'hidden' if current_thumb else '' }}">
              <div class="text-2xl mb-2">ğŸ–¼ï¸</div>
              <div class="text-xs">ì˜ìƒ ì—…ë¡œë“œ ì‹œ<br>ìë™ ìƒì„±ë©ë‹ˆë‹¤</div>
            </div>
          </div>

          <label id="thumbChangeBtn" class="mt-2 bg-zinc-700 hover:bg-zinc-600 text-white px-2 py-1.5 rounded-lg text-xs font-bold text-center cursor-pointer {{ '' if post.preview_video else 'hidden' }}">
            ğŸ–¼ï¸ ë³€ê²½
            <input type="file" id="thumbInput" accept="image/*" class="hidden" />
          </label>
        </div>
      </div>

      <button id="saveBtn" class="mt-4 w-full bg-[#a3e635] text-black py-4 rounded-xl font-black text-lg hover:bg-white transition">
        ìˆ˜ì •í•˜ê¸°
      </button>
      <div id="msg" class="mt-2 text-sm font-bold text-zinc-400"></div>
    </div>

      <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ -->
      <div id="uploadProgress" class="mt-4 hidden">
        <div class="flex items-center gap-3">
          <div class="w-full bg-zinc-800 rounded-full h-2">
            <div id="progressBar" class="bg-[#a3e635] h-2 rounded-full transition-all" style="width: 0%"></div>
          </div>
          <span id="progressText" class="text-xs text-zinc-400">0%</span>
        </div>
        <p id="uploadStatus" class="text-xs text-zinc-500 mt-2">ì˜ìƒ ì••ì¶• ì¤‘...</p>
      </div>

    </div>

  </div>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="categoryModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 w-full max-w-md">
    <h3 class="text-xl font-black mb-4">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
    <form id="categoryForm">
      <div class="mb-4">
        <label class="block text-sm font-bold text-zinc-400 mb-2">ì¹´í…Œê³ ë¦¬ ì´ë¦„</label>
        <input type="text" id="catName" required placeholder="ì˜ˆ: íŒ¨ì…˜, Food, ë¦¬ë¹™ìš©í’ˆ"
               class="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none">
        <p class="text-xs text-zinc-500 mt-2">í•œê¸€/ì˜ë¬¸ ëª¨ë‘ ê°€ëŠ¥</p>
      </div>

      <div class="flex gap-3">
        <button type="button" onclick="closeCategoryModal()" class="flex-1 py-3 bg-zinc-800 text-white font-bold rounded-xl hover:bg-zinc-700 transition">
          ì·¨ì†Œ
        </button>
        <button type="submit" class="flex-1 py-3 bg-[#a3e635] text-black font-black rounded-xl hover:bg-white transition">
          ì¶”ê°€
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const videoDropzone = document.getElementById("videoDropzone");
  const videoInput = document.getElementById("videoInput");
  const videoUploadArea = document.getElementById("videoUploadArea");
  const videoPreviewArea = document.getElementById("videoPreviewArea");
  const previewVideo = document.getElementById("previewVideo");
  const removeVideoBtn = document.getElementById("removeVideo");
  const thumbSection = document.getElementById("thumbSection");
  const thumbImg = document.getElementById("thumbImg");
  const thumbInput = document.getElementById("thumbInput");
  const thumbChangeBtn = document.getElementById("thumbChangeBtn");
  const thumbPlaceholder = document.getElementById("thumbPlaceholder");
  const captureThumbBtn = document.getElementById("captureThumbBtn");
  const captureCanvas = document.getElementById("captureCanvas");
  const uploadProgress = document.getElementById("uploadProgress");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const uploadStatus = document.getElementById("uploadStatus");
  const msg = document.getElementById("msg");
  const saveBtn = document.getElementById("saveBtn");
  const titleEl = document.getElementById("title");
  const tagBox = document.getElementById("tagBox");

  let uploadedVideoUrl = "{{ post.preview_video or '' }}";
  let uploadedThumbUrl = "{{ (post_data['images'][0]) if post_data and post_data['images'] and post_data['images']|length > 0 else '' }}";

  // ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬
  function openCategoryModal() {
    document.getElementById('categoryModal').classList.remove('hidden');
    document.getElementById('categoryModal').classList.add('flex');
  }
  function closeCategoryModal() {
    document.getElementById('categoryModal').classList.add('hidden');
    document.getElementById('categoryModal').classList.remove('flex');
    document.getElementById('catName').value = '';
  }

  document.getElementById('categoryForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('catName').value.trim();
    const key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_ê°€-í£]/g, '');

    const fd = new FormData();
    fd.append('key', key);
    fd.append('name', name);

    const res = await fetch('/admin/categories/add', { method: 'POST', body: fd });
    if (res.ok) {
      const select = document.getElementById('category');
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = name;
      select.appendChild(opt);
      select.value = key;
      closeCategoryModal();
    } else {
      alert('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì‹¤íŒ¨');
    }
  });

  function normalizeUrl(u) {
    if (!u) return "";
    let s = (u || "").trim();
    if (!s) return "";
    if (!/^https?:\/\//i.test(s)) s = "https://" + s.replace(/^\/+/, "");
    return s;
  }

  function autoTagsFromTitle(t) {
    if (!t) return [];
    t = t.trim();
    const stop = new Set(["the","a","an","and","or","to","of","in","on","for","with","is","are"]);
    const eng = (t.match(/[A-Za-z0-9]{2,}/g) || []).map(x => x.toUpperCase()).filter(x => !stop.has(x.toLowerCase()));
    const kor = (t.match(/[ê°€-í£]{2,}/g) || []);
    const merged = [];
    for (const w of [...eng, ...kor]) {
      if (!merged.includes(w)) merged.push(w);
      if (merged.length >= 5) break;
    }
    return merged;
  }

  function renderTags(tags) {
    tagBox.innerHTML = "";
    tags.forEach(t => {
      const s = document.createElement("span");
      s.className = "text-[11px] font-black text-[#a3e635] border border-[#a3e635]/30 px-2 py-1 rounded bg-[#a3e635]/10 uppercase tracking-wider";
      s.innerText = "#" + t;
      tagBox.appendChild(s);
    });
  }

  titleEl.addEventListener("input", () => renderTags(autoTagsFromTitle(titleEl.value)));

  // ì˜ìƒ ì—…ë¡œë“œ
  async function uploadVideo(file) {
    uploadProgress.classList.remove("hidden");
    progressBar.style.width = "0%";
    progressText.innerText = "0%";
    uploadStatus.innerText = "ì˜ìƒ ì—…ë¡œë“œ ë° ì••ì¶• ì¤‘... (ìµœëŒ€ 1ë¶„ ì†Œìš”)";

    const fd = new FormData();
    fd.append("file", file);

    try {
      let progress = 0;
      const progressInterval = setInterval(() => {
        if (progress < 90) {
          progress += Math.random() * 10;
          progressBar.style.width = Math.min(progress, 90) + "%";
          progressText.innerText = Math.round(Math.min(progress, 90)) + "%";
        }
      }, 500);

      const res = await fetch("/api/upload_video", { method: "POST", body: fd });
      clearInterval(progressInterval);

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");
      }

      progressBar.style.width = "100%";
      progressText.innerText = "100%";
      uploadStatus.innerText = "ì—…ë¡œë“œ ì™„ë£Œ!";

      uploadedVideoUrl = data.video_url;
      uploadedThumbUrl = data.thumb_url;

      previewVideo.src = uploadedVideoUrl;
      videoUploadArea.classList.add("hidden");
      videoPreviewArea.classList.remove("hidden");
      thumbImg.src = uploadedThumbUrl;
      thumbImg.classList.remove("hidden");
      thumbPlaceholder.classList.add("hidden");
      thumbSection.classList.remove("opacity-50");
      thumbChangeBtn.classList.remove("hidden");

      setTimeout(() => {
        uploadProgress.classList.add("hidden");
      }, 1000);

    } catch (e) {
      uploadProgress.classList.add("hidden");
      msg.innerText = "ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message;
    }
  }

  // ì˜ìƒ ì‚­ì œ
  removeVideoBtn.addEventListener("click", () => {
    uploadedVideoUrl = "";
    uploadedThumbUrl = "";
    previewVideo.src = "";
    thumbImg.src = "";
    videoPreviewArea.classList.add("hidden");
    videoUploadArea.classList.remove("hidden");
    thumbImg.classList.add("hidden");
    thumbPlaceholder.classList.remove("hidden");
    thumbSection.classList.add("opacity-50");
    thumbChangeBtn.classList.add("hidden");
  });

  // í˜„ì¬ ì¥ë©´ ìº¡ì²˜í•´ì„œ ì¸ë„¤ì¼ë¡œ
  captureThumbBtn.addEventListener("click", async () => {
    const video = previewVideo;
    if (!video.src || video.readyState < 2) {
      alert("ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.");
      return;
    }

    const canvas = captureCanvas;
    canvas.width = 720;
    canvas.height = 1280;
    const ctx = canvas.getContext("2d");

    const videoRatio = video.videoWidth / video.videoHeight;
    const canvasRatio = 720 / 1280;
    let drawWidth, drawHeight, drawX, drawY;

    if (videoRatio > canvasRatio) {
      drawHeight = 1280;
      drawWidth = drawHeight * videoRatio;
      drawX = (720 - drawWidth) / 2;
      drawY = 0;
    } else {
      drawWidth = 720;
      drawHeight = drawWidth / videoRatio;
      drawX = 0;
      drawY = (1280 - drawHeight) / 2;
    }

    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, 720, 1280);
    ctx.drawImage(video, drawX, drawY, drawWidth, drawHeight);

    canvas.toBlob(async (blob) => {
      if (!blob) {
        alert("ìº¡ì²˜ ì‹¤íŒ¨");
        return;
      }

      const fd = new FormData();
      fd.append("file", blob, "thumb_capture.webp");

      captureThumbBtn.innerText = "ì—…ë¡œë“œ ì¤‘...";
      captureThumbBtn.disabled = true;

      try {
        const res = await fetch("/api/upload_file", { method: "POST", body: fd });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");

        const thumbUrl = data.filename.startsWith("/") ? data.filename : "/r2/" + data.filename;
        thumbImg.src = thumbUrl;
        uploadedThumbUrl = thumbUrl;

        msg.innerText = "âœ… ì¸ë„¤ì¼ ìº¡ì²˜ ì™„ë£Œ!";
      } catch (e) {
        alert("ì¸ë„¤ì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
      } finally {
        captureThumbBtn.innerText = "ğŸ“¸ ì¸ë„¤ì¼ë¡œ";
        captureThumbBtn.disabled = false;
      }
    }, "image/webp", 0.9);
  });

  // ì¸ë„¤ì¼ ë³€ê²½
  thumbChangeBtn.addEventListener("click", () => thumbInput.click());
  thumbInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const fd = new FormData();
    fd.append("file", file);

    try {
      const res = await fetch("/api/upload_file", { method: "POST", body: fd });
      const data = await res.json();
      if (res.ok) {
        uploadedThumbUrl = data.url;
        thumbImg.src = uploadedThumbUrl;
      }
    } catch (e) {
      msg.innerText = "ì¸ë„¤ì¼ ì—…ë¡œë“œ ì‹¤íŒ¨";
    }
    thumbInput.value = "";
  });

  // ë“œë˜ê·¸ì•¤ë“œë¡­
  videoUploadArea.addEventListener("click", () => videoInput.click());
  videoInput.addEventListener("change", (e) => {
    if (e.target.files[0]) uploadVideo(e.target.files[0]);
    videoInput.value = "";
  });
  videoDropzone.addEventListener("dragover", (e) => {
    e.preventDefault();
    e.stopPropagation();
    videoDropzone.classList.add("border-[#a3e635]");
  });
  videoDropzone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    e.stopPropagation();
    videoDropzone.classList.remove("border-[#a3e635]");
  });
  videoDropzone.addEventListener("drop", (e) => {
    e.preventDefault();
    e.stopPropagation();
    videoDropzone.classList.remove("border-[#a3e635]");
    const files = e.dataTransfer.files;
    if (files && files.length > 0 && files[0].type.startsWith("video/")) {
      uploadVideo(files[0]);
    }
  });

  // ì €ì¥ (ìˆ˜ì •)
  saveBtn.addEventListener("click", async () => {
    const category = document.getElementById("category").value;
    const title = document.getElementById("title").value.trim();
    const coupang = normalizeUrl(document.getElementById("coupang").value);
    const link1 = normalizeUrl(document.getElementById("link1").value);
    const link2 = normalizeUrl(document.getElementById("link2").value);
    const link3 = normalizeUrl(document.getElementById("link3").value);
    const isFree = document.getElementById("isFree").checked;

    if (!title) return msg.innerText = "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.";

    const links = [link1, link2, link3].filter(x => x);
    const tags = autoTagsFromTitle(title);

    const fd = new FormData();
    fd.append("category", category);
    fd.append("title", title);
    fd.append("coupang_link", coupang);
    fd.append("links_json", JSON.stringify(links));
    fd.append("images_json", JSON.stringify([uploadedThumbUrl].filter(x => x)));
    fd.append("tags_json", JSON.stringify(tags));
    fd.append("is_free", isFree ? "on" : "");
    fd.append("preview_video", uploadedVideoUrl);

    msg.innerText = "ì €ì¥ ì¤‘...";

    const res = await fetch("/admin/posts/{{ post.id }}/edit?next={{ next_url }}", {
      method: "POST",
      body: fd,
      headers: { "X-Requested-With": "XMLHttpRequest", "Accept": "application/json" }
    });

    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const data = ct.includes("application/json") ? await res.json() : null;

    if (!res.ok) {
      msg.innerText = (data && data.error) ? data.error : "ìˆ˜ì • ì‹¤íŒ¨";
      return;
    }

    msg.innerText = "âœ… ìˆ˜ì • ì™„ë£Œ! ì´ë™í•©ë‹ˆë‹¤...";
    setTimeout(() => window.location.href = (data?.redirect || "{{ next_url }}" || "/admin/gallery"), 400);
  });

// í˜ì´ì§€ ì „ì²´ì—ì„œ ë“œë˜ê·¸ì•¤ë“œë¡­ ê¸°ë³¸ ë™ì‘ ë§‰ê¸°
document.addEventListener("dragover", (e) => e.preventDefault());
document.addEventListener("drop", (e) => e.preventDefault());
</script>
{% endblock %}
