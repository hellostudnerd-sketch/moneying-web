<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ADMIN - {{ "수정" if post else "새 글" }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#050505] text-white">
  <div class="max-w-4xl mx-auto px-4 py-10">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-black">갤러리 글 {{ "수정" if post else "등록" }}</h1>
      <div class="flex gap-2">
        <a href="{{ next_url or request.args.get('next', '/admin/gallery') }}" class="bg-zinc-800 px-4 py-2 rounded-lg font-black">목록</a>
      </div>
    </div>

    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6">
      <form id="postForm">
        <input type="hidden" name="post_id" value="{{ post.id if post else '' }}"/>
        <input type="hidden" name="images_json" id="images_json"/>
        <input type="hidden" name="links_json" id="links_json"/>
        <input type="hidden" name="tags_json" id="tags_json"/>
        <input type="hidden" name="preview_video" id="preview_video" value="{{ post.preview_video if post else '' }}"/>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-black text-zinc-300">카테고리</label>
            <select name="category" class="mt-2 w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-3">
              {% set cat = post.category if post else 'all' %}
              <option value="all"   {{ "selected" if cat=="all" else "" }}>all</option>
              <option value="seller"{{ "selected" if cat=="seller" else "" }}>📸 판매자 직촬</option>
              <option value="beauty"{{ "selected" if cat=="beauty" else "" }}>beauty</option>
              <option value="living"{{ "selected" if cat=="living" else "" }}>living</option>
              <option value="food"  {{ "selected" if cat=="food" else "" }}>food</option>
              <option value="tech"  {{ "selected" if cat=="tech" else "" }}>tech</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-black text-zinc-300">쿠팡 링크</label>
            <input name="coupang_link" value="{{ post.coupang_link if post else '' }}"
              class="mt-2 w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-3"
              placeholder="https://link.coupang.com/a/..." />
          </div>
        </div>

        <div class="mt-4">
          <label class="text-sm font-black text-zinc-300">제목</label>
          <input id="title" name="title" value="{{ post.title if post else '' }}"
            class="mt-2 w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-3"
            placeholder="예: 머리카락 잘 빠지는 빗" />
          <p class="text-[11px] text-zinc-500 mt-2">
            제목 기반으로 태그는 자동 생성됩니다.
          </p>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-sm font-black text-zinc-300">참고 링크 1</label>
            <input id="link1" name="link1"
              value="{{ (post_data['links'][0]) if post_data and (post_data['links']|length>0) else '' }}"
              class="mt-2 w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-3" placeholder="https://..."/>
          </div>
          <div>
            <label class="text-sm font-black text-zinc-300">참고 링크 2</label>
            <input id="link2" name="link2"
              value="{{ (post_data['links'][1]) if post_data and (post_data['links']|length>1) else '' }}"
              class="mt-2 w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-3" placeholder="https://..."/>
          </div>
          <div>
            <label class="text-sm font-black text-zinc-300">참고 링크 3</label>
            <input id="link3" name="link3"
              value="{{ (post_data['links'][2]) if post_data and (post_data['links']|length>2) else '' }}"
              class="mt-2 w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-3" placeholder="https://..."/>
          </div>
        </div>

        <!-- ✅ 무료 공개 체크박스 -->
        <div class="mt-6 p-4 bg-zinc-950/60 border border-zinc-800 rounded-lg">
          <label class="flex items-center gap-3 cursor-pointer">
            <input id="isFree" name="is_free" type="checkbox" class="w-5 h-5 accent-[#a3e635]"
                   {{ "checked" if post and post.is_free else "" }}/>
            <div>
              <span class="font-black text-white">무료 공개</span>
              <p class="text-xs text-zinc-500 mt-1">체크하면 비구독자도 볼 수 있어요</p>
            </div>
          </label>
        </div>

        <!-- 미리보기 영상 업로드 -->
        <div class="mt-8">
          <label class="text-sm font-black text-zinc-300">미리보기 영상 업로드</label>
          <p class="text-xs text-zinc-500 mt-1">720p로 자동 압축, 최대 60초</p>
          
          <div id="videoDropzone" class="mt-3 border-2 border-dashed border-zinc-700 rounded-2xl p-6 bg-zinc-950/40">
            <div id="videoUploadArea" class="text-center">
              <div class="text-sm font-black">영상을 드래그&드롭</div>
              <div class="text-[11px] text-zinc-500 mt-2">또는 클릭해서 선택 (mp4/mov/webm)</div>
              <input id="videoInput" type="file" accept="video/*" class="hidden"/>
              <button type="button" id="videoPickBtn" class="mt-4 bg-purple-500 text-white font-black px-4 py-2 rounded-lg">
                영상 선택
              </button>
            </div>
            
            <!-- 업로드 진행 -->
            <div id="videoProgress" class="hidden mt-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-sm text-zinc-400">영상 압축 및 업로드 중...</span>
              </div>
            </div>
            
            <!-- 업로드된 영상 미리보기 -->
            <div id="videoPreviewArea" class="mt-4 {{ '' if post and post.preview_video else 'hidden' }}">
              <p class="text-sm font-black mb-2">업로드된 영상</p>
              <div class="flex gap-4 items-start">
                <video id="videoPreview" src="{{ post.preview_video if post and post.preview_video else '' }}" 
                  class="w-48 aspect-[9/16] bg-black rounded-lg object-contain" controls></video>
                <button type="button" id="videoDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-bold">삭제</button>
              </div>
            </div>
          </div>
          
          <!-- 썸네일 변경 -->
          <div id="thumbSection" class="mt-4 {{ '' if post and post.preview_video else 'hidden' }}">
            <div class="flex items-center justify-between">
              <p class="text-sm font-black">썸네일</p>
              <label class="text-xs text-purple-400 cursor-pointer hover:underline">
                변경
                <input type="file" id="thumbInput" accept="image/*" class="hidden" />
              </label>
            </div>
            <div class="mt-2">
              <img id="thumbPreview" src="{{ post.preview_video.replace('.mp4', '_thumb.webp') if post and post.preview_video else '' }}" 
                class="w-24 aspect-[9/16] object-cover rounded-lg border border-zinc-700" />
            </div>
          </div>
        </div>

        <div class="mt-3 text-sm font-bold text-zinc-400" id="msg"></div>

        <div class="mt-8 flex gap-3">
          <button type="submit" class="flex-1 bg-lime-400 text-black font-black py-3 rounded-xl">
            저장하기
          </button>
          <a href="{{ next_url }}" class="flex-1 bg-zinc-800 font-black py-3 rounded-xl text-center">
            취소
          </a>
        </div>
      </form>
    </div>
  </div>

  <script>
    const existing = {{ (post_data["images"] if post_data else []) | tojson }};
    let images = [...existing];
    let uploading = false;

    const imagesJsonInput = document.getElementById("images_json");
    const linksJsonInput  = document.getElementById("links_json");
    const tagsJsonInput   = document.getElementById("tags_json");
    const previewVideoInput = document.getElementById("preview_video");
    const msg = document.getElementById("msg");

    // 영상 업로드 관련
    const videoDropzone = document.getElementById("videoDropzone");
    const videoInput = document.getElementById("videoInput");
    const videoPickBtn = document.getElementById("videoPickBtn");
    const videoProgress = document.getElementById("videoProgress");
    const videoUploadArea = document.getElementById("videoUploadArea");
    const videoPreviewArea = document.getElementById("videoPreviewArea");
    const videoPreview = document.getElementById("videoPreview");
    const videoDeleteBtn = document.getElementById("videoDeleteBtn");
    const thumbSection = document.getElementById("thumbSection");
    const thumbPreview = document.getElementById("thumbPreview");
    const thumbInput = document.getElementById("thumbInput");

    function normalizeUrl(u) {
      if (!u) return "";
      let s = (u || "").trim();
      if (!s) return "";
      if (!/^https?:\/\//i.test(s)) s = "https://" + s.replace(/^\/+/, "");
      return s;
    }

    function autoTagsFromTitle(t) {
      if (!t) return [];
      t = t.trim();
      const stop = new Set(["the","a","an","and","or","to","of","in","on","for","with","is","are"]);
      const eng = (t.match(/[A-Za-z0-9]{2,}/g) || [])
        .map(x => x.toUpperCase())
        .filter(x => !stop.has(x.toLowerCase()));
      const kor = (t.match(/[가-힣]{2,}/g) || []);
      const merged = [];
      for (const w of [...eng, ...kor]) {
        if (!merged.includes(w)) merged.push(w);
        if (merged.length >= 5) break;
      }
      return merged;
    }

    // 영상 업로드
    videoPickBtn.addEventListener("click", () => videoInput.click());
    
    videoInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) uploadVideo(e.target.files[0]);
    });

    videoDropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      videoDropzone.classList.add("border-purple-500");
    });
    
    videoDropzone.addEventListener("dragleave", () => {
      videoDropzone.classList.remove("border-purple-500");
    });
    
    videoDropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      videoDropzone.classList.remove("border-purple-500");
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith("video/")) {
        uploadVideo(files[0]);
      }
    });

    async function uploadVideo(file) {
      if (uploading) return;
      uploading = true;
      
      videoUploadArea.classList.add("hidden");
      videoProgress.classList.remove("hidden");
      
      const fd = new FormData();
      fd.append("video", file);
      
      try {
        const res = await fetch("/api/upload_video", { method: "POST", body: fd });
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error || "업로드 실패");
        
        previewVideoInput.value = data.video_url;
        videoPreview.src = data.video_url;
        thumbPreview.src = data.thumb_url;
        
        // 썸네일을 images에 추가
        images = [data.thumb_url];
        imagesJsonInput.value = JSON.stringify(images);
        
        videoPreviewArea.classList.remove("hidden");
        thumbSection.classList.remove("hidden");
        videoProgress.classList.add("hidden");
        
        msg.innerText = "✅ 영상 업로드 완료!";
      } catch (e) {
        alert("영상 업로드 실패: " + e.message);
        videoUploadArea.classList.remove("hidden");
        videoProgress.classList.add("hidden");
      } finally {
        uploading = false;
      }
    }

    // 영상 삭제
    videoDeleteBtn.addEventListener("click", () => {
      previewVideoInput.value = "";
      videoPreview.src = "";
      thumbPreview.src = "";
      images = [];
      imagesJsonInput.value = "[]";
      
      videoPreviewArea.classList.add("hidden");
      thumbSection.classList.add("hidden");
      videoUploadArea.classList.remove("hidden");
    });

    // 썸네일 변경
    thumbInput.addEventListener("change", async (e) => {
      if (e.target.files.length === 0) return;
      
      const file = e.target.files[0];
      const fd = new FormData();
      fd.append("file", file);
      
      try {
        const res = await fetch("/api/upload_file", { method: "POST", body: fd });
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error || "썸네일 업로드 실패");
        
        const thumbUrl = data.filename.startsWith("/") ? data.filename : "/static/uploads/" + data.filename;
        thumbPreview.src = thumbUrl;
        images = [thumbUrl];
        imagesJsonInput.value = JSON.stringify(images);
        
        msg.innerText = "✅ 썸네일 변경 완료!";
      } catch (e) {
        alert("썸네일 업로드 실패: " + e.message);
      }
    });

    // 폼 제출
    document.getElementById("postForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (uploading) return alert("업로드가 끝난 뒤 저장하세요.");

      const title = document.getElementById("title").value.trim();
      const link1 = normalizeUrl(document.getElementById("link1").value);
      const link2 = normalizeUrl(document.getElementById("link2").value);
      const link3 = normalizeUrl(document.getElementById("link3").value);

      if (!title) return alert("제목은 필수입니다.");

      linksJsonInput.value  = JSON.stringify([link1, link2, link3].filter(Boolean));
      tagsJsonInput.value   = JSON.stringify(autoTagsFromTitle(title));

      const form = e.target;
      const fd = new FormData(form);

      msg.innerText = "저장 중...";
      const res = await fetch(`/admin/posts/{{ post.id }}/edit?next={{ next_url }}`, {
        method:"POST",
        body: fd,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Accept": "application/json"
        }
      });

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await res.json() : null;

      if (!res.ok) {
        alert((data && data.error) ? data.error : "수정 실패");
        msg.innerText = "";
        return;
      }

      msg.innerText = "✅ 수정 완료! 이동합니다...";
      setTimeout(() => window.location.href = (data?.redirect || "{{ next_url }}" || "/admin/posts"), 400);
    });
    
    // 초기화
    imagesJsonInput.value = JSON.stringify(images);
  </script>
</body>
</html>
