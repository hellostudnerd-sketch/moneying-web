{% extends "base.html" %}
{% block title %}ë‚´ì •ë³´ - MONEYING{% endblock %}

{% block content %}

<div class="max-w-xl mx-auto">

  <!-- í”„ë¡œí•„ ì¹´ë“œ -->
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-4">
  <div class="flex items-center gap-4">
    <div class="relative group">
      <div class="w-14 h-14 bg-gradient-to-br from-[#c4ff00]/20 to-zinc-800 rounded-full flex items-center justify-center text-2xl shrink-0 overflow-hidden">
        {% if profile_photo %}
          <img src="{{ profile_photo }}" class="w-full h-full object-cover">
        {% else %}
          {% if user_is_seller %}ğŸª{% elif session.get("is_trial") %}ğŸ{% elif subscriptions and subscriptions|length > 0 %}â­{% else %}ğŸ‘¤{% endif %}
        {% endif %}
      </div>
      <label class="absolute inset-0 bg-black/50 rounded-full opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition">
        <i class="fas fa-camera text-white text-sm"></i>
        <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" onchange="uploadProfilePhoto(this)">
      </label>
    </div>
    <div class="flex-1 min-w-0">
      <!-- ë‹‰ë„¤ì„ + ë³€ê²½ ë²„íŠ¼ -->
      <div class="flex items-center gap-2">
        <div class="font-bold text-lg truncate">{{ get_nickname(user_email) }}</div>
        <a href="/my/nickname" class="text-zinc-500 hover:text-white transition" title="ë‹‰ë„¤ì„ ë³€ê²½">
          <i class="fas fa-pen text-xs"></i>
        </a>
      </div>
      <div class="text-zinc-500 text-xs truncate">{{ user_email or "unknown" }}</div>
      <div class="flex flex-wrap gap-2 mt-1">
        {% if user_is_seller %}
          <span class="px-2 py-0.5 rounded-full bg-orange-500/20 text-orange-400 text-xs font-bold">ğŸª íŒë§¤ì</span>
        {% endif %}
        {% if session.get("is_trial") %}
          <span class="px-2 py-0.5 rounded-full bg-[#c4ff00]/20 text-[#c4ff00] text-xs font-bold">ğŸ ì²´í—˜ì¤‘</span>
        {% elif subscriptions and subscriptions|length > 0 %}
          <span class="px-2 py-0.5 rounded-full bg-[#c4ff00]/20 text-[#c4ff00] text-xs font-bold">â­ êµ¬ë…ì¤‘</span>
        {% else %}
          <span class="px-2 py-0.5 rounded-full bg-zinc-700 text-zinc-400 text-xs font-bold">ì¼ë°˜íšŒì›</span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="flex gap-3 mt-4 pt-4 border-t border-zinc-800 text-sm">
    <a href="/change-password" class="text-zinc-400 hover:text-white transition">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</a>
    <span class="text-zinc-700">|</span>
    <a href="/logout" class="text-zinc-400 hover:text-white transition">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

  <!-- ë‚˜ì˜ êµ¬ë… -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl mb-4 overflow-hidden">
    <div class="px-5 py-3 border-b border-zinc-800">
      <span class="font-bold text-sm">ë‚˜ì˜ êµ¬ë…</span>
    </div>
    
    {% if subscriptions and subscriptions|length > 0 %}
      <!-- êµ¬ë… ìƒì„¸ ì •ë³´ -->
      {% for sub in subscriptions %}
      <div class="px-5 py-4 border-b border-zinc-800/50">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-xl">
              {% if sub.plan_type == 'gallery' %}ğŸ¬{% elif 'profitguard' in sub.plan_type %}ğŸ›¡ï¸{% elif sub.plan_type == 'allinone' %}â­{% else %}ğŸ“¦{% endif %}
            </span>
            <div>
              <div class="font-medium text-white text-sm">
                {% if sub.plan_type == 'gallery' %}ì˜ìƒ ê°¤ëŸ¬ë¦¬
                {% elif sub.plan_type == 'profitguard_lite' %}í”„ë¡œí•ê°€ë“œ ë¼ì´íŠ¸
                {% elif sub.plan_type == 'profitguard_pro' %}í”„ë¡œí•ê°€ë“œ í”„ë¡œ
                {% elif sub.plan_type == 'profitguard_lifetime' %}í”„ë¡œí•ê°€ë“œ í‰ìƒ
                {% elif sub.plan_type == 'allinone' %}ì˜¬ì¸ì›
                {% else %}{{ sub.plan_type }}{% endif %}
              </div>
              <div class="text-zinc-500 text-xs">
                {% if sub.expires_at %}
                  {% if sub.status == "cancelled" %}{{ sub.expires_at.strftime("%Y-%m-%d") }} ë§Œë£Œ{% else %}ë‹¤ìŒ ê²°ì œì¼ {{ sub.expires_at.strftime("%Y-%m-%d") }}{% endif %}
                {% else %}
                  í‰ìƒ ì´ìš©
                {% endif %}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 rounded-full bg-green-500/10 text-green-400 text-xs font-bold">ì´ìš©ì¤‘</span>
            {% if sub.plan_type != "profitguard_lifetime" %}
            <button onclick="openCancelModal('{{ sub.id }}', '{{ sub.plan_type }}')" class="px-2 py-1 rounded-full bg-zinc-800 text-zinc-500 text-xs hover:text-red-400 hover:bg-red-500/10 transition cursor-pointer">í•´ì§€</button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
      <!-- ì²´í—˜ì¤‘ -->
      <div class="px-5 py-4 border-b border-zinc-800/50">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-xl">ğŸ</span>
            <div>
              <div class="font-medium text-white text-sm">ë¬´ë£Œ ì²´í—˜</div>
              <div class="text-zinc-500 text-xs">{% if trial_expires_at %}{% set days_left = (trial_expires_at - now).days %}D-{{ days_left if days_left > 0 else 0 }} Â· {{ trial_expires_at.strftime('%m/%d') }} ë§Œë£Œ{% endif %}</div>
            </div>
          </div>
          <span class="px-2 py-1 rounded-full bg-[#c4ff00]/10 text-[#c4ff00] text-xs font-bold">ì²´í—˜ì¤‘</span>
        </div>
      </div>
    {% else %}
      <!-- êµ¬ë… ì—†ìŒ -->
      <a href="/pricing" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
        <div class="flex items-center gap-3">
          <span class="text-xl">ğŸ“¦</span>
          <div>
            <div class="font-medium text-white text-sm">êµ¬ë… ì‹œì‘í•˜ê¸°</div>
            <div class="text-zinc-500 text-xs">êµ¬ë… ì¤‘ì¸ ìƒí’ˆ ì—†ìŒ</div>
          </div>
        </div>
        <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
      </a>
    {% endif %}
    
    <!-- ë§í¬ìš”ì²­ -->
    <a href="/link-requests/new" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ”—</span>
        <div>
          <div class="font-medium text-white text-sm">ë§í¬ìš”ì²­</div>
          <div class="text-zinc-500 text-xs">ì´ë²ˆ ë‹¬ {{ monthly_used or 0 }}/{{ monthly_limit or 3 }}íšŒ ì‚¬ìš©</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
  </div>

  <!-- ë¹„êµ¬ë…ì/ì²´í—˜ì¤‘ì¼ ë•Œ CTA -->
  {% if not subscriptions or subscriptions|length == 0 %}
  <div class="bg-gradient-to-r from-[#c4ff00]/10 to-purple-500/10 border border-[#c4ff00]/30 rounded-2xl p-5 mb-4">
    <div class="text-center">
      {% if session.get("is_trial") %}
  <div class="text-lg font-bold text-white mb-1">ğŸ ë¬´ë£Œ ì²´í—˜ ì¤‘</div>
  {% if trial_expires_at %}
    {% set days_left = (trial_expires_at - now).days %}
    <div class="text-2xl font-black text-[#c4ff00] my-2">D-{{ days_left if days_left > 0 else 0 }}</div>
    <div class="text-zinc-400 text-sm mb-4">{{ trial_expires_at.strftime('%m/%d') }} ë§Œë£Œ Â· êµ¬ë…í•˜ê³  ê³„ì† ì´ìš©í•˜ì„¸ìš”</div>
  {% else %}
    <div class="text-zinc-400 text-sm mb-4">êµ¬ë…í•˜ê³  ê³„ì† ì´ìš©í•˜ì„¸ìš”</div>
  {% endif %}
      {% elif can_use_trial %}
        <div class="text-lg font-bold text-white mb-1">5ì¼ ë¬´ë£Œì²´í—˜ í•´ë³´ì„¸ìš”!</div>
        <div class="text-zinc-400 text-sm mb-4">ê²°ì œ ì—†ì´ ëª¨ë“  ê¸°ëŠ¥ì„ ì²´í—˜</div>
      {% else %}
        <div class="text-lg font-bold text-white mb-1">êµ¬ë…í•˜ê³  ì‹œì‘í•˜ì„¸ìš”!</div>
        <div class="text-zinc-400 text-sm mb-4">ì˜ìƒ ì†ŒìŠ¤ + ì¿ íŒ¡ ë§í¬ ë¬´ì œí•œ</div>
      {% endif %}
      <div class="flex gap-3">
        {% if can_use_trial and not session.get("is_trial") %}
          <a href="/free-trial" class="flex-1 py-3 rounded-xl font-bold border border-zinc-600 text-white hover:bg-zinc-800 transition text-center text-sm">ğŸ ë¬´ë£Œì²´í—˜</a>
        {% endif %}
        <a href="/pricing" class="flex-1 py-3 rounded-xl font-bold bg-[#c4ff00] text-black hover:bg-white transition text-center text-sm">êµ¬ë…í•˜ê¸°</a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ë‚˜ì˜ í™œë™ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl mb-4 overflow-hidden">
    <div class="px-5 py-3 border-b border-zinc-800">
      <span class="font-bold text-sm">ë‚˜ì˜ í™œë™</span>
    </div>
    
    <!-- ë‚´ê°€ ì“´ ê¸€ -->
    <a href="/my/posts" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
      <div class="flex items-center gap-3">
        <span class="text-xl">âœï¸</span>
        <div>
          <div class="font-medium text-white text-sm">ë‚´ê°€ ì“´ ê¸€</div>
          <div class="text-zinc-500 text-xs">{{ my_posts_count or 0 }}ê°œ</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
    
    <!-- ë¦¬ì›Œë“œ -->
    <a href="/my/rewards" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ</span>
        <div>
          <div class="font-medium text-white text-sm">ë¦¬ì›Œë“œ</div>
          <div class="text-zinc-500 text-xs">ì¹œêµ¬ì´ˆëŒ€ {{ invited_count or 0 }}ëª… Â· ìˆ˜ìµì¸ì¦</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
  </div>

  <!-- íŒë§¤ì ì„¹ì…˜ (íŒë§¤ìë§Œ) -->
  {% if user_is_seller %}
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl mb-4 overflow-hidden">
    <div class="px-5 py-3 border-b border-zinc-800">
      <span class="font-bold text-sm">íŒë§¤ì</span>
    </div>
    
    <a href="/my/deals" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ›ï¸</span>
        <div>
          <div class="font-medium text-white text-sm">ê³µêµ¬/í˜‘ì°¬ ê´€ë¦¬</div>
          <div class="text-zinc-500 text-xs">ì‹ ì²­ í˜„í™© í™•ì¸</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
    
    <a href="/seller/dashboard" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ“Š</span>
        <div>
          <div class="font-medium text-white text-sm">íŒë§¤ì ëŒ€ì‹œë³´ë“œ</div>
          <div class="text-zinc-500 text-xs">{{ user_seller_company or 'ë‚´ ì—…ì²´' }}</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
  </div>
  
  {% elif user_seller_status == 'pending' %}
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl mb-4 p-5">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸª</span>
        <div>
          <div class="font-medium text-white text-sm">íŒë§¤ì ì‹ ì²­ ì¤‘</div>
          <div class="text-zinc-500 text-xs">1~2ì¼ ë‚´ ê²€í†  í›„ ì•ˆë‚´</div>
        </div>
      </div>
      <span class="px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 text-xs font-bold">ëŒ€ê¸°ì¤‘</span>
    </div>
  </div>
  
  {% elif user_seller_status == 'rejected' %}
  <div class="bg-zinc-900/60 border border-red-500/30 rounded-2xl mb-4 p-5">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ˜¢</span>
        <div>
          <div class="font-medium text-white text-sm">íŒë§¤ì ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤</div>
          <div class="text-zinc-500 text-xs">ì¡°ê±´ì„ í™•ì¸ í›„ ë‹¤ì‹œ ì‹ ì²­í•´ì£¼ì„¸ìš”</div>
        </div>
      </div>
      <a href="/seller/apply" class="px-3 py-1.5 rounded-lg bg-zinc-700 text-white text-xs font-bold hover:bg-zinc-600 transition">ì¬ì‹ ì²­</a>
    </div>
  </div>
  
  {% else %}
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl mb-4 overflow-hidden">
    <a href="/seller/apply" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸª</span>
        <div>
          <div class="font-medium text-white text-sm">íŒë§¤ì ì „í™˜</div>
          <div class="text-zinc-500 text-xs">ì§ì ‘ ì˜ìƒ ì˜¬ë¦¬ê³  í¬ë¦¬ì—ì´í„°ì—ê²Œ ë…¸ì¶œ</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
  </div>
  {% endif %}

  <!-- ê¸°íƒ€ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl mb-6 overflow-hidden">
    <div class="px-5 py-3 border-b border-zinc-800">
      <span class="font-bold text-sm">ê¸°íƒ€</span>
    </div>
    
    <a href="/my/payments" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition border-b border-zinc-800/50">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ’³</span>
        <div>
          <div class="font-medium text-white text-sm">ê²°ì œ ë‚´ì—­</div>
          <div class="text-zinc-500 text-xs">êµ¬ë§¤ ë° í™˜ë¶ˆ ë‚´ì—­</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
    
    <a href="/support" class="flex items-center justify-between px-5 py-4 hover:bg-zinc-800/50 transition">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ’¬</span>
        <div>
          <div class="font-medium text-white text-sm">ê³ ê°ì„¼í„°</div>
          <div class="text-zinc-500 text-xs">ë¬¸ì˜ ë° ë„ì›€ë§</div>
        </div>
      </div>
      <i class="fas fa-chevron-right text-zinc-600 text-sm"></i>
    </a>
  </div>
  <!-- ì•± ì„¤ì¹˜ ì•ˆë‚´ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5 mb-4">
    <div class="flex items-center gap-3 mb-3">
      <div class="w-10 h-10 bg-[#c4ff00]/20 rounded-xl flex items-center justify-center">
        <i class="fas fa-mobile-alt text-[#c4ff00]"></i>
      </div>
      <div>
        <div class="font-bold text-white text-sm">ì•±ì²˜ëŸ¼ ì‚¬ìš©í•˜ê¸°</div>
        <div class="text-zinc-500 text-xs">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ë” í¸í•´ìš”!</div>
      </div>
    </div>
    <div class="bg-zinc-800/50 rounded-xl p-4 text-xs text-zinc-400 space-y-2">
      <p><span class="text-white font-bold">Android:</span> Chrome ë©”ë‰´(â‹®) â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"</p>
      <p><span class="text-white font-bold">iPhone:</span> Safari ê³µìœ (â–¡â†‘) â†’ "í™ˆ í™”ë©´ì— ì¶”ê°€"</p>
    </div>
  </div>
  <a href="/" class="block w-full bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-4 rounded-xl text-center transition text-sm">ë©”ì¸ìœ¼ë¡œ</a>

</div>
<script>
async function uploadProfilePhoto(input) {
  if (!input.files || !input.files[0]) return;
  
  const file = input.files[0];
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    const res = await fetch('/api/upload_profile_photo', { method: 'POST', body: fd });
    const data = await res.json();
    
    if (res.ok && data.url) {
      location.reload();
    } else {
      alert(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
    }
  } catch (e) {
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
  }
}
</script>
<div id="cancel-modal" style="display:none" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center">

  <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 max-w-sm w-full mx-4 text-center">

    <div class="text-4xl mb-4">âš ï¸</div>

    <h3 class="text-lg font-bold text-white mb-2">êµ¬ë… í•´ì§€</h3>

    <p id="cancel-modal-msg" class="text-zinc-400 text-sm mb-6"></p>

    <div class="flex gap-3">

      <button onclick="document.getElementById('cancel-modal').style.display='none'" class="flex-1 py-3 bg-zinc-800 text-white rounded-xl font-bold hover:bg-zinc-700 transition">ì·¨ì†Œ</button>

      <button onclick="confirmCancel()" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition">í•´ì§€í•˜ê¸°</button>

    </div>

  </div>

</div>

<script>

var cancelSubId = null;

function openCancelModal(subId, planType) {

  cancelSubId = subId;

  var names = {'gallery':'ì˜ìƒ ê°¤ëŸ¬ë¦¬','profitguard_lite':'í”„ë¡œí•ê°€ë“œ ë¼ì´íŠ¸','profitguard_pro':'í”„ë¡œí•ê°€ë“œ í”„ë¡œ','profitguard_lifetime':'í”„ë¡œí•ê°€ë“œ í‰ìƒ','allinone':'ì˜¬ì¸ì›'};

  var planName = names[planType] || planType;

  document.getElementById('cancel-modal-msg').innerHTML = '<strong>' + planName + '</strong> êµ¬ë…ì„ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-xs text-zinc-500">í•´ì§€ í›„ì—ë„ ë§Œë£Œì¼ê¹Œì§€ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>';

  document.getElementById('cancel-modal').style.display = 'flex';

}

function confirmCancel() {

  fetch('/api/subscription/cancel', {

    method: 'POST',

    headers: {'Content-Type': 'application/json'},

    body: JSON.stringify({subscription_id: cancelSubId})

  })

  .then(function(r) { return r.json(); })

  .then(function(d) {

    document.getElementById('cancel-modal').style.display = 'none';

    if (d.result === 'SUCCESS') { location.reload(); }

    else { document.getElementById('cancel-modal-msg').textContent = d.msg; document.getElementById('cancel-modal').style.display = 'flex'; }

  });

}

</script>

{% endblock %}
