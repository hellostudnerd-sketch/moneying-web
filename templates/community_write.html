{% extends "base.html" %}
{% block title %}ê¸€ì“°ê¸° - ì»¤ë®¤ë‹ˆí‹°{% endblock %}

{% block head_extra %}
<!-- Flatpickr ë‹¬ë ¥ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">
    <a href="javascript:history.back()" class="text-zinc-500 hover:text-white transition text-sm mb-2 inline-block">â† ë’¤ë¡œê°€ê¸°</a>

  <div class="mb-6 md:mb-8">
    <h1 class="text-2xl font-black">ê¸€ì“°ê¸°</h1>
    <p class="text-zinc-400 mt-1 md:mt-2 text-sm md:text-base">ì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒ í›„ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
  </div>

  <form method="POST" class="space-y-4 md:space-y-6" onsubmit="return validateForm()">

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ì¹´í…Œê³ ë¦¬</label>
      <select name="category" id="categorySelect" class="w-full p-3 md:p-4 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-base focus:border-[#a3e635] focus:outline-none">
        <option value="free">ğŸ—£ ììœ ê²Œì‹œíŒ</option>
        <option value="tips">ğŸ’¡ ê¿€íŒê³µìœ </option>
        <option value="qna">â“ ì§ˆë¬¸ë‹µë³€</option>
        <option value="revenue">ğŸ’¸ ìˆ˜ìµì¸ì¦</option>
        {% if session.get("is_seller") or session.get("admin") %}<option value="deal">ğŸ›ï¸ ê³µêµ¬/í˜‘ì°¬</option>{% endif %}
        {% if session.get("admin") %}<option value="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</option>{% endif %}
      </select>
      {% if not session.get("is_seller") and not session.get("admin") %}
      <p class="text-xs text-zinc-500 mt-2">ğŸ’¡ ê³µêµ¬/í˜‘ì°¬ ê¸€ì€ <a href="/seller/apply" class="text-[#a3e635] hover:underline">íŒë§¤ì ë“±ë¡</a> í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      {% endif %}
    </div>

    <!-- ìˆ˜ìµì¸ì¦ ì•ˆë‚´ -->
    <div id="revenueGuide" class="hidden bg-green-500/10 border border-green-500/30 rounded-xl p-4">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xl">ğŸ’¸</span>
        <span class="font-bold text-green-400 text-sm md:text-base">ìˆ˜ìµ ì¸ì¦ ë¦¬ì›Œë“œ ì•ˆë‚´</span>
      </div>
      <div class="text-zinc-400 text-xs md:text-sm space-y-1">
        <p>âœ“ ë¨¸ë‹ ê°¤ëŸ¬ë¦¬ ì˜ìƒìœ¼ë¡œ ë°œìƒí•œ ìˆ˜ìµì„ ì¸ì¦í•´ì£¼ì„¸ìš”</p>
        <p>âœ“ ìˆ˜ìµ ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš” (ê¸ˆì•¡ ì¼ë¶€ ê°€ë¦¼ OK)</p>
        <p>âœ“ ê´€ë¦¬ì ìŠ¹ì¸ ì‹œ <strong class="text-[#a3e635]">7ì¼ êµ¬ë… ì—°ì¥!</strong></p>
        <p class="text-yellow-400">âš  ì›” 1íšŒë§Œ ì¸ì •ë©ë‹ˆë‹¤</p>
      </div>
    </div>

    <!-- ê³µêµ¬/í˜‘ì°¬ ì„¤ì • -->
    <div id="dealOptions" class="hidden bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 space-y-4">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xl">ğŸ›ï¸</span>
        <span class="font-bold text-purple-400 text-sm md:text-base">ê³µêµ¬/í˜‘ì°¬ ì„¤ì •</span>
      </div>

      <div>
        <label class="block text-sm font-bold text-zinc-400 mb-2">ìœ í˜• ì„ íƒ *</label>
        <div class="flex gap-3">
          <label class="flex-1 cursor-pointer">
            <input type="radio" name="deal_type" value="groupbuy" checked class="hidden peer">
            <div class="p-4 rounded-xl border-2 border-zinc-700 peer-checked:border-[#c4ff00] peer-checked:bg-[#c4ff00]/10 text-center transition">
              <div class="text-2xl mb-1">ğŸ›’</div>
              <div class="font-bold text-white">ê³µêµ¬</div>
              <div class="text-xs text-zinc-500">ê³µë™êµ¬ë§¤</div>
            </div>
          </label>
          <label class="flex-1 cursor-pointer">
            <input type="radio" name="deal_type" value="sponsor" class="hidden peer">
            <div class="p-4 rounded-xl border-2 border-zinc-700 peer-checked:border-purple-400 peer-checked:bg-purple-500/10 text-center transition">
              <div class="text-2xl mb-1">ğŸ</div>
              <div class="font-bold text-white">í˜‘ì°¬</div>
              <div class="text-xs text-zinc-500">ë¬´ë£Œ ì œí’ˆ ì œê³µ</div>
            </div>
          </label>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-zinc-400 mb-2">ë§ˆê°ì¼ (ì„ íƒ)</label>
        <input type="text" name="deal_deadline" id="deadlinePicker" class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none cursor-pointer" placeholder="ğŸ“… í´ë¦­í•˜ì—¬ ë§ˆê°ì¼ ì„ íƒ" readonly>
        <p class="text-xs text-zinc-500 mt-1">ë¯¸ì…ë ¥ ì‹œ ìˆ˜ë™ ë§ˆê°</p>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-zinc-400 mb-2">ìµœëŒ€ ì¸ì› (ì„ íƒ)</label>
        <input type="number" name="deal_max_people" min="1" placeholder="ì˜ˆ: 10" class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none">
        <p class="text-xs text-zinc-500 mt-1">ë¯¸ì…ë ¥ ì‹œ ì¸ì› ì œí•œ ì—†ìŒ</p>
      </div>
      
      <div class="flex items-center gap-3">
        <input type="checkbox" name="deal_subscribers_only" id="subscribersOnly" class="w-5 h-5 rounded bg-zinc-800 border-zinc-600 text-purple-500 focus:ring-purple-500">
        <label for="subscribersOnly" class="text-sm text-zinc-300">êµ¬ë…ìë§Œ ì‹ ì²­ ê°€ëŠ¥</label>
      </div>
    </div>

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ì œëª©</label>
      <input type="text" name="title" required placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 md:p-4 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-base focus:border-[#a3e635] focus:outline-none">
    </div>

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ë‚´ìš©</label>
      <textarea name="content" required rows="6" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 md:p-4 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-base focus:border-[#a3e635] focus:outline-none resize-none"></textarea>
    </div>

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ì´ë¯¸ì§€ ì²¨ë¶€ <span id="imageRequired" class="hidden text-red-400">*í•„ìˆ˜</span></label>
      <div id="imagePreview" class="flex flex-wrap gap-2 mb-3"></div>
      <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg border border-zinc-700 transition text-sm">
        <i class="fas fa-image"></i><span>ì´ë¯¸ì§€ ì¶”ê°€</span>
        <input type="file" accept="image/*" multiple class="hidden" onchange="uploadImages(this)">
      </label>
      <input type="hidden" name="images_json" id="imagesJson" value="[]">
    </div>

    <div class="flex gap-3 pt-2 md:pt-4">
      <button type="submit" class="flex-1 bg-[#a3e635] text-black font-black py-3 md:py-4 rounded-lg hover:bg-white transition text-sm md:text-base">ë“±ë¡í•˜ê¸°</button>
      <a href="/community" class="flex-1 bg-zinc-800 text-white font-bold py-3 md:py-4 rounded-lg hover:bg-zinc-700 transition text-center text-sm md:text-base">ì·¨ì†Œ</a>
    </div>

  </form>

</div>

<script>
let uploadedImages = [];

const urlParams = new URLSearchParams(window.location.search);
const category = urlParams.get('category');
if (category) { document.getElementById('categorySelect').value = category; toggleGuides(); }

document.getElementById('categorySelect').addEventListener('change', toggleGuides);

function toggleGuides() {
  const selected = document.getElementById('categorySelect').value;
  document.getElementById('revenueGuide').classList.toggle('hidden', selected !== 'revenue');
  document.getElementById('dealOptions').classList.toggle('hidden', selected !== 'deal');
}

async function uploadImages(input) {
  for (let file of input.files) {
    const formData = new FormData();
    formData.append('file', file);
    try {
      const res = await fetch('/api/upload_public', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.ok) { uploadedImages.push(data.url); updateImagePreview(); }
    } catch (e) { console.error('Upload error:', e); }
  }
  input.value = '';
}

function updateImagePreview() {
  const preview = document.getElementById('imagePreview');
  preview.innerHTML = uploadedImages.map((url, i) => `
    <div class="relative">
      <img src="${url}" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg border border-zinc-700">
      <button type="button" onclick="removeImage(${i})" class="absolute -top-2 -right-2 w-5 h-5 md:w-6 md:h-6 bg-red-500 rounded-full text-white text-xs font-bold">Ã—</button>
    </div>
  `).join('');
  document.getElementById('imagesJson').value = JSON.stringify(uploadedImages);
}

function removeImage(index) { uploadedImages.splice(index, 1); updateImagePreview(); }

// Flatpickr ë‹¬ë ¥ ì´ˆê¸°í™”
flatpickr("#deadlinePicker", {
  locale: "ko",
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  minDate: "today",
  disableMobile: true
});

// ì¹´í…Œê³ ë¦¬ ë°”ë€” ë•Œ ì´ë¯¸ì§€ í•„ìˆ˜ í‘œì‹œ
function updateImageRequired() {
  const category = document.getElementById('categorySelect').value;
  const requiredBadge = document.getElementById('imageRequired');
  if (category === 'revenue' || category === 'deal') {
    requiredBadge.classList.remove('hidden');
  } else {
    requiredBadge.classList.add('hidden');
  }
}

// ì´ˆê¸° ì‹¤í–‰ + ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì‹¤í–‰
updateImageRequired();
document.getElementById('categorySelect').addEventListener('change', updateImageRequired);

// í¼ ì œì¶œ ì „ ê²€ì¦
function validateForm() {
  const category = document.getElementById('categorySelect').value;
  
  if ((category === 'revenue' || category === 'deal') && uploadedImages.length === 0) {
    showAlert('ì´ë¯¸ì§€ í•„ìˆ˜', 'ìˆ˜ìµì¸ì¦/ê³µêµ¬/í˜‘ì°¬ ê¸€ì€ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì•¼ í•©ë‹ˆë‹¤.', 'ğŸ“¸');
    return false;
  }
  return true;
}

</script>

{% endblock %}