{% extends "admin_base.html" %}
{% block title %}ìƒˆ ê²Œì‹œë¬¼ - MONEYING Admin{% endblock %}
{% block page_title %}ìƒˆ ê²Œì‹œë¬¼{% endblock %}
{% block page_desc %}ë¯¸ë¦¬ë³´ê¸° ì˜ìƒ + ì°¸ê³  ë§í¬(ìµœëŒ€ 3ê°œ){% endblock %}

{% block page_actions %}
<a href="/admin/gallery" class="px-4 py-2 rounded-xl bg-zinc-800 text-gray-200 hover:bg-zinc-700 transition font-bold">
  â† ëª©ë¡ìœ¼ë¡œ
</a>
{% endblock %}

{% block head_extra %}
<style>
  .dropzone.dragover { border-color:#a3e635; box-shadow:0 0 0 3px rgba(163,230,53,0.15); }
</style>
{% endblock %}

{% block content_admin %}
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 md:p-8">
  <div class="grid md:grid-cols-2 gap-6">

    <div>
      <label class="text-xs font-black tracking-widest text-zinc-500 uppercase">ì¹´í…Œê³ ë¦¬</label>
      <div class="flex gap-2 mt-2">
        <select id="category" class="flex-1 bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-bold focus:border-[#a3e635] focus:outline-none">
          <option value="all">ì „ì²´</option>
          {% for cat in categories %}
            <option value="{{ cat.key }}">{{ cat.emoji }} {{ cat.name }}</option>
          {% endfor %}
        </select>
        <button type="button" onclick="openCategoryModal()" class="px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white hover:bg-zinc-700 transition" title="ì¹´í…Œê³ ë¦¬ ì¶”ê°€">
          +
        </button>
      </div>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì œëª©</label>
      <input id="title" type="text" placeholder="ì˜ˆ: ë¨¸ë¦¬ì¹´ë½ ì˜ ë¹ ì§€ëŠ” ë¹—"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-black focus:border-[#a3e635] focus:outline-none"/>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì¿ íŒ¡ ë§í¬(ì„ íƒ)</label>
      <input id="coupang" type="text" placeholder="link.coupang.com/a/..."
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white font-bold focus:border-[#a3e635] focus:outline-none"/>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ì°¸ê³  ë§í¬ ìµœëŒ€ 3ê°œ</label>
      <p class="text-zinc-500 text-xs mt-1 mb-2">í‹±í†¡, ë„ìš°ì¸, ì¸ìŠ¤íƒ€, ìœ íŠœë¸Œ, ìƒ¤ì˜¤í™ìŠˆ, ë„¤ì´ë²„ MYBOX ë“± ëª¨ë“  ë§í¬ ì§€ì›</p>
      <input id="link1" type="text" placeholder="ë§í¬ 1"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
      <input id="link2" type="text" placeholder="ë§í¬ 2"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>
      <input id="link3" type="text" placeholder="ë§í¬ 3"
             class="mt-2 w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none"/>

      <div class="mt-6 p-4 bg-zinc-900/50 border border-zinc-700 rounded-xl">
        <label class="flex items-center gap-3 cursor-pointer">
          <input id="isFree" type="checkbox" class="w-5 h-5 accent-[#a3e635]"/>
          <div>
            <span class="font-black text-white">ë¬´ë£Œ ê³µê°œ</span>
            <p class="text-xs text-zinc-500 mt-1">ì²´í¬í•˜ë©´ ë¹„êµ¬ë…ìë„ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
          </div>
        </label>
      </div>

      <label class="block mt-6 text-xs font-black tracking-widest text-zinc-500 uppercase">ìë™ íƒœê·¸(ì œëª© ê¸°ë°˜)</label>
      <div id="tagBox" class="mt-2 flex flex-wrap gap-2"></div>
      <p class="text-[11px] text-zinc-500 mt-2">* ì €ì¥ ì‹œ íƒœê·¸ê°€ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤.</p>
    </div>

    <div>
      <!-- ì˜ìƒ ì—…ë¡œë“œ -->
      <label class="text-xs font-black tracking-widest text-zinc-500 uppercase">ë¯¸ë¦¬ë³´ê¸° ì˜ìƒ ì—…ë¡œë“œ</label>
      <p class="text-zinc-500 text-xs mt-1 mb-2">720pë¡œ ìë™ ì••ì¶•, ìµœëŒ€ 60ì´ˆ</p>

      <div id="videoDropzone" class="dropzone mt-2 bg-zinc-900/60 border border-zinc-700 border-dashed rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-[#a3e635] transition">
        <i class="fas fa-video text-3xl text-[#a3e635] mb-3"></i>
        <p class="font-black">ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ì˜ìƒ ì˜¬ë¦¬ê¸°</p>
        <p class="text-xs text-zinc-500 mt-1">ë˜ëŠ” í´ë¦­í•´ì„œ ì„ íƒ (mp4/mov/avi/webm)</p>
        <input id="videoInput" type="file" accept="video/*" class="hidden"/>
      </div>

      <!-- ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° -->
      <div id="videoPreview" class="mt-4 hidden">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-black">ì—…ë¡œë“œëœ ì˜ìƒ</p>
          <button id="removeVideo" class="text-xs text-red-400 hover:text-red-300">ì‚­ì œ</button>
        </div>
        <div class="relative aspect-[9/16] max-w-[200px] rounded-xl overflow-hidden border border-zinc-800 bg-zinc-900">
          <video id="previewVideo" class="w-full h-full object-cover" controls controlsList="nodownload">
          </video>
        </div>
      </div>

      <!-- ì¸ë„¤ì¼ ë³€ê²½ -->
      <div id="thumbSection" class="mt-4 hidden">
        <div class="flex items-center justify-between">
          <p class="text-sm font-black">ì¸ë„¤ì¼</p>
          <button id="changeThumb" class="text-xs text-[#a3e635] hover:text-white">ë³€ê²½</button>
        </div>
        <div class="mt-2 relative w-24 h-24 rounded-xl overflow-hidden border border-zinc-800 bg-zinc-900">
          <img id="thumbImg" class="w-full h-full object-cover">
        </div>
        <input id="thumbInput" type="file" accept="image/*" class="hidden"/>
      </div>

      <!-- ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ -->
      <div id="uploadProgress" class="mt-4 hidden">
        <div class="flex items-center gap-3">
          <div class="w-full bg-zinc-800 rounded-full h-2">
            <div id="progressBar" class="bg-[#a3e635] h-2 rounded-full transition-all" style="width: 0%"></div>
          </div>
          <span id="progressText" class="text-xs text-zinc-400">0%</span>
        </div>
        <p id="uploadStatus" class="text-xs text-zinc-500 mt-2">ì˜ìƒ ì••ì¶• ì¤‘...</p>
      </div>

      <button id="saveBtn" class="mt-6 w-full bg-[#a3e635] text-black py-4 rounded-xl font-black text-lg hover:bg-white transition">
        ì €ì¥í•˜ê¸°
      </button>

      <div id="msg" class="mt-3 text-sm font-bold text-zinc-400"></div>
    </div>

  </div>
</div>

<!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="categoryModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 w-full max-w-md">
    <h3 class="text-xl font-black mb-4">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
    <form id="categoryForm">
      <div class="mb-4">
        <label class="block text-sm font-bold text-zinc-400 mb-2">í‚¤ (ì˜ë¬¸)</label>
        <input type="text" id="catKey" required placeholder="ì˜ˆ: fashion"
               class="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none">
      </div>
      <div class="mb-4">
        <label class="block text-sm font-bold text-zinc-400 mb-2">ì´ë¦„</label>
        <input type="text" id="catName" required placeholder="ì˜ˆ: Fashion"
               class="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-bold text-zinc-400 mb-2">ì´ëª¨ì§€</label>
        <input type="text" id="catEmoji" placeholder="ğŸ‘—"
               class="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none">
      </div>
      <div class="flex gap-3">
        <button type="button" onclick="closeCategoryModal()" class="flex-1 py-3 bg-zinc-800 text-white font-bold rounded-xl hover:bg-zinc-700 transition">
          ì·¨ì†Œ
        </button>
        <button type="submit" class="flex-1 py-3 bg-[#a3e635] text-black font-black rounded-xl hover:bg-white transition">
          ì¶”ê°€
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const videoDropzone = document.getElementById("videoDropzone");
  const videoInput = document.getElementById("videoInput");
  const videoPreview = document.getElementById("videoPreview");
  const previewVideo = document.getElementById("previewVideo");
  const removeVideoBtn = document.getElementById("removeVideo");
  const thumbSection = document.getElementById("thumbSection");
  const thumbImg = document.getElementById("thumbImg");
  const thumbInput = document.getElementById("thumbInput");
  const changeThumbBtn = document.getElementById("changeThumb");
  const uploadProgress = document.getElementById("uploadProgress");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const uploadStatus = document.getElementById("uploadStatus");
  const msg = document.getElementById("msg");
  const saveBtn = document.getElementById("saveBtn");
  const titleEl = document.getElementById("title");
  const tagBox = document.getElementById("tagBox");

  let uploadedVideoUrl = "";
  let uploadedThumbUrl = "";

  // ì¹´í…Œê³ ë¦¬ ëª¨ë‹¬
  function openCategoryModal() {
    document.getElementById('categoryModal').classList.remove('hidden');
    document.getElementById('categoryModal').classList.add('flex');
  }
  function closeCategoryModal() {
    document.getElementById('categoryModal').classList.add('hidden');
    document.getElementById('categoryModal').classList.remove('flex');
    document.getElementById('catKey').value = '';
    document.getElementById('catName').value = '';
    document.getElementById('catEmoji').value = '';
  }

  document.getElementById('categoryForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const key = document.getElementById('catKey').value.trim().toLowerCase();
    const name = document.getElementById('catName').value.trim();
    const emoji = document.getElementById('catEmoji').value.trim();
    
    const fd = new FormData();
    fd.append('key', key);
    fd.append('name', name);
    fd.append('emoji', emoji);
    
    const res = await fetch('/admin/categories/add', { method: 'POST', body: fd });
    if (res.ok) {
      const select = document.getElementById('category');
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = (emoji ? emoji + ' ' : '') + name;
      select.appendChild(opt);
      select.value = key;
      closeCategoryModal();
    } else {
      alert('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì‹¤íŒ¨');
    }
  });

  function normalizeUrl(u) {
    if (!u) return "";
    let s = (u || "").trim();
    if (!s) return "";
    if (!/^https?:\/\//i.test(s)) s = "https://" + s.replace(/^\/+/, "");
    return s;
  }

  function autoTagsFromTitle(t) {
    if (!t) return [];
    t = t.trim();
    const stop = new Set(["the","a","an","and","or","to","of","in","on","for","with","is","are"]);
    const eng = (t.match(/[A-Za-z0-9]{2,}/g) || []).map(x => x.toUpperCase()).filter(x => !stop.has(x.toLowerCase()));
    const kor = (t.match(/[ê°€-í£]{2,}/g) || []);
    const merged = [];
    for (const w of [...eng, ...kor]) {
      if (!merged.includes(w)) merged.push(w);
      if (merged.length >= 5) break;
    }
    return merged;
  }

  function renderTags(tags) {
    tagBox.innerHTML = "";
    tags.forEach(t => {
      const s = document.createElement("span");
      s.className = "text-[11px] font-black text-[#a3e635] border border-[#a3e635]/30 px-2 py-1 rounded bg-[#a3e635]/10 uppercase tracking-wider";
      s.innerText = "#" + t;
      tagBox.appendChild(s);
    });
  }

  titleEl.addEventListener("input", () => renderTags(autoTagsFromTitle(titleEl.value)));

  // ì˜ìƒ ì—…ë¡œë“œ
  async function uploadVideo(file) {
    uploadProgress.classList.remove("hidden");
    progressBar.style.width = "0%";
    progressText.innerText = "0%";
    uploadStatus.innerText = "ì˜ìƒ ì—…ë¡œë“œ ë° ì••ì¶• ì¤‘... (ìµœëŒ€ 1ë¶„ ì†Œìš”)";
    
    const fd = new FormData();
    fd.append("file", file);
    
    try {
      // ì§„í–‰ í‘œì‹œ (ì‹¤ì œ ì§„í–‰ë¥ ì€ ì•Œ ìˆ˜ ì—†ì–´ì„œ ê°€ì§œë¡œ)
      let progress = 0;
      const progressInterval = setInterval(() => {
        if (progress < 90) {
          progress += Math.random() * 10;
          progressBar.style.width = Math.min(progress, 90) + "%";
          progressText.innerText = Math.round(Math.min(progress, 90)) + "%";
        }
      }, 500);
      
      const res = await fetch("/api/upload_video", { method: "POST", body: fd });
      clearInterval(progressInterval);
      
      const data = await res.json();
      
      if (!res.ok) {
        throw new Error(data.error || "ì—…ë¡œë“œ ì‹¤íŒ¨");
      }
      
      progressBar.style.width = "100%";
      progressText.innerText = "100%";
      uploadStatus.innerText = "ì—…ë¡œë“œ ì™„ë£Œ!";
      
      uploadedVideoUrl = data.video_url;
      uploadedThumbUrl = data.thumb_url;
      
      // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      previewVideo.src = uploadedVideoUrl;
      thumbImg.src = uploadedThumbUrl;
      videoPreview.classList.remove("hidden");
      thumbSection.classList.remove("hidden");
      videoDropzone.classList.add("hidden");
      
      setTimeout(() => {
        uploadProgress.classList.add("hidden");
      }, 1000);
      
    } catch (e) {
      uploadProgress.classList.add("hidden");
      msg.innerText = "ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message;
    }
  }

  // ì˜ìƒ ì‚­ì œ
  removeVideoBtn.addEventListener("click", () => {
    uploadedVideoUrl = "";
    uploadedThumbUrl = "";
    previewVideo.src = "";
    thumbImg.src = "";
    videoPreview.classList.add("hidden");
    thumbSection.classList.add("hidden");
    videoDropzone.classList.remove("hidden");
  });

  // ì¸ë„¤ì¼ ë³€ê²½
  changeThumbBtn.addEventListener("click", () => thumbInput.click());
  thumbInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const fd = new FormData();
    fd.append("file", file);
    
    try {
      const res = await fetch("/api/upload_file", { method: "POST", body: fd });
      const data = await res.json();
      if (res.ok) {
        uploadedThumbUrl = data.url;
        thumbImg.src = uploadedThumbUrl;
      }
    } catch (e) {
      msg.innerText = "ì¸ë„¤ì¼ ì—…ë¡œë“œ ì‹¤íŒ¨";
    }
    thumbInput.value = "";
  });

  // ë“œë˜ê·¸ì•¤ë“œë¡­
  videoDropzone.addEventListener("click", () => videoInput.click());
  videoInput.addEventListener("change", (e) => {
    if (e.target.files[0]) uploadVideo(e.target.files[0]);
    videoInput.value = "";
  });
  videoDropzone.addEventListener("dragover", (e) => { e.preventDefault(); videoDropzone.classList.add("dragover"); });
  videoDropzone.addEventListener("dragleave", () => videoDropzone.classList.remove("dragover"));
  videoDropzone.addEventListener("drop", (e) => {
    e.preventDefault();
    videoDropzone.classList.remove("dragover");
    if (e.dataTransfer.files[0]) uploadVideo(e.dataTransfer.files[0]);
  });

  // ì €ì¥
  saveBtn.addEventListener("click", async () => {
    const category = document.getElementById("category").value;
    const title = document.getElementById("title").value.trim();
    const coupang = normalizeUrl(document.getElementById("coupang").value);
    const link1 = normalizeUrl(document.getElementById("link1").value);
    const link2 = normalizeUrl(document.getElementById("link2").value);
    const link3 = normalizeUrl(document.getElementById("link3").value);
    const isFree = document.getElementById("isFree").checked;

    if (!title) return msg.innerText = "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.";
    if (!uploadedVideoUrl) return msg.innerText = "ì˜ìƒì„ ì—…ë¡œë“œí•˜ì„¸ìš”.";

    const links = [link1, link2, link3].filter(x => x);
    const tags = autoTagsFromTitle(title);

    const fd = new FormData();
    fd.append("category", category);
    fd.append("title", title);
    fd.append("coupang_link", coupang);
    fd.append("links_json", JSON.stringify(links));
    fd.append("images_json", JSON.stringify([uploadedThumbUrl]));
    fd.append("tags_json", JSON.stringify(tags));
    fd.append("is_free", isFree ? "1" : "0");
    fd.append("preview_video", uploadedVideoUrl);

    msg.innerText = "ì €ì¥ ì¤‘...";

    const res = await fetch("/api/save_post", {
      method: "POST",
      body: fd,
      headers: { "X-Requested-With": "XMLHttpRequest", "Accept": "application/json" }
    });

    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const data = ct.includes("application/json") ? await res.json() : null;

    if (!res.ok) {
      msg.innerText = (data && data.error) ? data.error : "ì €ì¥ ì‹¤íŒ¨";
      return;
    }

    msg.innerText = "âœ… ì €ì¥ ì™„ë£Œ! ì´ë™í•©ë‹ˆë‹¤...";
    setTimeout(() => window.location.href = (data?.redirect || "/admin/gallery"), 400);
  });
</script>
{% endblock %}
