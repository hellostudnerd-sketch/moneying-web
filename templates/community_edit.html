{% extends "base.html" %}
{% block title %}ê¸€ ìˆ˜ì • - ì»¤ë®¤ë‹ˆí‹°{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
{% endblock %}

{% block content %}

<div class="max-w-2xl mx-auto">

  <div class="mb-6 md:mb-8">
    <a href="/community/{{ post.id }}" class="text-zinc-500 hover:text-white transition text-sm">â† ëŒì•„ê°€ê¸°</a>
    <h1 class="text-2xl md:text-3xl font-black mt-4">ê¸€ ìˆ˜ì •</h1>
  </div>

  <form method="POST" class="space-y-4 md:space-y-6" onsubmit="return validateForm()">

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ì¹´í…Œê³ ë¦¬</label>
      <div class="w-full p-3 md:p-4 rounded-lg bg-zinc-800 border border-zinc-700 text-zinc-400">
        {% if post.category == 'notice' %}ğŸ“¢ ê³µì§€ì‚¬í•­{% elif post.category == 'deal' %}ğŸ›ï¸ ê³µêµ¬/í˜‘ì°¬{% elif post.category == 'revenue' %}ğŸ’¸ ìˆ˜ìµì¸ì¦{% elif post.category == 'tips' %}ğŸ’¡ ê¿€íŒê³µìœ {% elif post.category == 'qna' %}â“ ì§ˆë¬¸ë‹µë³€{% else %}ğŸ—£ ììœ ê²Œì‹œíŒ{% endif %}
      </div>
      <p class="text-xs text-zinc-500 mt-1">ì¹´í…Œê³ ë¦¬ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
    </div>

    {% if post.category == 'deal' %}
    <!-- ê³µêµ¬/í˜‘ì°¬ ì„¤ì • -->
    <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 space-y-4">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xl">ğŸ›ï¸</span>
        <span class="font-bold text-purple-400 text-sm md:text-base">ê³µêµ¬/í˜‘ì°¬ ì„¤ì •</span>
      </div>

      <div>
        <label class="block text-sm font-bold text-zinc-400 mb-2">ìœ í˜• ì„ íƒ *</label>
        <div class="flex gap-3">
          <label class="flex-1 cursor-pointer">
            <input type="radio" name="deal_type" value="groupbuy" {% if post.deal_type == 'groupbuy' %}checked{% endif %} class="hidden peer">
            <div class="p-4 rounded-xl border-2 border-zinc-700 peer-checked:border-[#c4ff00] peer-checked:bg-[#c4ff00]/10 text-center transition">
              <div class="text-2xl mb-1">ğŸ›’</div>
              <div class="font-bold text-white">ê³µêµ¬</div>
              <div class="text-xs text-zinc-500">ê³µë™êµ¬ë§¤</div>
            </div>
          </label>
          <label class="flex-1 cursor-pointer">
            <input type="radio" name="deal_type" value="sponsor" {% if post.deal_type == 'sponsor' %}checked{% endif %} class="hidden peer">
            <div class="p-4 rounded-xl border-2 border-zinc-700 peer-checked:border-purple-400 peer-checked:bg-purple-500/10 text-center transition">
              <div class="text-2xl mb-1">ğŸ</div>
              <div class="font-bold text-white">í˜‘ì°¬</div>
              <div class="text-xs text-zinc-500">ë¬´ë£Œ ì œí’ˆ ì œê³µ</div>
            </div>
          </label>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-zinc-400 mb-2">ë§ˆê°ì¼ (ì„ íƒ)</label>
        <input type="text" name="deal_deadline" id="deadlinePicker" value="{% if post.deal_deadline %}{{ post.deal_deadline.strftime('%Y-%m-%d') }}{% endif %}" class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none cursor-pointer" placeholder="ğŸ“… í´ë¦­í•˜ì—¬ ë§ˆê°ì¼ ì„ íƒ" readonly>
      </div>
      
      <div>
        <label class="block text-sm font-bold text-zinc-400 mb-2">ìµœëŒ€ ì¸ì› (ì„ íƒ)</label>
        <input type="number" name="deal_max_people" min="1" value="{{ post.deal_max_people or '' }}" placeholder="ì˜ˆ: 10" class="w-full p-3 rounded-lg bg-zinc-900 border border-zinc-700 text-white focus:border-purple-400 focus:outline-none">
      </div>
      
      <div class="flex items-center gap-3">
        <input type="checkbox" name="deal_subscribers_only" id="subscribersOnly" {% if post.deal_subscribers_only %}checked{% endif %} class="w-5 h-5 rounded bg-zinc-800 border-zinc-600 text-purple-500 focus:ring-purple-500">
        <label for="subscribersOnly" class="text-sm text-zinc-300">êµ¬ë…ìë§Œ ì‹ ì²­ ê°€ëŠ¥</label>
      </div>
    </div>
    {% endif %}

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ì œëª©</label>
      <input type="text" name="title" required value="{{ post.title }}" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 md:p-4 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-base focus:border-[#a3e635] focus:outline-none">
    </div>

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ë‚´ìš©</label>
      <textarea name="content" required rows="8" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 md:p-4 rounded-lg bg-zinc-900 border border-zinc-700 text-white text-base focus:border-[#a3e635] focus:outline-none resize-none">{{ post.content }}</textarea>
    </div>

    <div>
      <label class="block text-sm font-bold text-zinc-400 mb-2">ì´ë¯¸ì§€ ì²¨ë¶€ {% if post.category in ['revenue', 'deal'] %}<span class="text-red-400">*í•„ìˆ˜</span>{% endif %}</label>
      <div id="imagePreview" class="flex flex-wrap gap-2 mb-3"></div>
      <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg border border-zinc-700 transition text-sm">
        <i class="fas fa-image"></i><span>ì´ë¯¸ì§€ ì¶”ê°€</span>
        <input type="file" accept="image/*" multiple class="hidden" onchange="uploadImages(this)">
      </label>
      <input type="hidden" name="images_json" id="imagesJson" value='{{ post.images_json }}'>
    </div>

    <div class="flex gap-3 pt-2 md:pt-4">
      <button type="submit" class="flex-1 bg-[#a3e635] text-black font-black py-3 md:py-4 rounded-lg hover:bg-white transition text-sm md:text-base">ìˆ˜ì •í•˜ê¸°</button>
      <a href="/community/{{ post.id }}" class="flex-1 bg-zinc-800 text-white font-bold py-3 md:py-4 rounded-lg hover:bg-zinc-700 transition text-center text-sm md:text-base">ì·¨ì†Œ</a>
    </div>

  </form>

</div>

<script>
let uploadedImages = JSON.parse(document.getElementById('imagesJson').value || '[]');
updateImagePreview();

async function uploadImages(input) {
  for (let file of input.files) {
    const formData = new FormData();
    formData.append('file', file);
    try {
      const res = await fetch('/api/upload_public', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.ok) { uploadedImages.push(data.url); updateImagePreview(); }
    } catch (e) { console.error('Upload error:', e); }
  }
  input.value = '';
}

function updateImagePreview() {
  const preview = document.getElementById('imagePreview');
  preview.innerHTML = uploadedImages.map((url, i) => `
    <div class="relative">
      <img src="${url}" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg border border-zinc-700">
      <button type="button" onclick="removeImage(${i})" class="absolute -top-2 -right-2 w-5 h-5 md:w-6 md:h-6 bg-red-500 rounded-full text-white text-xs font-bold">Ã—</button>
    </div>
  `).join('');
  document.getElementById('imagesJson').value = JSON.stringify(uploadedImages);
}

function removeImage(index) { uploadedImages.splice(index, 1); updateImagePreview(); }

function validateForm() {
  const category = '{{ post.category }}';
  if ((category === 'revenue' || category === 'deal') && uploadedImages.length === 0) {
    showAlert('ì´ë¯¸ì§€ í•„ìˆ˜', 'ìˆ˜ìµì¸ì¦/ê³µêµ¬/í˜‘ì°¬ ê¸€ì€ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì•¼ í•©ë‹ˆë‹¤.', 'ğŸ“¸');
    return false;
  }
  return true;
}

// Flatpickr ë‹¬ë ¥
{% if post.category == 'deal' %}
flatpickr("#deadlinePicker", {
  locale: "ko",
  enableTime: true,
  dateFormat: "Y-m-d H:i",
  minDate: "today",
  disableMobile: true
});
{% endif %}
</script>

{% endblock %}