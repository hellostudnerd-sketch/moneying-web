{% extends "admin_base.html" %}
{% block title %}카테고리 관리 - MONEYING Admin{% endblock %}
{% block page_title %}카테고리 관리{% endblock %}
{% block page_desc %}갤러리 카테고리를 추가/관리합니다.{% endblock %}

{% block content_admin %}

<!-- 카테고리 추가 폼 -->
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 mb-8">
  <h2 class="font-bold text-lg mb-4">새 카테고리 추가</h2>
  <form method="POST" action="/admin/categories/add" class="flex gap-4 items-center" id="categoryAddForm">
    <div class="flex-1">
      <input type="text" name="name" id="catNameInput" required placeholder="예: 패션, Food, 리빙용품"
             class="w-full bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-white focus:border-[#a3e635] focus:outline-none">
      <input type="hidden" name="key" id="catKeyInput">
    </div>
    <button type="submit" class="px-6 py-3 bg-[#a3e635] text-black font-black rounded-xl hover:bg-white transition whitespace-nowrap">
      + 추가
    </button>
  </form>
  <p class="text-xs text-zinc-500 mt-2">한글/영문 모두 가능</p>
</div>

<!-- 카테고리 목록 -->
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
  <div class="flex items-center justify-between px-5 py-4 border-b border-zinc-800">
    <div class="font-black">카테고리 목록</div>
    <div class="text-zinc-400 text-sm">{{ categories|length }}개</div>
  </div>
  
  <table class="w-full">
    <thead class="bg-zinc-800/50">
      <tr>
        <th class="px-6 py-4 text-left text-xs font-bold text-zinc-500 uppercase">카테고리</th>
        <th class="px-6 py-4 text-left text-xs font-bold text-zinc-500 uppercase">상태</th>
        <th class="px-6 py-4 text-right text-xs font-bold text-zinc-500 uppercase">액션</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-zinc-800/70">
      {% for cat in categories %}
        <tr class="hover:bg-zinc-800/30 transition" id="row-{{ cat.id }}">
          <td class="px-6 py-4">
            <span class="font-bold text-white cat-name" id="name-{{ cat.id }}">{{ cat.name }}</span>
            <input type="text" id="edit-{{ cat.id }}" value="{{ cat.name }}" class="hidden w-full bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white focus:border-[#a3e635] focus:outline-none">
          </td>
          <td class="px-6 py-4">
            <button onclick="toggleCategory({{ cat.id }})" id="toggle-{{ cat.id }}"
                    class="px-3 py-1 rounded-full text-xs font-bold transition
                           {% if cat.is_active %}bg-green-500/10 text-green-400 border border-green-500/20{% else %}bg-zinc-500/10 text-zinc-400 border border-zinc-500/20{% endif %}">
              {{ "활성" if cat.is_active else "비활성" }}
            </button>
          </td>
          <td class="px-6 py-4 text-right">
            {% if not cat.is_system %}
              <div class="flex gap-2 justify-end">
                <button onclick="editCategory({{ cat.id }})" id="editBtn-{{ cat.id }}" class="text-[#a3e635] hover:underline text-sm font-bold">수정</button>
                <button onclick="saveCategory({{ cat.id }})" id="saveBtn-{{ cat.id }}" class="hidden text-blue-400 hover:underline text-sm font-bold">저장</button>
                <button onclick="cancelEdit({{ cat.id }})" id="cancelBtn-{{ cat.id }}" class="hidden text-zinc-400 hover:underline text-sm font-bold">취소</button>
                <button onclick="deleteCategory({{ cat.id }}, '{{ cat.name }}')" id="deleteBtn-{{ cat.id }}" class="text-red-400 hover:underline text-sm font-bold">삭제</button>
              </div>
            {% else %}
              <span class="text-zinc-600 text-sm">-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>

document.getElementById('categoryAddForm').addEventListener('submit', function(e) {
  const name = document.getElementById('catNameInput').value.trim();
  const key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_가-힣]/g, '');
  document.getElementById('catKeyInput').value = key;
});
  
function toggleCategory(id) {
  fetch(`/admin/categories/${id}/toggle`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        const btn = document.getElementById(`toggle-${id}`);
        if (data.is_active) {
          btn.textContent = '활성';
          btn.className = 'px-3 py-1 rounded-full text-xs font-bold transition bg-green-500/10 text-green-400 border border-green-500/20';
        } else {
          btn.textContent = '비활성';
          btn.className = 'px-3 py-1 rounded-full text-xs font-bold transition bg-zinc-500/10 text-zinc-400 border border-zinc-500/20';
        }
      }
    });
}
function editCategory(id) {
  document.getElementById('name-' + id).classList.add('hidden');
  document.getElementById('edit-' + id).classList.remove('hidden');
  document.getElementById('editBtn-' + id).classList.add('hidden');
  document.getElementById('saveBtn-' + id).classList.remove('hidden');
  document.getElementById('cancelBtn-' + id).classList.remove('hidden');
  document.getElementById('deleteBtn-' + id).classList.add('hidden');
  document.getElementById('edit-' + id).focus();
}

function cancelEdit(id) {
  document.getElementById('name-' + id).classList.remove('hidden');
  document.getElementById('edit-' + id).classList.add('hidden');
  document.getElementById('editBtn-' + id).classList.remove('hidden');
  document.getElementById('saveBtn-' + id).classList.add('hidden');
  document.getElementById('cancelBtn-' + id).classList.add('hidden');
  document.getElementById('deleteBtn-' + id).classList.remove('hidden');
}

function saveCategory(id) {
  const newName = document.getElementById('edit-' + id).value.trim();
  if (!newName) {
    alert('카테고리 이름을 입력하세요.');
    return;
  }
  
  fetch(`/admin/categories/${id}/update`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      document.getElementById('name-' + id).textContent = newName;
      cancelEdit(id);
    } else {
      alert('수정 실패: ' + (data.error || ''));
    }
  });
}
function deleteCategory(id, name) {
  if (!confirm(`'${name}' 카테고리를 삭제하시겠습니까?`)) return;
  
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/admin/categories/${id}/delete`;
  document.body.appendChild(form);
  form.submit();
}
</script>

{% endblock %}
