{% extends "admin_base.html" %}
{% block title %}ê°¤ëŸ¬ë¦¬ ëŒ€ëŸ‰ë“±ë¡ - MONEYING{% endblock %}
{% block page_title %}ğŸ“¦ ê°¤ëŸ¬ë¦¬ ëŒ€ëŸ‰ë“±ë¡{% endblock %}
{% block page_desc %}CSV íŒŒì¼ë¡œ ì—¬ëŸ¬ ê²Œì‹œë¬¼ì„ í•œë²ˆì— ë“±ë¡í•˜ì„¸ìš”{% endblock %}

{% block content_admin %}

<!-- ì•ˆë‚´ -->
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 mb-6">
  <h3 class="font-bold text-white mb-4">ğŸ“‹ CSV íŒŒì¼ í˜•ì‹</h3>
  <div class="bg-black/50 rounded-xl p-4 font-mono text-sm text-zinc-400 overflow-x-auto">
    <div class="text-zinc-500 mb-2"># ì²« ì¤„ì€ í—¤ë” (í•„ìˆ˜)</div>
    <div class="text-[#a3e635]">title,category,video_url1,video_url2,video_url3,coupang_url,is_free</div>
    <div>ë¯¸ë‹ˆì„ í’ê¸°,ë¦¬ë¹™,https://tiktok.com/...,https://instagram.com/...,,https://coupang.com/...,0</div>
    <div>ë‹¤ì´ì–´íŠ¸ìŒë£Œ,í‘¸ë“œ,https://tiktok.com/...,,https://xiaohongshu.com/...,https://coupang.com/...,1</div>
    <div>LEDì¡°ëª…,ë¦¬ë¹™,https://tiktok.com/...,,,https://coupang.com/...,0</div>
  </div>
  
  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
    <div>
      <h4 class="font-bold text-zinc-300 mb-2">í•„ë“œ ì„¤ëª…</h4>
      <ul class="text-zinc-500 space-y-1">
        <li><span class="text-white">title</span> - ì œëª© (í•„ìˆ˜)</li>
        <li><span class="text-white">category</span> - ì¹´í…Œê³ ë¦¬ (ë·°í‹°/ë¦¬ë¹™/í‘¸ë“œ/íŒ¨ì…˜/ìœ¡ì•„/ê¸°íƒ€)</li>
        <li><span class="text-white">video_url1</span> - ì˜ìƒ ë§í¬ 1</li>
        <li><span class="text-white">video_url2</span> - ì˜ìƒ ë§í¬ 2 (ì„ íƒ)</li>
        <li><span class="text-white">video_url3</span> - ì˜ìƒ ë§í¬ 3 (ì„ íƒ)</li>
        <li><span class="text-white">coupang_url</span> - ì¿ íŒ¡ ì œí’ˆ ë§í¬</li>
        <li><span class="text-white">is_free</span> - ë¬´ë£Œê³µê°œ (1=ë¬´ë£Œ, 0=ìœ ë£Œ)</li>
      </ul>
    </div>
    <div>
      <h4 class="font-bold text-zinc-300 mb-2">ì£¼ì˜ì‚¬í•­</h4>
      <ul class="text-zinc-500 space-y-1">
        <li>â€¢ UTF-8 ì¸ì½”ë”©ìœ¼ë¡œ ì €ì¥í•˜ì„¸ìš”</li>
        <li>â€¢ ì´ë¯¸ì§€ëŠ” ë‚˜ì¤‘ì— ê°œë³„ ì¶”ê°€</li>
        <li>â€¢ ì‰¼í‘œê°€ í¬í•¨ëœ ë‚´ìš©ì€ "ë”°ì˜´í‘œ"ë¡œ ê°ì‹¸ê¸°</li>
        <li>â€¢ ë¹ˆ URLì€ ë¹„ì›Œë‘ë©´ ë©ë‹ˆë‹¤</li>
      </ul>
    </div>
  </div>
</div>

<!-- ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ -->
<div class="mb-6">
  <a href="/admin/gallery/bulk/sample" class="inline-flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 rounded-lg transition">
    <i class="fas fa-download"></i> ìƒ˜í”Œ CSV ë‹¤ìš´ë¡œë“œ
  </a>
</div>

<!-- ì—…ë¡œë“œ í¼ -->
<form id="bulkForm" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6">
  <div class="mb-6">
    <label class="block text-sm font-bold text-zinc-400 mb-2">CSV íŒŒì¼ ì„ íƒ</label>
    <div id="dropZone" class="border-2 border-dashed border-zinc-700 rounded-xl p-10 text-center hover:border-[#c4ff00] transition cursor-pointer">
      <input type="file" name="csv_file" id="csvFile" accept=".csv" class="hidden" required>
      <i class="fas fa-file-csv text-4xl text-zinc-600 mb-4"></i>
      <p class="text-zinc-400 mb-2">í´ë¦­í•˜ê±°ë‚˜ CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
      <p id="fileName" class="text-[#c4ff00] font-bold hidden"></p>
    </div>
  </div>
  
  <button type="submit" id="submitBtn" class="w-full bg-[#c4ff00] text-black font-bold py-4 rounded-xl hover:bg-white transition">
    <i class="fas fa-upload mr-2"></i> ëŒ€ëŸ‰ ë“±ë¡í•˜ê¸°
  </button>
</form>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-8 max-w-md mx-4 text-center">
    <div id="resultIcon" class="text-6xl mb-4">âœ…</div>
    <h3 id="resultTitle" class="text-2xl font-black text-white mb-2">ë“±ë¡ ì™„ë£Œ!</h3>
    <p id="resultMessage" class="text-zinc-400 mb-6"></p>
    <div class="flex gap-3">
      <button onclick="closeResultModal()" class="flex-1 py-3 rounded-xl font-bold bg-zinc-800 text-white hover:bg-zinc-700 transition">ë‹«ê¸°</button>
      <a href="/admin/gallery" class="flex-1 py-3 rounded-xl font-bold bg-[#c4ff00] text-black hover:bg-white transition text-center">ê°¤ëŸ¬ë¦¬ í™•ì¸</a>
    </div>
  </div>
</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('csvFile');
const fileName = document.getElementById('fileName');
const bulkForm = document.getElementById('bulkForm');
const submitBtn = document.getElementById('submitBtn');

dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('border-[#c4ff00]', 'bg-[#c4ff00]/5');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('border-[#c4ff00]', 'bg-[#c4ff00]/5');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('border-[#c4ff00]', 'bg-[#c4ff00]/5');
  if (e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    showFileName(e.dataTransfer.files[0].name);
  }
});

fileInput.addEventListener('change', (e) => {
  if (e.target.files.length) {
    showFileName(e.target.files[0].name);
  }
});

function showFileName(name) {
  fileName.textContent = 'ğŸ“„ ' + name;
  fileName.classList.remove('hidden');
}

// í¼ ì œì¶œ ì²˜ë¦¬
bulkForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!fileInput.files.length) {
    showResult('error', 'íŒŒì¼ ì„ íƒ í•„ìš”', 'ì—…ë¡œë“œí•  CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ì—…ë¡œë“œ ì¤‘...';
  
  const formData = new FormData();
  formData.append('csv_file', fileInput.files[0]);
  
  try {
    const res = await fetch('/admin/gallery/bulk/upload', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    
    if (data.ok) {
      showResult('success', 'ë“±ë¡ ì™„ë£Œ!', `ì´ ${data.count}ê°œì˜ ê²Œì‹œë¬¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    } else {
      showResult('error', 'ì˜¤ë¥˜ ë°œìƒ', data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (err) {
    showResult('error', 'ì—…ë¡œë“œ ì‹¤íŒ¨', err.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> ëŒ€ëŸ‰ ë“±ë¡í•˜ê¸°';
  }
});

function showResult(type, title, message) {
  document.getElementById('resultIcon').textContent = type === 'success' ? 'âœ…' : 'âŒ';
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultMessage').textContent = message;
  document.getElementById('resultModal').classList.remove('hidden');
  document.getElementById('resultModal').classList.add('flex');
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModal').classList.remove('flex');
}

document.getElementById('resultModal').addEventListener('click', function(e) {
  if (e.target === this) closeResultModal();
});
</script>

{% endblock %}