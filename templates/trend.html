{% extends "base.html" %}
{% block title %}íŠ¸ë Œë“œ ì„¼í„° - MONEYING{% endblock %}

{% block head_extra %}
<style>
.video-card {
  background: rgba(24,24,27,0.8);
  border: 1px solid rgba(63,63,70,0.5);
  transition: all 0.3s;
}
.video-card:hover {
  border-color: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}
.video-card:hover img {
  filter: brightness(0.7);
}
.category-btn {
  background: rgba(39, 39, 42, 0.5);
  border: 1px solid rgba(255,255,255,0.1);
  color: #a1a1aa;
  transition: all 0.2s;
}
.category-btn:hover {
  background: rgba(63, 63, 70, 0.6);
  color: #fff;
}
.category-btn.active {
  background: #fff;
  border-color: #fff;
  color: #000;
  font-weight: 700;
}
.views-badge {
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
}
.bookmark-btn {
  transition: all 0.2s;
}
.bookmark-btn:hover {
  transform: scale(1.1);
}
.bookmark-btn.active {
  color: #ef4444;
}
.hot-badge {
  background: linear-gradient(135deg, #ff6b35, #f7931e);
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}
.modal-backdrop {
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(8px);
}
.analysis-card {
  background: rgba(39,39,42,0.6);
  border: 1px solid rgba(255,255,255,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  
  <!-- í—¤ë” -->
  <div class="mb-8">
    <h1 class="text-3xl md:text-4xl font-black">
  íŠ¸ë Œë“œ <span class="text-white">Center</span>
</h1>
    <p class="text-zinc-400 mt-2">ì§€ê¸ˆ ë­ê°€ í„°ì§€ê³  ìˆëŠ”ì§€ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
  </div>

  <!-- ê²€ìƒ‰ -->
  <div class="mb-8">
    <div class="flex gap-2 md:gap-3">
      <input type="text" id="searchInput" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰(ì˜ˆ: ì‚´ë¦¼í…œ,ì´ì¼€ì•„)" 
             class="flex-1 min-w-0 bg-zinc-900 border border-zinc-700 rounded-md px-4 py-2 text-white text-sm md:text-base focus:border-zinc-500 focus:outline-none">
      <button onclick="searchVideos()" class="shrink-0 bg-[#c4ff00] text-black font-bold px-4 py-2 rounded-md hover:bg-white transition text-sm">
        <i class="fas fa-search md:mr-2"></i><span class="hidden md:inline">ê²€ìƒ‰</span>
      </button>
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
  <div class="mb-8 flex flex-wrap gap-2">
    <button onclick="loadTrending()" class="category-btn active px-4 py-2 rounded-full text-sm" data-category="trending">
      ğŸ”¥ ê¸‰ìƒìŠ¹
    </button>
    <button onclick="loadCategory('10')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="10">
      ğŸµ ìŒì•…
    </button>
    <button onclick="loadCategory('20')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="20">
      ğŸ® ê²Œì„
    </button>
    <button onclick="loadCategory('22')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="22">
      ğŸ‘¥ ì‚¬ëŒ/ë¸”ë¡œê·¸
    </button>
    <button onclick="loadCategory('23')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="23">
      ğŸ¬ ì½”ë¯¸ë””
    </button>
    <button onclick="loadCategory('24')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="24">
      ğŸ­ ì—”í„°í…Œì¸ë¨¼íŠ¸
    </button>
    <button onclick="loadCategory('25')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="25">
      ğŸ“° ë‰´ìŠ¤
    </button>
    <button onclick="loadCategory('26')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="26">
      ğŸ¨ ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼
    </button>
    <button onclick="loadCategory('28')" class="category-btn px-4 py-2 rounded-full text-sm text-zinc-300" data-category="28">
      ğŸ”¬ ê³¼í•™ê¸°ìˆ 
    </button>
  </div>

  <!-- ë¡œë”© -->
  <div id="loading" class="hidden text-center py-20">
    <div class="inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
    <p class="text-zinc-400 mt-4">ì˜ìƒ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

  <!-- ê²°ê³¼ í—¤ë” -->
<div id="resultHeader" class="mb-6 flex items-center justify-between">
  <h2 class="text-xl font-bold"><span id="resultTitle">ğŸ”¥ ê¸‰ìƒìŠ¹ ì˜ìƒ</span></h2>
  <div class="flex items-center gap-3">
    <button id="excelDownloadBtn" onclick="exportTrendToExcel()" class="hidden bg-[#c4ff00] text-black font-bold px-3 py-1.5 rounded-lg hover:bg-white transition text-sm flex items-center gap-1">
      <i class="fas fa-file-excel"></i> <span class="hidden md:inline">ì—‘ì…€</span>
    </button>
    <button id="showBookmarksBtn" onclick="showBookmarkedVideos()" class="text-zinc-400 hover:text-white text-sm flex items-center gap-1">
      <i class="fas fa-heart"></i> <span id="bookmarkCount">0</span>
    </button>
    <span id="resultCount" class="text-zinc-500 text-sm"></span>
  </div>
</div>

  <!-- ì˜ìƒ ê·¸ë¦¬ë“œ -->
  <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    <!-- ì˜ìƒ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë“¤ì–´ê° -->
  </div>

  <!-- ë” ë³´ê¸° ë²„íŠ¼ -->
  <div id="loadMoreWrapper" class="hidden text-center mt-8">
    <button id="loadMoreBtn" onclick="loadMore()" class="bg-zinc-800 hover:bg-zinc-700 text-white font-bold px-8 py-4 rounded-xl border border-zinc-700 transition">
      <i class="fas fa-plus mr-2"></i>ë” ë³´ê¸°
    </button>
  </div>

  <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
<div id="errorMsg" class="hidden text-center py-20">
  <div class="text-5xl mb-4">ğŸ˜¢</div>
  <p class="text-zinc-400">ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</p>
</div>

<!-- ë¶„ì„ ëª¨ë‹¬ -->
<div id="analysisModal" class="fixed inset-0 z-[999] hidden items-center justify-center modal-backdrop">
  <div id="analysisBox" class="bg-zinc-950 w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4 rounded-2xl border border-zinc-800 shadow-2xl">
    <!-- í—¤ë” -->
    <div class="sticky top-0 bg-zinc-950 border-b border-zinc-800 p-4 flex items-center justify-between">
      <h3 class="text-lg font-bold text-white">ì˜ìƒ ë¶„ì„</h3>
      <button onclick="closeAnalysisModal()" class="text-zinc-400 hover:text-white text-2xl">&times;</button>
    </div>
    
    <!-- ì¸ë„¤ì¼ + ê¸°ë³¸ ì •ë³´ -->
    <div class="p-4">
      <div class="flex gap-4 mb-6">
        <img id="modalThumb" src="" class="w-40 aspect-video object-cover rounded-lg">
        <div class="flex-1 min-w-0">
          <h4 id="modalTitle" class="text-white font-bold line-clamp-2 mb-2"></h4>
          <p id="modalChannel" class="text-zinc-400 text-sm mb-1"></p>
          <p id="modalDate" class="text-zinc-500 text-xs"></p>
        </div>
      </div>
      
      <!-- ê¸°ë³¸ í†µê³„ -->
      <div class="analysis-card rounded-xl p-4 mb-4">
        <h5 class="text-white font-bold mb-3 flex items-center gap-2">
          <span class="text-lg">ğŸ“Š</span> ê¸°ë³¸ í†µê³„
        </h5>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="text-center p-3 bg-zinc-800/50 rounded-lg">
            <div id="statViews" class="text-xl font-bold text-white">-</div>
            <div class="text-zinc-500 text-xs">ì¡°íšŒìˆ˜</div>
          </div>
          <div class="text-center p-3 bg-zinc-800/50 rounded-lg">
            <div id="statLikes" class="text-xl font-bold text-white">-</div>
            <div class="text-zinc-500 text-xs">ì¢‹ì•„ìš”</div>
          </div>
          <div class="text-center p-3 bg-zinc-800/50 rounded-lg">
            <div id="statComments" class="text-xl font-bold text-white">-</div>
            <div class="text-zinc-500 text-xs">ëŒ“ê¸€</div>
          </div>
          <div class="text-center p-3 bg-zinc-800/50 rounded-lg">
            <div id="statLikeRate" class="text-xl font-bold text-[#c4ff00]">-</div>
            <div class="text-zinc-500 text-xs">ì¢‹ì•„ìš”ìœ¨</div>
          </div>
        </div>
      </div>
      
      <!-- íƒœê·¸ -->
      <div class="analysis-card rounded-xl p-4 mb-4">
        <h5 class="text-white font-bold mb-3 flex items-center gap-2">
          <span class="text-lg">ğŸ·ï¸</span> ì‚¬ìš© íƒœê·¸
        </h5>
        <div id="tagList" class="flex flex-wrap gap-2">
          <span class="text-zinc-500 text-sm">íƒœê·¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
      </div>
      
      <!-- ì¸ë„¤ì¼ ë¶„ì„ -->
      <div class="analysis-card rounded-xl p-4 mb-4">
        <h5 class="text-white font-bold mb-3 flex items-center gap-2">
          <span class="text-lg">ğŸ–¼ï¸</span> ì¸ë„¤ì¼ ë¶„ì„
          <span class="text-zinc-500 text-xs font-normal">(AI ì°¸ê³ ìš©)</span>
        </h5>
        <div id="thumbAnalysis" class="text-zinc-300 text-sm leading-relaxed">
          <span class="text-zinc-500">ë¶„ì„ ì¤‘...</span>
        </div>
      </div>
      
      <!-- ë²„íŠ¼ -->
      <div class="flex gap-3">
        <a id="modalYoutubeLink" href="" target="_blank" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-xl text-center transition">
          <i class="fab fa-youtube mr-2"></i>YouTubeì—ì„œ ë³´ê¸°
        </a>
        <button id="modalBookmarkBtn" onclick="toggleModalBookmark()" class="bg-zinc-800 hover:bg-zinc-700 text-white font-bold px-6 py-3 rounded-xl transition">
          <i class="fas fa-heart"></i>
        </button>
      </div>
    </div>
  </div>
</div>

</div>

<script>
let nextPageToken = '';
let currentMode = 'trending';
let currentCategory = '';
let currentQuery = '';
let totalVideos = [];
let currentModalVideo = null;

// ===== ë¶ë§ˆí¬ =====
function getTrendBookmarks() {
  try { return JSON.parse(localStorage.getItem('trend_bookmarks') || '[]'); }
  catch { return []; }
}
function saveTrendBookmarks(list) {
  localStorage.setItem('trend_bookmarks', JSON.stringify(list));
  updateBookmarkCount();
}
function isTrendBookmarked(id) {
  return getTrendBookmarks().some(v => v.id === id);
}
function toggleTrendBookmark(video) {
  let bookmarks = getTrendBookmarks();
  const exists = bookmarks.find(v => v.id === video.id);
  if (exists) {
    bookmarks = bookmarks.filter(v => v.id !== video.id);
  } else {
    bookmarks.unshift(video);
  }
  saveTrendBookmarks(bookmarks);
  return !exists;
}
function updateBookmarkCount() {
  const count = getTrendBookmarks().length;
  document.getElementById('bookmarkCount').textContent = count;
  document.getElementById('excelDownloadBtn').classList.toggle('hidden', count === 0);
}

// ===== í¬ë§· =====
function formatViews(num) {
  if (num >= 100000000) return (num / 100000000).toFixed(1) + 'ì–µ';
  if (num >= 10000) return (num / 10000).toFixed(1) + 'ë§Œ';
  if (num >= 1000) return (num / 1000).toFixed(1) + 'ì²œ';
  return num.toString();
}

function formatNumber(num) {
  return num.toLocaleString();
}

// ===== ë Œë”ë§ =====
function renderVideos(videos, append = false) {
  const grid = document.getElementById('videoGrid');
  const html = videos.map(v => {
    const isHot = v.views >= 1000000;
    const isBookmarked = isTrendBookmarked(v.id);
    return `
    <div class="video-card rounded-xl overflow-hidden cursor-pointer" onclick="openAnalysisModal('${v.id}')">
      <div class="relative">
        <img src="${v.thumbnail}" alt="${v.title}" class="w-full aspect-video object-cover">
        ${isHot ? '<div class="hot-badge absolute top-2 left-2 px-2 py-1 rounded text-xs text-white font-bold">ğŸ”¥ HOT</div>' : ''}
        <button onclick="event.stopPropagation(); toggleCardBookmark('${v.id}')" class="bookmark-btn absolute top-2 right-2 w-8 h-8 rounded-lg bg-black/60 flex items-center justify-center ${isBookmarked ? 'active text-red-500' : 'text-white/60 hover:text-red-400'}" data-id="${v.id}">
          <i class="fas fa-heart"></i>
        </button>
        <div class="views-badge absolute bottom-2 right-2 px-2 py-1 rounded text-sm text-white flex items-center gap-1">
          ğŸ‘ ${formatViews(v.views)}
        </div>
      </div>
      <div class="p-4">
        <h3 class="text-base font-bold text-white line-clamp-2 mb-2">${v.title}</h3>
        <div class="flex items-center justify-between text-sm text-zinc-400">
          <span class="truncate">${v.channel}</span>
          <span>${v.published}</span>
        </div>
      </div>
    </div>
  `}).join('');
  
  if (append) {
    grid.innerHTML += html;
  } else {
    grid.innerHTML = html;
  }
  
  document.getElementById('resultCount').textContent = `${totalVideos.length}ê°œ ì˜ìƒ`;
  updateBookmarkCount();
}

function toggleCardBookmark(videoId) {
  const video = totalVideos.find(v => v.id === videoId);
  if (!video) return;
  
  const isNowBookmarked = toggleTrendBookmark(video);
  const btn = document.querySelector(`.bookmark-btn[data-id="${videoId}"]`);
  if (btn) {
    btn.classList.toggle('active', isNowBookmarked);
    btn.classList.toggle('text-red-500', isNowBookmarked);
    btn.classList.toggle('text-white/60', !isNowBookmarked);
  }
}

// ===== ë¶„ì„ ëª¨ë‹¬ =====
async function openAnalysisModal(videoId) {
  const video = totalVideos.find(v => v.id === videoId);
  if (!video) return;
  
  currentModalVideo = video;
  
  // ê¸°ë³¸ ì •ë³´ ì„¸íŒ…
  document.getElementById('modalThumb').src = video.thumbnail;
  document.getElementById('modalTitle').textContent = video.title;
  document.getElementById('modalChannel').textContent = video.channel;
  document.getElementById('modalDate').textContent = video.published;
  document.getElementById('modalYoutubeLink').href = `https://www.youtube.com/watch?v=${video.id}`;
  
  // í†µê³„
  document.getElementById('statViews').textContent = formatViews(video.views);
  document.getElementById('statLikes').textContent = formatViews(video.likes || 0);
  document.getElementById('statComments').textContent = '-';
  const likeRate = video.views > 0 ? ((video.likes || 0) / video.views * 100).toFixed(2) : 0;
  document.getElementById('statLikeRate').textContent = likeRate + '%';
  
  // ë¶ë§ˆí¬ ë²„íŠ¼ ìƒíƒœ
  const isBookmarked = isTrendBookmarked(video.id);
  const modalBtn = document.getElementById('modalBookmarkBtn');
  modalBtn.classList.toggle('text-red-500', isBookmarked);
  modalBtn.classList.toggle('bg-red-500/20', isBookmarked);
  
  // íƒœê·¸/ì¸ë„¤ì¼ ë¶„ì„ ì´ˆê¸°í™”
  document.getElementById('tagList').innerHTML = '<span class="text-zinc-500 text-sm">íƒœê·¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>';
  document.getElementById('thumbAnalysis').innerHTML = '<span class="text-zinc-500">ë¶„ì„ ì¤‘...</span>';
  
  // ëª¨ë‹¬ í‘œì‹œ
  const modal = document.getElementById('analysisModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  document.body.style.overflow = 'hidden';
  
  // ìƒì„¸ ì •ë³´ ë¡œë“œ
  loadVideoDetails(video.id);
}

async function loadVideoDetails(videoId) {
  try {
    const res = await fetch(`/api/youtube/video/${videoId}`);
    const data = await res.json();
    
    if (data.ok) {
      // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
      if (data.comments !== undefined) {
        document.getElementById('statComments').textContent = formatViews(data.comments);
      }
      
      // íƒœê·¸ í‘œì‹œ
      if (data.tags && data.tags.length > 0) {
        document.getElementById('tagList').innerHTML = data.tags.slice(0, 15).map(tag => 
          `<span class="px-2 py-1 bg-zinc-800 text-zinc-300 text-xs rounded-full">#${tag}</span>`
        ).join('');
      } else {
        document.getElementById('tagList').innerHTML = '<span class="text-zinc-500 text-sm">íƒœê·¸ ì—†ìŒ</span>';
      }
      
      // ì¸ë„¤ì¼ ë¶„ì„ (ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜)
      analyzeThumbSimple(currentModalVideo);
    }
  } catch (e) {
    console.error('Video details error:', e);
    document.getElementById('tagList').innerHTML = '<span class="text-zinc-500 text-sm">íƒœê·¸ ì •ë³´ ì—†ìŒ</span>';
    analyzeThumbSimple(currentModalVideo);
  }
}

function analyzeThumbSimple(video) {
  // ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ ë¶„ì„
  const title = video.title || '';
  const analyses = [];
  
  // ì œëª© ë¶„ì„
  if (title.includes('?') || title.includes('!')) {
    analyses.push('â€¢ ê°ì •ì„ ìê·¹í•˜ëŠ” ë¬¸ì¥ë¶€í˜¸ ì‚¬ìš©');
  }
  if (/\d+/.test(title)) {
    analyses.push('â€¢ ìˆ«ìë¥¼ í™œìš©í•œ êµ¬ì²´ì  ì •ë³´ ì œê³µ');
  }
  if (title.length < 30) {
    analyses.push('â€¢ ì§§ê³  ê°„ê²°í•œ ì œëª©ìœ¼ë¡œ ê°€ë…ì„± ë†’ìŒ');
  } else if (title.length > 50) {
    analyses.push('â€¢ ê¸´ ì œëª©ìœ¼ë¡œ ì •ë³´ëŸ‰ ê·¹ëŒ€í™”');
  }
  
  // ì¡°íšŒìˆ˜ ê¸°ë°˜
  if (video.views >= 10000000) {
    analyses.push('â€¢ 1000ë§Œ+ ì¡°íšŒìˆ˜, ëŒ€ì¤‘ì  ê´€ì‹¬ì‚¬ ë°˜ì˜');
  } else if (video.views >= 1000000) {
    analyses.push('â€¢ 100ë§Œ+ ì¡°íšŒìˆ˜, íŠ¸ë Œë“œ ì½˜í…ì¸ ');
  }
  
  // ì¢‹ì•„ìš”ìœ¨ ê¸°ë°˜
  const likeRate = video.views > 0 ? (video.likes || 0) / video.views * 100 : 0;
  if (likeRate >= 5) {
    analyses.push('â€¢ ë†’ì€ ì¢‹ì•„ìš”ìœ¨ (5%+), ì‹œì²­ì ë§Œì¡±ë„ ë†’ìŒ');
  } else if (likeRate >= 3) {
    analyses.push('â€¢ í‰ê·  ì¢‹ì•„ìš”ìœ¨, ì•ˆì •ì ì¸ ë°˜ì‘');
  }
  
  if (analyses.length === 0) {
    analyses.push('â€¢ ì¼ë°˜ì ì¸ í˜•ì‹ì˜ ì˜ìƒ');
  }
  
  document.getElementById('thumbAnalysis').innerHTML = analyses.join('<br>');
}

function closeAnalysisModal() {
  const modal = document.getElementById('analysisModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  document.body.style.overflow = '';
  currentModalVideo = null;
}

function toggleModalBookmark() {
  if (!currentModalVideo) return;
  const isNowBookmarked = toggleTrendBookmark(currentModalVideo);
  
  const modalBtn = document.getElementById('modalBookmarkBtn');
  modalBtn.classList.toggle('text-red-500', isNowBookmarked);
  modalBtn.classList.toggle('bg-red-500/20', isNowBookmarked);
  
  const cardBtn = document.querySelector(`.bookmark-btn[data-id="${currentModalVideo.id}"]`);
  if (cardBtn) {
    cardBtn.classList.toggle('active', isNowBookmarked);
    cardBtn.classList.toggle('text-red-500', isNowBookmarked);
    cardBtn.classList.toggle('text-white/60', !isNowBookmarked);
  }
}

// ===== ì°œí•œ ì˜ìƒ ë³´ê¸° =====
function showBookmarkedVideos() {
  const bookmarks = getTrendBookmarks();
  if (bookmarks.length === 0) {
    alert('ì°œí•œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  setActiveCategory('');
  document.getElementById('resultTitle').textContent = 'â¤ï¸ ì°œí•œ ì˜ìƒ';
  totalVideos = bookmarks;
  renderVideos(bookmarks);
  document.getElementById('loadMoreWrapper').classList.add('hidden');
}

// ===== ì—‘ì…€ ë‹¤ìš´ë¡œë“œ =====
function exportTrendToExcel() {
  const bookmarks = getTrendBookmarks();
  if (bookmarks.length === 0) {
    alert('ì°œí•œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  let csv = '\uFEFFì œëª©,ì±„ë„,ì¡°íšŒìˆ˜,ì¢‹ì•„ìš”,YouTubeë§í¬\n';
  bookmarks.forEach(v => {
    const title = (v.title || '').replace(/,/g, ' ').replace(/"/g, "'");
    const channel = (v.channel || '').replace(/,/g, ' ');
    const link = `https://www.youtube.com/watch?v=${v.id}`;
    csv += `"${title}","${channel}","${v.views}","${v.likes || 0}","${link}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `moneying_íŠ¸ë Œë“œ_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== ì¹´í…Œê³ ë¦¬/ë¡œë”© =====
function setActiveCategory(category) {
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('active');
    btn.classList.add('text-zinc-300');
  });
  const activeBtn = document.querySelector(`[data-category="${category}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
    activeBtn.classList.remove('text-zinc-300');
  }
}

function showLoading() {
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('videoGrid').innerHTML = '';
  document.getElementById('errorMsg').classList.add('hidden');
  document.getElementById('loadMoreWrapper').classList.add('hidden');
}

function hideLoading() {
  document.getElementById('loading').classList.add('hidden');
}

function showLoadMore(show) {
  if (show && nextPageToken) {
    document.getElementById('loadMoreWrapper').classList.remove('hidden');
  } else {
    document.getElementById('loadMoreWrapper').classList.add('hidden');
  }
}

// ===== API í˜¸ì¶œ =====
async function loadTrending() {
  currentMode = 'trending';
  currentCategory = '';
  currentQuery = '';
  nextPageToken = '';
  totalVideos = [];
  
  setActiveCategory('trending');
  document.getElementById('resultTitle').textContent = 'ğŸ”¥ ê¸‰ìƒìŠ¹ ì˜ìƒ';
  showLoading();
  
  try {
    const res = await fetch('/api/youtube/trending');
    const data = await res.json();
    hideLoading();
    
    if (data.ok) {
      totalVideos = data.videos;
      nextPageToken = data.nextPageToken || '';
      renderVideos(data.videos);
      showLoadMore(true);
    } else {
      document.getElementById('errorMsg').classList.remove('hidden');
    }
  } catch (e) {
    hideLoading();
    document.getElementById('errorMsg').classList.remove('hidden');
  }
}

async function loadCategory(categoryId) {
  currentMode = 'category';
  currentCategory = categoryId;
  currentQuery = '';
  nextPageToken = '';
  totalVideos = [];
  
  setActiveCategory(categoryId);
  
  const categoryNames = {
    '10': 'ğŸµ ìŒì•…',
    '20': 'ğŸ® ê²Œì„',
    '22': 'ğŸ‘¥ ì‚¬ëŒ/ë¸”ë¡œê·¸',
    '23': 'ğŸ¬ ì½”ë¯¸ë””',
    '24': 'ğŸ­ ì—”í„°í…Œì¸ë¨¼íŠ¸',
    '25': 'ğŸ“° ë‰´ìŠ¤',
    '26': 'ğŸ¨ ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼',
    '28': 'ğŸ”¬ ê³¼í•™ê¸°ìˆ '
  };
  
  document.getElementById('resultTitle').textContent = categoryNames[categoryId] || 'ì¹´í…Œê³ ë¦¬';
  showLoading();
  
  try {
    const res = await fetch(`/api/youtube/category/${categoryId}`);
    const data = await res.json();
    hideLoading();
    
    if (data.ok) {
      totalVideos = data.videos;
      nextPageToken = data.nextPageToken || '';
      renderVideos(data.videos);
      showLoadMore(true);
    } else {
      document.getElementById('errorMsg').classList.remove('hidden');
    }
  } catch (e) {
    hideLoading();
    document.getElementById('errorMsg').classList.remove('hidden');
  }
}

async function searchVideos() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) {
    alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  currentMode = 'search';
  currentCategory = '';
  currentQuery = query;
  nextPageToken = '';
  totalVideos = [];
  
  setActiveCategory('');
  document.getElementById('resultTitle').textContent = `ğŸ” "${query}" ê²€ìƒ‰ ê²°ê³¼`;
  showLoading();
  
  try {
    const res = await fetch(`/api/youtube/search?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    hideLoading();
    
    if (data.ok) {
      totalVideos = data.videos;
      nextPageToken = data.nextPageToken || '';
      renderVideos(data.videos);
      showLoadMore(true);
    } else {
      document.getElementById('errorMsg').classList.remove('hidden');
    }
  } catch (e) {
    hideLoading();
    document.getElementById('errorMsg').classList.remove('hidden');
  }
}

async function loadMore() {
  if (!nextPageToken) return;
  
  const btn = document.getElementById('loadMoreBtn');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
  btn.disabled = true;
  
  let url = '';
  if (currentMode === 'trending') {
    url = `/api/youtube/trending?pageToken=${nextPageToken}`;
  } else if (currentMode === 'category') {
    url = `/api/youtube/category/${currentCategory}?pageToken=${nextPageToken}`;
  } else if (currentMode === 'search') {
    url = `/api/youtube/search?q=${encodeURIComponent(currentQuery)}&pageToken=${nextPageToken}`;
  }
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.ok) {
      totalVideos = [...totalVideos, ...data.videos];
      nextPageToken = data.nextPageToken || '';
      renderVideos(data.videos, true);
      showLoadMore(true);
    }
  } catch (e) {
    console.error(e);
  }
  
  btn.innerHTML = '<i class="fas fa-plus mr-2"></i>ë” ë³´ê¸°';
  btn.disabled = false;
}

// ===== ì´ë²¤íŠ¸ =====
document.getElementById('searchInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') searchVideos();
});

document.getElementById('analysisModal').addEventListener('click', function(e) {
  if (e.target === this) closeAnalysisModal();
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeAnalysisModal();
});

// í˜ì´ì§€ ë¡œë“œ
loadTrending();
updateBookmarkCount();
</script>
{% endblock %}
