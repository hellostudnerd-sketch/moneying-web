{% extends "admin_base.html" %}

{% block page_title %}ê°¤ëŸ¬ë¦¬ ê´€ë¦¬{% endblock %}
{% block page_desc %}ì—…ë¡œë“œ/ìˆ˜ì •/ì‚­ì œë¥¼ ì—¬ê¸°ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.{% endblock %}

{% block page_actions %}
  <div class="flex gap-2">
    <a href="/admin/gallery/bulk"
       class="px-4 py-2 rounded-xl bg-zinc-700 text-white hover:bg-zinc-600 transition font-bold">
      ğŸ“¦ ëŒ€ëŸ‰ë“±ë¡
    </a>
    <a href="{{ url_for('admin_upload') }}"
       class="px-4 py-2 rounded-xl bg-[#a3e635] text-black hover:bg-white transition font-black">
      + ìƒˆ ê²Œì‹œë¬¼
    </a>
  </div>
{% endblock %}

{% block content_admin %}
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 border-b border-zinc-800">
      <div class="flex items-center gap-4">
        <div class="font-black">ê°¤ëŸ¬ë¦¬ ê²Œì‹œë¬¼</div>
        <button id="bulkDeleteBtn" onclick="bulkDelete()" class="hidden px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 text-sm font-bold hover:bg-red-500/30 transition">
          <i class="fas fa-trash mr-1"></i> <span id="selectedCount">0</span>ê°œ ì‚­ì œ
        </button>
      </div>
      <div class="text-zinc-400 text-sm font-bold">ì´ {{ posts|length }}ê°œ</div>
    </div>

    {% if posts|length == 0 %}
      <div class="px-5 py-10 text-center text-zinc-500 font-bold">
        ì•„ì§ ê°¤ëŸ¬ë¦¬ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    {% else %}
      <div class="grid grid-cols-12 text-xs font-black text-zinc-400 border-b border-zinc-800 px-5 py-3">
        <div class="col-span-1">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4 rounded accent-[#c4ff00]">
        </div>
        <div class="col-span-1">ID</div>
        <div class="col-span-2">ì¹´í…Œê³ ë¦¬</div>
        <div class="col-span-4">ì œëª©</div>
        <div class="col-span-2 text-right pr-6">ë“±ë¡ì¼</div>
        <div class="col-span-2 text-right">ê´€ë¦¬</div>
      </div>

      {% for p in posts %}
        <div class="grid grid-cols-12 px-5 py-4 border-b border-zinc-800/60 items-center post-row" data-id="{{ p.id }}">
          <div class="col-span-1">
            <input type="checkbox" class="post-checkbox w-4 h-4 rounded accent-[#c4ff00]" value="{{ p.id }}" onchange="updateSelectedCount()">
          </div>
          <div class="col-span-1 text-zinc-400 font-bold">{{ p.id }}</div>

          <div class="col-span-2">
            <span class="text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700 text-gray-200 font-bold">
              {{ p.category }}
            </span>
          </div>

          <div class="col-span-4 font-bold truncate">{{ p.title }}</div>

          <div class="col-span-2 text-right pr-6 text-zinc-500 text-xs font-bold">
            {{ (p.created_at|string)[:10] }}
          </div>

          <div class="col-span-2 flex justify-end gap-2">
            <a href="{{ url_for('admin_edit', post_id=p.id, next=url_for('admin_gallery')) }}"
               class="px-3 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 transition text-sm font-bold">
              ìˆ˜ì •
            </a>

            <form method="POST" action="{{ url_for('admin_delete', post_id=p.id) }}"
                  onsubmit="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?');">
              <button type="submit"
                      class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-500 transition text-sm font-bold">
                ì‚­ì œ
              </button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

<!-- ì¼ê´„ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="bulkDeleteModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4 text-center">
    <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
    <h3 class="text-xl font-black text-white mb-2">ì¼ê´„ ì‚­ì œ</h3>
    <p class="text-zinc-400 mb-6"><span id="deleteCountText">0</span>ê°œì˜ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="flex gap-3">
      <button onclick="closeBulkDeleteModal()" class="flex-1 py-3 rounded-xl font-bold bg-zinc-800 text-white hover:bg-zinc-700 transition">ì·¨ì†Œ</button>
      <button onclick="confirmBulkDelete()" class="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-400 transition">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm mx-4 text-center">
    <div id="resultIcon" class="text-5xl mb-4">âœ…</div>
    <h3 id="resultTitle" class="text-xl font-black text-white mb-2">ì‚­ì œ ì™„ë£Œ</h3>
    <p id="resultMessage" class="text-zinc-400 mb-6"></p>
    <button onclick="closeResultModal()" class="w-full py-3 rounded-xl font-bold bg-[#c4ff00] text-black hover:bg-white transition">í™•ì¸</button>
  </div>
</div>

<script>
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll');
  const checkboxes = document.querySelectorAll('.post-checkbox');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const checkboxes = document.querySelectorAll('.post-checkbox:checked');
  const count = checkboxes.length;
  const btn = document.getElementById('bulkDeleteBtn');
  const countSpan = document.getElementById('selectedCount');
  
  if (count > 0) {
    btn.classList.remove('hidden');
    countSpan.textContent = count;
  } else {
    btn.classList.add('hidden');
  }
  
  // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
  const allCheckboxes = document.querySelectorAll('.post-checkbox');
  document.getElementById('selectAll').checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
}

function bulkDelete() {
  const checkboxes = document.querySelectorAll('.post-checkbox:checked');
  document.getElementById('deleteCountText').textContent = checkboxes.length;
  document.getElementById('bulkDeleteModal').classList.remove('hidden');
  document.getElementById('bulkDeleteModal').classList.add('flex');
}

function closeBulkDeleteModal() {
  document.getElementById('bulkDeleteModal').classList.add('hidden');
  document.getElementById('bulkDeleteModal').classList.remove('flex');
}

async function confirmBulkDelete() {
  const checkboxes = document.querySelectorAll('.post-checkbox:checked');
  const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
  
  closeBulkDeleteModal();
  
  try {
    const res = await fetch('/admin/gallery/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids })
    });
    const data = await res.json();
    
    if (data.ok) {
      showResult('success', 'ì‚­ì œ ì™„ë£Œ', `${data.count}ê°œì˜ ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
      // ì‚­ì œëœ í–‰ ì œê±°
      ids.forEach(id => {
        const row = document.querySelector(`.post-row[data-id="${id}"]`);
        if (row) row.remove();
      });
      updateSelectedCount();
      document.getElementById('selectAll').checked = false;
    } else {
      showResult('error', 'ì‚­ì œ ì‹¤íŒ¨', data.error);
    }
  } catch (err) {
    showResult('error', 'ì˜¤ë¥˜ ë°œìƒ', err.message);
  }
}

function showResult(type, title, message) {
  document.getElementById('resultIcon').textContent = type === 'success' ? 'âœ…' : 'âŒ';
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultMessage').textContent = message;
  document.getElementById('resultModal').classList.remove('hidden');
  document.getElementById('resultModal').classList.add('flex');
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModal').classList.remove('flex');
}
</script>
{% endblock %}