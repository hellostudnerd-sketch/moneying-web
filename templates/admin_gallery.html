{% extends "admin_base.html" %}

{% block page_title %}ê°¤ëŸ¬ë¦¬ ê´€ë¦¬{% endblock %}
{% block page_desc %}ì—…ë¡œë“œ/ìˆ˜ì •/ì‚­ì œë¥¼ ì—¬ê¸°ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.{% endblock %}

{% block page_actions %}
  <div class="flex gap-2 flex-wrap">
    <a href="/admin/categories"
       class="px-3 md:px-4 py-2 rounded-xl bg-zinc-800 text-white hover:bg-zinc-700 transition font-bold border border-zinc-700 text-sm">
       ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
    </a>
    <a href="/admin/gallery/bulk"
       class="px-3 md:px-4 py-2 rounded-xl bg-zinc-700 text-white hover:bg-zinc-600 transition font-bold text-sm">
       ëŒ€ëŸ‰ë“±ë¡
    </a>
    <a href="{{ url_for('admin_upload') }}"
       class="px-3 md:px-4 py-2 rounded-xl bg-[#a3e635] text-black hover:bg-white transition font-black text-sm">
      + ìƒˆ ê²Œì‹œë¬¼
    </a>
  </div>
{% endblock %}

{% block content_admin %}
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="flex items-center justify-between px-4 md:px-5 py-3 md:py-4 border-b border-zinc-800">
      <div class="flex items-center gap-3 min-w-0">
        <div class="font-black text-sm md:text-base">ê°¤ëŸ¬ë¦¬ ê²Œì‹œë¬¼</div>
        <button id="bulkDeleteBtn" onclick="bulkDelete()" class="hidden px-2 md:px-3 py-1 md:py-1.5 rounded-lg bg-red-500/20 text-red-400 text-xs font-bold hover:bg-red-500/30 transition shrink-0">
          <i class="fas fa-trash mr-1"></i> <span id="selectedCount">0</span>ê°œ ì‚­ì œ
        </button>
      </div>
      <div class="text-zinc-400 text-xs md:text-sm font-bold shrink-0" id="totalCount">ì´ {{ posts|length }}ê°œ</div>
    </div>
    <!-- í•„í„°/ì •ë ¬ ë°” -->
    <div class="flex flex-wrap items-center gap-2 px-4 md:px-5 py-3 border-b border-zinc-800 bg-zinc-900/30">
      <select id="filterUploader" onchange="applyFilter()" class="bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-sm text-white">
        <option value="">ì—…ë¡œë” ì „ì²´</option>
        {% if uploaders is defined %}{% for uid, uname in uploaders.items() %}
        <option value="{{ uid }}">{{ uname }}</option>
        {% endfor %}{% endif %}
      </select>
      <select id="filterCategory" onchange="applyFilter()" class="bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-sm text-white">
        <option value="">ì¹´í…Œê³ ë¦¬ ì „ì²´</option>
        {% if categories is defined %}{% for cat in categories %}<option value="{{ cat.key }}">{{ cat.name }}</option>{% endfor %}{% endif %}
      </select>
      <input type="date" id="filterDateFrom" onchange="applyFilter()" class="bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-sm text-white">
      <span class="text-zinc-500 text-sm">~</span>
      <input type="date" id="filterDateTo" onchange="applyFilter()" class="bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 text-sm text-white">
      <span id="filteredCount" class="text-[#c4ff00] text-xs font-bold ml-2"></span>
    </div>

    {% if posts|length == 0 %}
      <div class="px-5 py-10 text-center text-zinc-500 font-bold">
        ì•„ì§ ê°¤ëŸ¬ë¦¬ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    {% else %}

      <!-- PC í…Œì´ë¸” -->
      <div class="hidden md:block">
        <div class="grid grid-cols-12 text-xs font-black text-zinc-400 border-b border-zinc-800 px-5 py-3">
          <div class="col-span-1">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4 rounded accent-[#c4ff00]">
          </div>
          <div class="col-span-1">ID</div>
          <div class="col-span-2">ì¹´í…Œê³ ë¦¬</div>
          <div class="col-span-3">ì œëª©</div>
          <div class="col-span-1">ì—…ë¡œë”</div>
          <div class="col-span-2 text-right pr-6">ë“±ë¡ì¼</div>
          <div class="col-span-2 text-right">ê´€ë¦¬</div>
        </div>

        {% for p in posts %}
          <div class="grid grid-cols-12 px-5 py-4 border-b border-zinc-800/60 items-center post-row pc-row" data-id="{{ p.id }}" data-uploader="{{ p.uploaded_by or '' }}" data-category="{{ p.category }}" data-date="{{ (p.created_at|string)[:10] }}">
            <div class="col-span-1">
              <input type="checkbox" class="post-checkbox w-4 h-4 rounded accent-[#c4ff00]" value="{{ p.id }}" onchange="updateSelectedCount()">
            </div>
            <div class="col-span-1 text-zinc-400 font-bold">{{ p.id }}</div>
            <div class="col-span-2">
              <span class="text-xs px-2 py-1 rounded bg-zinc-800 border border-zinc-700 text-gray-200 font-bold">{{ p.category }}</span>
            </div>
            <div class="col-span-3 font-bold truncate">{{ p.title }}</div>
            <div class="col-span-1 text-xs">{% if p.uploaded_by and uploaders.get(p.uploaded_by) %}<span class="text-purple-400 font-bold">{{ uploaders[p.uploaded_by] }}</span>{% else %}<span class="text-zinc-600">-</span>{% endif %}</div>
            <div class="col-span-2 text-right pr-6 text-zinc-500 text-xs font-bold">{{ (p.created_at|string)[:10] }}</div>
            <div class="col-span-2 flex justify-end gap-2">
              <a href="{{ url_for('admin_edit', post_id=p.id, next=url_for('admin_gallery')) }}"
                 class="px-3 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 transition text-sm font-bold">ìˆ˜ì •</a>
              <form method="POST" action="{{ url_for('admin_delete', post_id=p.id) }}" onsubmit="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?');">
                <button type="submit" class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-500 transition text-sm font-bold">ì‚­ì œ</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- ëª¨ë°”ì¼ ì¹´ë“œ -->
      <div class="md:hidden divide-y divide-zinc-800/50">
        <div class="px-4 py-2 flex items-center gap-2 border-b border-zinc-800">
          <input type="checkbox" id="selectAllMobile" onchange="toggleSelectAll()" class="w-4 h-4 rounded accent-[#c4ff00]">
          <span class="text-xs text-zinc-500">ì „ì²´ ì„ íƒ</span>
        </div>
        {% for p in posts %}
          <div class="px-4 py-3 post-row mobile-row" data-id="{{ p.id }}" data-uploader="{{ p.uploaded_by or '' }}" data-category="{{ p.category }}" data-date="{{ (p.created_at|string)[:10] }}">
            <div class="flex items-start gap-3">
              <input type="checkbox" class="post-checkbox w-4 h-4 rounded accent-[#c4ff00] mt-1 shrink-0" value="{{ p.id }}" onchange="updateSelectedCount()">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-[11px] px-1.5 py-0.5 rounded bg-zinc-800 border border-zinc-700 text-gray-300 font-bold shrink-0">{{ p.category }}</span>
                  <span class="font-bold text-sm text-white truncate">{{ p.title }}</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-zinc-500 text-xs">#{{ p.id }}{% if p.uploaded_by and uploaders.get(p.uploaded_by) %} Â· <span class="text-purple-400">{{ uploaders[p.uploaded_by] }}</span>{% endif %} Â· {{ (p.created_at|string)[:10] }}</span>
                  <div class="flex gap-2">
                    <a href="{{ url_for('admin_edit', post_id=p.id, next=url_for('admin_gallery')) }}"
                       class="px-2.5 py-1 rounded-lg bg-zinc-800 hover:bg-zinc-700 active:bg-zinc-600 transition text-xs font-bold">ìˆ˜ì •</a>
                    <form method="POST" action="{{ url_for('admin_delete', post_id=p.id) }}" onsubmit="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?');">
                      <button type="submit" class="px-2.5 py-1 rounded-lg bg-red-600 hover:bg-red-500 active:bg-red-700 transition text-xs font-bold">ì‚­ì œ</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    {% endif %}
  </div>

<!-- ì¼ê´„ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="bulkDeleteModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm w-full text-center">
    <div class="text-5xl mb-4">ğŸ—‘ï¸</div>
    <h3 class="text-xl font-black text-white mb-2">ì¼ê´„ ì‚­ì œ</h3>
    <p class="text-zinc-400 mb-6"><span id="deleteCountText">0</span>ê°œì˜ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="flex gap-3">
      <button onclick="closeBulkDeleteModal()" class="flex-1 py-3 rounded-xl font-bold bg-zinc-800 text-white hover:bg-zinc-700 transition">ì·¨ì†Œ</button>
      <button onclick="confirmBulkDelete()" class="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-400 transition">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-sm w-full text-center">
    <div id="resultIcon" class="text-5xl mb-4">âœ…</div>
    <h3 id="resultTitle" class="text-xl font-black text-white mb-2">ì‚­ì œ ì™„ë£Œ</h3>
    <p id="resultMessage" class="text-zinc-400 mb-6"></p>
    <button onclick="closeResultModal()" class="w-full py-3 rounded-xl font-bold bg-[#c4ff00] text-black hover:bg-white transition">í™•ì¸</button>
  </div>
</div>

<script>
function toggleSelectAll() {
  var selectAll = document.getElementById('selectAll');
  var selectAllMobile = document.getElementById('selectAllMobile');
  var checked = (selectAll && selectAll === document.activeElement) ? selectAll.checked : (selectAllMobile ? selectAllMobile.checked : false);
  document.querySelectorAll('.post-checkbox').forEach(function(cb) { cb.checked = checked; });
  if (selectAll) selectAll.checked = checked;
  if (selectAllMobile) selectAllMobile.checked = checked;
  updateSelectedCount();
}

function updateSelectedCount() {
  var checkboxes = document.querySelectorAll('.post-checkbox:checked');
  var count = checkboxes.length;
  var btn = document.getElementById('bulkDeleteBtn');
  var countSpan = document.getElementById('selectedCount');

  if (count > 0) {
    btn.classList.remove('hidden');
    countSpan.textContent = count;
  } else {
    btn.classList.add('hidden');
  }

  var allCheckboxes = document.querySelectorAll('.post-checkbox');
  var allChecked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
  var selectAll = document.getElementById('selectAll');
  var selectAllMobile = document.getElementById('selectAllMobile');
  if (selectAll) selectAll.checked = allChecked;
  if (selectAllMobile) selectAllMobile.checked = allChecked;
}

function bulkDelete() {
  var checkboxes = document.querySelectorAll('.post-checkbox:checked');
  document.getElementById('deleteCountText').textContent = checkboxes.length;
  document.getElementById('bulkDeleteModal').classList.remove('hidden');
  document.getElementById('bulkDeleteModal').classList.add('flex');
}

function closeBulkDeleteModal() {
  document.getElementById('bulkDeleteModal').classList.add('hidden');
  document.getElementById('bulkDeleteModal').classList.remove('flex');
}

async function confirmBulkDelete() {
  var checkboxes = document.querySelectorAll('.post-checkbox:checked');
  var ids = Array.from(checkboxes).map(function(cb) { return parseInt(cb.value); });
  closeBulkDeleteModal();
  try {
    var res = await fetch('/admin/gallery/bulk-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids: ids })
    });
    var data = await res.json();
    if (data.ok) {
      showResult('success', 'ì‚­ì œ ì™„ë£Œ', data.count + 'ê°œì˜ ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      ids.forEach(function(id) {
        document.querySelectorAll('.post-row[data-id="' + id + '"]').forEach(function(row) { row.remove(); });
      });
      updateSelectedCount();
    } else {
      showResult('error', 'ì‚­ì œ ì‹¤íŒ¨', data.error);
    }
  } catch (err) {
    showResult('error', 'ì˜¤ë¥˜ ë°œìƒ', err.message);
  }
}

function showResult(type, title, message) {
  document.getElementById('resultIcon').textContent = type === 'success' ? 'âœ…' : 'âŒ';
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultMessage').textContent = message;
  document.getElementById('resultModal').classList.remove('hidden');
  document.getElementById('resultModal').classList.add('flex');
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModal').classList.remove('flex');
}
function applyFilter() {
  var uploader = document.getElementById('filterUploader').value;
  var category = document.getElementById('filterCategory').value;
  var dateFrom = document.getElementById('filterDateFrom').value;
  var dateTo = document.getElementById('filterDateTo').value;
  var rows = document.querySelectorAll('.post-row');
  var count = 0;
  var total = 0;
  rows.forEach(function(row) {
    var show = true;
    if (uploader && row.dataset.uploader !== uploader) show = false;
    if (category && row.dataset.category !== category) show = false;
    if (dateFrom && row.dataset.date < dateFrom) show = false;
    if (dateTo && row.dataset.date > dateTo) show = false;
    row.style.display = show ? '' : 'none';
    if (show) count++;
    total++;
  });
  var fc = document.getElementById('filteredCount');
  var tc = document.getElementById('totalCount');
  if (uploader || category || dateFrom || dateTo) {
    fc.textContent = (count/2) + 'ê°œ í•„í„°ë¨';
    tc.textContent = (count/2) + ' / ' + (total/2) + 'ê°œ';
  } else {
    fc.textContent = '';
    tc.textContent = 'ì´ ' + (total/2) + 'ê°œ';
  }
}
</script>
{% endblock %}
