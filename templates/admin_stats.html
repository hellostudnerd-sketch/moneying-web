{% extends "admin_base.html" %}
{% block title %}í†µê³„ - MONEYING{% endblock %}
{% block page_title %}í†µê³„{% endblock %}
{% block page_desc %}ì„œë¹„ìŠ¤ í•µì‹¬ ì§€í‘œë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.{% endblock %}

{# êµ¬ë… íƒ€ì… ë±ƒì§€ ë§¤í¬ë¡œ #}
{% macro plan_badge(name) %}
  {% if name == 'gallery' %}
    <span class="px-2.5 py-1 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-400 font-bold text-xs">ê°¤ëŸ¬ë¦¬</span>
  {% elif name == 'profitguard_lite' %}
    <span class="px-2.5 py-1 rounded-lg bg-purple-500/10 border border-purple-500/20 text-purple-400 font-bold text-xs">PG ë¼ì´íŠ¸</span>
  {% elif name == 'profitguard_pro' %}
    <span class="px-2.5 py-1 rounded-lg bg-purple-500/10 border border-purple-500/20 text-purple-400 font-bold text-xs">PG í”„ë¡œ</span>
  {% elif name == 'profitguard_lifetime' %}
    <span class="px-2.5 py-1 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-yellow-400 font-bold text-xs">PG í‰ìƒ</span>
  {% elif name == 'allinone' %}
    <span class="px-2.5 py-1 rounded-lg bg-[#a3e635]/10 border border-[#a3e635]/20 text-[#a3e635] font-bold text-xs">ì˜¬ì¸ì›</span>
  {% else %}
    <span class="px-2.5 py-1 rounded-lg bg-zinc-800 border border-zinc-700 text-gray-300 font-bold text-xs">{{ name }}</span>
  {% endif %}
{% endmacro %}

{% macro plan_bar_color(name) %}{% if name == 'gallery' %}bg-blue-400{% elif name == 'profitguard_lite' or name == 'profitguard_pro' %}bg-purple-400{% elif name == 'profitguard_lifetime' %}bg-yellow-400{% elif name == 'allinone' %}bg-[#a3e635]{% else %}bg-zinc-500{% endif %}{% endmacro %}

{% block content_admin %}

<div class="space-y-4 md:space-y-6">

  <!-- â”€â”€ í•µì‹¬ KPI â”€â”€ -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">ì´ ê°€ì…ì</div>
      <div class="text-2xl md:text-3xl font-black">{{ total_users }}</div>
      <div class="text-[#c4ff00] text-xs mt-1">+{{ new_users_today }} ì˜¤ëŠ˜ Â· +{{ new_users_7d }} 7ì¼</div>
    </div>
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">êµ¬ë…ì</div>
      <div class="text-2xl md:text-3xl font-black text-[#c4ff00]">{{ total_subscribers }}</div>
      <div class="text-zinc-400 text-xs mt-1">ì „í™˜ìœ¨ {{ conversion_rate }}% Â· ì²´í—˜ {{ trial_users }}ëª…</div>
    </div>
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
      <div class="text-2xl md:text-3xl font-black text-blue-400">{{ "{:,}".format(revenue_this_month) }}<span class="text-sm text-zinc-500 ml-0.5">ì›</span></div>
      <div class="text-zinc-400 text-xs mt-1">{{ total_payments }}ê±´ ê²°ì œ</div>
    </div>
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">ëˆ„ì  ë§¤ì¶œ</div>
      <div class="text-2xl md:text-3xl font-black">{{ "{:,}".format(total_revenue) }}<span class="text-sm text-zinc-500 ml-0.5">ì›</span></div>
      <div class="text-zinc-400 text-xs mt-1">ê°¤ëŸ¬ë¦¬ {{ total_posts }}ê°œ Â· {{ "{:,}".format(total_views) }}íšŒ ì¡°íšŒ</div>
    </div>
  </div>

  <!-- â”€â”€ ë§¤ì¶œ ìƒì„¸ KPI â”€â”€ -->
  <div class="grid grid-cols-3 gap-2 md:gap-3">
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">ì˜¤ëŠ˜ ë§¤ì¶œ</div>
      <div class="text-xl md:text-2xl font-black text-[#c4ff00]">{{ "{:,}".format(revenue_today) }}<span class="text-sm text-zinc-500 ml-0.5">ì›</span></div>
    </div>
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">ì „ì›” ëŒ€ë¹„</div>
      <div class="text-xl md:text-2xl font-black {% if mom_growth > 0 %}text-green-400{% elif mom_growth < 0 %}text-red-400{% else %}text-zinc-400{% endif %}">
        {% if mom_growth > 0 %}+{% endif %}{{ mom_growth }}%
      </div>
      <div class="text-zinc-500 text-[11px] mt-1">ì „ì›” {{ "{:,}".format(revenue_last_month) }}ì›</div>
    </div>
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="text-zinc-500 text-[11px] md:text-xs font-bold mb-1">ì´íƒˆë¥  <span class="font-normal">(30ì¼)</span></div>
      <div class="text-xl md:text-2xl font-black {% if churn_rate > 10 %}text-red-400{% elif churn_rate > 5 %}text-yellow-400{% else %}text-green-400{% endif %}">
        {{ churn_rate }}%
      </div>
      <div class="text-zinc-500 text-[11px] mt-1">{{ expired_30d }}ëª… ì´íƒˆ</div>
    </div>
  </div>

  <!-- â”€â”€ ì°¨íŠ¸ ì˜ì—­ â”€â”€ -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-5">

    <!-- 14ì¼ ê°€ì… ì¶”ì´ -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <h3 class="font-bold text-sm md:text-base mb-4">ê°€ì… ì¶”ì´ <span class="text-zinc-500 text-xs font-normal">ìµœê·¼ 14ì¼</span></h3>
      <div class="h-36 md:h-44 flex items-end gap-[3px] md:gap-1">
        {% for day in daily_signups %}
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full rounded-t transition-all duration-300"
                 style="height: {{ (day.count / max_daily_signup * 100) if max_daily_signup > 0 else 0 }}%; min-height: {{ '2px' if day.count > 0 else '0' }}; background: {{ '#c4ff00' if loop.last else 'rgba(163,230,53,0.3)' }};">
            </div>
            {% if day.count > 0 %}
              <div class="text-[10px] font-bold mt-1 {{ 'text-[#c4ff00]' if loop.last else 'text-zinc-500' }}">{{ day.count }}</div>
            {% endif %}
            {% if loop.index % 2 == 0 or loop.last %}
              <div class="text-zinc-600 text-[9px] md:text-[10px] mt-0.5">{{ day.label }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ë§¤ì¶œ ì°¨íŠ¸ (íƒ­ ì „í™˜) -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 mb-4">
        <div class="flex items-center gap-3">
          <h3 class="font-bold text-sm md:text-base">ë§¤ì¶œ</h3>
          <div class="flex bg-zinc-800 rounded-lg p-0.5">
            <button onclick="switchRevTab('monthly')" id="revTabMonthly"
                    class="px-3 py-1 rounded-md text-xs font-bold transition bg-blue-500 text-white">ì›”ë³„</button>
            <button onclick="switchRevTab('daily')" id="revTabDaily"
                    class="px-3 py-1 rounded-md text-xs font-bold transition text-zinc-400 hover:text-white">ì¼ë³„</button>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input type="date" id="csvStart" class="bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1 text-xs text-white focus:border-blue-500 focus:outline-none">
          <span class="text-zinc-600 text-xs">~</span>
          <input type="date" id="csvEnd" class="bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1 text-xs text-white focus:border-blue-500 focus:outline-none">
          <button onclick="downloadCsv()" class="px-3 py-1 bg-blue-500 hover:bg-blue-400 text-white text-xs font-bold rounded-lg transition shrink-0">CSV</button>
        </div>
      </div>



      <!-- ì›”ë³„ ì°¨íŠ¸ -->
      <div id="revChartMonthly" class="h-36 md:h-44 flex items-end gap-2 md:gap-3">
        {% for m in monthly_revenue %}
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full rounded-t transition-all duration-300"
                 style="height: {{ (m.amount / max_monthly * 100) if max_monthly > 0 else 0 }}%; min-height: {{ '2px' if m.amount > 0 else '0' }}; background: {{ '#60a5fa' if loop.last else 'rgba(96,165,250,0.3)' }};">
            </div>
            {% if m.amount > 0 %}
              <div class="text-[10px] font-bold mt-1 {{ 'text-blue-400' if loop.last else 'text-zinc-500' }}">{{ "{:,}".format(m.amount // 10000) }}ë§Œ</div>
            {% endif %}
            <div class="text-zinc-600 text-[10px] md:text-xs mt-0.5">{{ m.label }}</div>
          </div>
        {% endfor %}
      </div>

      <!-- ì¼ë³„ ì°¨íŠ¸ -->
      <div id="revChartDaily" class="h-36 md:h-44 flex items-end gap-[3px] md:gap-1 hidden">
        {% for d in daily_revenue %}
          <div class="flex-1 flex flex-col items-center">
            <div class="w-full rounded-t transition-all duration-300"
                 style="height: {{ (d.amount / max_daily_rev * 100) if max_daily_rev > 0 else 0 }}%; min-height: {{ '2px' if d.amount > 0 else '0' }}; background: {{ '#60a5fa' if loop.last else 'rgba(96,165,250,0.3)' }};">
            </div>
            {% if d.amount > 0 %}
              <div class="text-[10px] font-bold mt-1 {{ 'text-blue-400' if loop.last else 'text-zinc-500' }}">{{ "{:,}".format(d.amount // 10000) }}ë§Œ</div>
            {% endif %}
            {% if loop.index % 2 == 0 or loop.last %}
              <div class="text-zinc-600 text-[9px] md:text-[10px] mt-0.5">{{ d.label }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- â”€â”€ ë§¤ì¶œë‚´ì—­ & ì œí’ˆë³„ íŒë§¤ ìˆœìœ„ â”€â”€ -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-5">

    <!-- ìƒì„¸ ë§¤ì¶œë‚´ì—­ -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
      <div class="flex items-center justify-between px-4 md:px-5 py-3 border-b border-zinc-800">
        <h3 class="font-bold text-sm md:text-base">ìµœê·¼ ë§¤ì¶œë‚´ì—­</h3>
        <span class="text-zinc-500 text-xs">ìµœê·¼ 10ê±´</span>
      </div>
      {% if recent_payments %}
        <div class="divide-y divide-zinc-800/50">
          {% for p in recent_payments %}
          <div class="px-4 md:px-5 py-3 flex items-center justify-between gap-2">
            <div class="min-w-0 flex-1">
              <div class="text-white text-sm font-medium truncate">{{ p._user.email if p._user else 'íƒˆí‡´ìœ ì €' }}</div>
              <div class="flex items-center gap-2 mt-0.5">
                {{ plan_badge(p.plan_type) }}
                <span class="text-zinc-600 text-[11px]">{{ p.paid_at.strftime('%m/%d %H:%M') if p.paid_at else '' }}</span>
              </div>
            </div>
            <div class="text-right shrink-0">
              <span class="font-black text-blue-400 text-sm">{{ "{:,}".format(p.amount) }}</span>
              <span class="text-zinc-500 text-[11px]">ì›</span>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="px-4 py-8 text-center text-zinc-600 text-sm">ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
      {% endif %}
    </div>

    <!-- ì œí’ˆë³„ íŒë§¤ ìˆœìœ„ -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
      <div class="flex items-center justify-between px-4 md:px-5 py-3 border-b border-zinc-800">
        <h3 class="font-bold text-sm md:text-base">ì œí’ˆë³„ íŒë§¤ ìˆœìœ„</h3>
        <span class="text-zinc-500 text-xs">ì „ì²´ ê¸°ê°„</span>
      </div>
      {% if product_sales %}
        <div class="p-4 md:p-5 space-y-4">
          {% for ps in product_sales %}
            <div>
              <div class="flex items-center justify-between mb-1.5">
                <div class="flex items-center gap-2">
                  <span class="text-xs font-black w-5 text-center
                    {% if loop.index == 1 %}text-[#c4ff00]{% elif loop.index == 2 %}text-zinc-300{% elif loop.index == 3 %}text-orange-400{% else %}text-zinc-600{% endif %}">
                    {{ loop.index }}
                  </span>
                  {{ plan_badge(ps.plan_type) }}
                </div>
                <div class="text-right">
                  <span class="text-white font-bold text-sm">{{ ps.count }}ê±´</span>
                  <span class="text-zinc-500 text-xs ml-1">{{ "{:,}".format(ps.total) }}ì›</span>
                </div>
              </div>
              <div class="w-full bg-zinc-800 rounded-full h-2">
                <div class="{{ plan_bar_color(ps.plan_type) }} h-2 rounded-full transition-all"
                  style="width: {{ (ps.count / max_product_count * 100) if max_product_count > 0 else 0 }}%"></div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="px-4 py-8 text-center text-zinc-600 text-sm">íŒë§¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
      {% endif %}
    </div>

  </div>

  <!-- â”€â”€ êµ¬ë… & ë§í¬ìš”ì²­ â”€â”€ -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-5">

    <!-- êµ¬ë… íƒ€ì…ë³„ í˜„í™© -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <h3 class="font-bold text-sm md:text-base mb-4">êµ¬ë… íƒ€ì…ë³„ í˜„í™©</h3>
      {% if plan_stats %}
        <div class="space-y-4">
          {% for plan in plan_stats %}
            <div class="flex items-center gap-3">
              <div class="shrink-0">{{ plan_badge(plan.name) }}</div>
              <div class="flex-1 min-w-0">
                <div class="w-full bg-zinc-800 rounded-full h-2.5">
                  <div class="{{ plan_bar_color(plan.name) }} h-2.5 rounded-full transition-all" style="width: {{ (plan.count / total_subscribers * 100) if total_subscribers > 0 else 0 }}%"></div>
                </div>
              </div>
              <div class="text-white font-black text-sm shrink-0 w-12 text-right">{{ plan.count }}ëª…</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-zinc-600 text-center py-8 text-sm">êµ¬ë… ë°ì´í„° ì—†ìŒ</div>
      {% endif %}
    </div>

    <!-- ë§í¬ìš”ì²­ í˜„í™© -->
    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-4 md:p-5">
      <h3 class="font-bold text-sm md:text-base mb-4">ë§í¬ìš”ì²­ í˜„í™©</h3>
      <div class="grid grid-cols-3 gap-3 mb-5">
        <div class="bg-zinc-800/50 rounded-xl p-3 md:p-4 text-center">
          <div class="text-xl md:text-2xl font-black text-white">{{ total_links }}</div>
          <div class="text-zinc-500 text-xs mt-1">ì´ ìš”ì²­</div>
        </div>
        <div class="bg-zinc-800/50 rounded-xl p-3 md:p-4 text-center">
          <div class="text-xl md:text-2xl font-black text-green-400">{{ completed_links }}</div>
          <div class="text-zinc-500 text-xs mt-1">ì™„ë£Œ</div>
        </div>
        <div class="bg-zinc-800/50 rounded-xl p-3 md:p-4 text-center">
          <div class="text-xl md:text-2xl font-black text-yellow-400">{{ pending_links }}</div>
          <div class="text-zinc-500 text-xs mt-1">ëŒ€ê¸°</div>
        </div>
      </div>
      <div class="w-full bg-zinc-800 rounded-full h-3">
        <div class="bg-green-500 h-3 rounded-full transition-all" style="width: {{ link_completion_rate }}%"></div>
      </div>
      <div class="text-zinc-500 text-xs mt-2 text-right">ì™„ë£Œìœ¨ {{ link_completion_rate }}%</div>
    </div>

  </div>

  <!-- â”€â”€ ì¸ê¸° ì˜ìƒ TOP 5 â”€â”€ -->
  <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden">
    <div class="px-4 md:px-5 py-3 md:py-4 border-b border-zinc-800">
      <h3 class="font-bold text-sm md:text-base">ì¸ê¸° ì˜ìƒ TOP 5</h3>
    </div>
    {% if popular_posts %}
      <div class="divide-y divide-zinc-800/50">
        {% for p in popular_posts %}
          <div class="flex items-center gap-3 px-4 md:px-5 py-3">
            <div class="text-lg font-black w-6 shrink-0 text-center
              {% if loop.index == 1 %}text-[#c4ff00]{% elif loop.index == 2 %}text-zinc-300{% elif loop.index == 3 %}text-orange-400{% else %}text-zinc-600{% endif %}">
              {{ loop.index }}
            </div>
            {% set img_list = p.to_dict().images %}
            {% if img_list and img_list|length > 0 %}
              <img src="{% if img_list[0].startswith('/r2/') or img_list[0].startswith('http') %}{{ img_list[0] }}{% else %}/static/uploads/{{ img_list[0] }}{% endif %}" class="w-9 h-9 md:w-10 md:h-10 rounded-lg object-cover shrink-0">
            {% else %}
              <div class="w-9 h-9 md:w-10 md:h-10 rounded-lg bg-zinc-800 flex items-center justify-center shrink-0 text-sm">ğŸ¬</div>
            {% endif %}
            <div class="flex-1 min-w-0">
              <div class="font-bold text-sm truncate">{{ p.title }}</div>
              <div class="text-zinc-500 text-xs">{{ p.category or 'all' }}</div>
            </div>
            <div class="text-right shrink-0">
              <span class="font-black text-[#c4ff00] text-sm">{{ "{:,}".format(p.view_count or 0) }}</span>
              <span class="text-zinc-500 text-xs ml-0.5">íšŒ</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="p-6 text-center text-zinc-600 text-sm">ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
    {% endif %}
  </div>

</div>

<script>
function switchRevTab(tab) {
  var monthly = document.getElementById('revChartMonthly');
  var daily = document.getElementById('revChartDaily');
  var btnM = document.getElementById('revTabMonthly');
  var btnD = document.getElementById('revTabDaily');
  var onCls = 'bg-blue-500 text-white';
  var offCls = 'text-zinc-400 hover:text-white';

  if (tab === 'monthly') {
    monthly.classList.remove('hidden');
    daily.classList.add('hidden');
    btnM.className = btnM.className.replace(offCls, onCls);
    btnD.className = btnD.className.replace(onCls, offCls);
  } else {
    monthly.classList.add('hidden');
    daily.classList.remove('hidden');
    btnD.className = btnD.className.replace(offCls, onCls);
    btnM.className = btnM.className.replace(onCls, offCls);
  }
}

function downloadCsv() {
  var start = document.getElementById('csvStart').value;
  var end = document.getElementById('csvEnd').value;
  var url = '/admin/stats/download-csv?start=' + encodeURIComponent(start) + '&end=' + encodeURIComponent(end);
  window.location.href = url;
}
</script>

{% endblock %}
