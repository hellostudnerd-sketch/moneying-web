{% extends "base.html" %}

{% block title %}{{ product.title }} - MONEYING{% endblock %}

{% block main_class %}max-w-5xl mx-auto px-4 md:px-6 pt-24 md:pt-28 pb-28 lg:pb-20{% endblock %}

{% block head_extra %}

<style>

  .product-description img { max-width: 100%; height: auto; border-radius: 12px; margin: 16px 0; }

  .product-description h1, .product-description h2, .product-description h3 { margin-top: 24px; margin-bottom: 12px; font-weight: 700; }

  .product-description h1 { font-size: 1.75rem; }

  .product-description h2 { font-size: 1.5rem; }

  .product-description h3 { font-size: 1.25rem; }

  .product-description p { margin-bottom: 16px; line-height: 1.8; }

  .product-description ul, .product-description ol { margin-bottom: 16px; padding-left: 24px; }

  .product-description li { margin-bottom: 8px; }

  .product-description a { color: #a3e635; text-decoration: underline; }

</style>

{% endblock %}

{% block content %}

<a href="/store" class="text-zinc-500 hover:text-white text-sm mb-6 inline-block">← 지식 스토어</a>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

  <div class="lg:col-span-2">

    {% if product.image %}

      <div class="rounded-2xl overflow-hidden mb-6">

        <img src="{{ product.image }}" alt="{{ product.title }}" class="w-full aspect-video object-cover">

      </div>

    {% endif %}

    <div class="mb-6">

      {% if product.price == 0 %}

        <span class="inline-block px-3 py-1 bg-[#c4ff00]/10 text-[#c4ff00] text-sm font-bold rounded-full mb-3">무료</span>

      {% elif product.badge %}

        <span class="inline-block px-3 py-1 bg-[#c4ff00]/10 text-[#c4ff00] text-sm font-bold rounded-full mb-3">{{ product.badge }}</span>

      {% endif %}

      <h1 class="text-3xl md:text-4xl font-black">{{ product.title }}</h1>

      <div class="flex items-center gap-3 mt-3 text-zinc-400 text-sm">

        <span>{{ {'ebook':'전자책','vod':'VOD 강의','program':'프로그램','template':'템플릿'}.get(product.category, product.category) }}</span>

        <span>·</span>

        <span>{{ {'shortform':'#숏폼 부업','longform':'#롱폼/유튜브','publishing':'#전자책 출판','realestate':'#부동산/경매'}.get(product.topic, product.topic) }}</span>

      </div>

    </div>

    <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6 md:p-8">

      <h2 class="text-xl font-bold mb-6 pb-4 border-b border-zinc-800">상품 소개</h2>

      <div class="product-description text-zinc-300">

        {{ product.description|safe if product.description else '<p class="text-zinc-500">상품 설명이 없습니다.</p>' }}

      </div>

    </div>

  </div>

  <div class="lg:col-span-1">

    <div class="sticky top-24">

      <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-6">

        {% if product.id == 2 %}

        <div class="text-2xl font-black text-white mb-1">19,000<span class="text-sm font-normal text-zinc-400">원/월~</span></div>

        <p class="text-zinc-500 text-xs mb-4">요금제 선택 가능</p>

        {% elif product.price == 0 %}

        <div class="text-3xl font-black text-[#c4ff00] mb-2">무료</div>

        {% else %}

        <div class="text-3xl font-black text-white mb-2">{{ "{:,}".format(product.price) }}원</div>

        {% endif %}

        <div class="space-y-3 mt-6">

          {% if product.price == 0 and product.file_url %}

          <a href="{{ product.file_url }}" target="_blank"

             class="block w-full bg-[#c4ff00] text-black font-black py-4 rounded-xl text-center hover:bg-white transition text-lg">

            무료 다운로드

          </a>

          {% elif product.price == 0 %}

          <button disabled

             class="block w-full bg-zinc-700 text-zinc-400 font-black py-4 rounded-xl text-center text-lg cursor-not-allowed">

            준비 중

          </button>

          {% else %}

            {% if product.id == 2 %}

              {% if can_download_pg %}

                {% if is_kakao and not pg_pw_set %}

                <button onclick="document.getElementById('pw-modal').style.display='flex'"

                   class="block w-full bg-yellow-400 text-black font-black py-3 rounded-xl text-center hover:bg-yellow-300 transition">

                  비밀번호 설정 후 다운로드

                </button>

                {% else %}

                <a href="/api/profitguard/download"

                   class="block w-full bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition">

                  ✅ 다운로드

                </a>

                {% endif %}

                <p class="text-center text-zinc-500 text-xs mt-2">구독 중 — 최신 버전</p>

              {% else %}

                <div class="space-y-2">

                  <a href="/checkout/profitguard_lite" class="block w-full py-3 bg-zinc-800 border border-zinc-700 text-white rounded-xl text-center hover:border-[#c4ff00] transition">

                    <span class="font-bold">라이트</span> <span class="text-zinc-400 text-sm">19,000원/월</span>

                  </a>

                  <a href="/checkout/profitguard_pro" class="block w-full py-3 bg-[#c4ff00] text-black rounded-xl text-center font-bold hover:bg-white transition">

                    <span class="font-bold">PRO 추천</span> <span class="text-sm">39,000원/월</span>

                  </a>

                  <a href="/checkout/profitguard_lifetime" class="block w-full py-3 bg-zinc-800 border border-purple-500/50 text-purple-400 rounded-xl text-center hover:border-purple-400 transition">

                    <span class="font-bold">평생</span> <span class="text-sm">200,000원</span>

                  </a>

                </div>

              {% endif %}

            {% else %}

            {% if has_purchased %}
            <!-- 구매 완료 상태 -->
            <div class="space-y-3">
              {% if product.file_url or product.file_url2 %}
                {% if product.file_url %}
                <a href="{{ product.file_url }}" target="_blank"
                   class="block w-full bg-[#c4ff00] text-black font-black py-4 rounded-xl text-center hover:bg-white transition text-lg">
                  <i class="fas fa-{% if 'notion' in (product.file_url|lower) %}link{% else %}download{% endif %} mr-2"></i>{% if product.file_url2 %}{% if 'notion' in (product.file_url|lower) %}노션 열기{% else %}링크 열기{% endif %}{% else %}콘텐츠 열기{% endif %}
                </a>
                {% endif %}
                {% if product.file_url2 %}
                <a href="{{ product.file_url2 }}" target="_blank"
                   class="block w-full bg-white text-black font-black py-4 rounded-xl text-center hover:bg-zinc-200 transition text-lg">
                  <i class="fas fa-{% if 'pdf' in (product.file_url2|lower) %}file-pdf{% else %}download{% endif %} mr-2"></i>{% if 'pdf' in (product.file_url2|lower) %}PDF 다운로드{% else %}파일 다운로드{% endif %}
                </a>
                {% endif %}
              {% else %}
                <button disabled class="block w-full bg-zinc-700 text-zinc-400 font-black py-4 rounded-xl text-center text-lg cursor-not-allowed">
                  콘텐츠 준비 중
                </button>
              {% endif %}
              <div class="text-center text-green-400 text-sm font-bold">✅ 구매 완료</div>
            </div>
            {% elif session.get('user_id') %}
            <button onclick="location.href='/store/checkout/{{ product.id }}'"
               class="block w-full bg-[#c4ff00] text-black font-black py-4 rounded-xl text-center hover:bg-white transition text-lg">
              구매하기
            </button>
            {% else %}
            <a href="/login?next=/store/{{ product.id }}"
               class="block w-full bg-[#c4ff00] text-black font-black py-4 rounded-xl text-center hover:bg-white transition text-lg">
              로그인 후 구매
            </a>
            {% endif %}

            {% endif %}

          {% endif %}

        </div>

        <div class="mt-6 pt-6 border-t border-zinc-800 text-zinc-500 text-sm space-y-2">

          <div class="flex items-center gap-2"><span>✓</span><span>구매 후 즉시 이용 가능</span></div>

          <div class="flex items-center gap-2"><span>✓</span><span>평생 소장</span></div>

          <div class="flex items-center gap-2"><span>✓</span><span>디지털 상품 특성상 환불 불가</span></div>

        </div>

      </div>

    </div>

  </div>

</div>



{% if is_kakao and not pg_pw_set and can_download_pg %}

<div id="pw-modal" style="display:none" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center">

  <div class="bg-zinc-900 rounded-2xl p-8 max-w-sm w-full mx-4">

    <h3 class="text-xl font-bold text-white mb-2 text-center">프로핏가드 비밀번호 설정</h3>

    <p class="text-zinc-400 text-sm mb-6 text-center">프로그램 로그인을 위해<br>비밀번호를 설정해주세요.</p>

    <input id="store-pg-pw" type="password" placeholder="비밀번호 (4자 이상)" class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white mb-4">

    <button onclick="setStorePgPw()" class="w-full py-3 bg-[#c4ff00] text-black font-bold rounded-xl hover:bg-white transition">설정 후 다운로드</button>

    <button onclick="document.getElementById('pw-modal').style.display='none'" class="w-full py-2 text-zinc-500 text-sm mt-2">닫기</button>

  </div>

</div>

<script>

function setStorePgPw() {

  var pw = document.getElementById('store-pg-pw').value.trim();

  if (pw.length < 4) { alert('4\uc790 \uc774\uc0c1 \uc785\ub825\ud574\uc8fc\uc138\uc694.'); return; }

  fetch('/api/profitguard/set-password', {

    method: 'POST',

    headers: {'Content-Type': 'application/json'},

    body: JSON.stringify({password: pw})

  })

  .then(function(r) { return r.json(); })

  .then(function(d) {

    if (d.result === 'SUCCESS') { window.location.href = '/api/profitguard/download'; }

    else { alert(d.msg); }

  });

}

</script>

{% endif %}

<!-- 모바일 하단 고정 구매바 -->
<div class="fixed bottom-0 left-0 right-0 bg-zinc-900/95 backdrop-blur-md border-t border-zinc-800 p-4 lg:hidden z-40">
  <div class="max-w-lg mx-auto flex items-center justify-between gap-4">
    <div>
      {% if product.price == 0 %}
      <span class="text-xl font-black text-[#c4ff00]">무료</span>
      {% else %}
      <span class="text-xl font-black text-white">{{ "{:,}".format(product.price) }}원</span>
      {% endif %}
    </div>
    {% if product.price == 0 and product.file_url %}
    <a href="{{ product.file_url }}" target="_blank" class="flex-1 bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition">무료 다운로드</a>
    {% elif product.price == 0 %}
    <button disabled class="flex-1 bg-zinc-700 text-zinc-400 font-black py-3 rounded-xl text-center cursor-not-allowed">준비 중</button>
    {% elif product.id == 2 %}
      {% if can_download_pg %}
      <a href="/api/profitguard/download" class="flex-1 bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition">다운로드</a>
      {% else %}
      <a href="/profitguard" class="flex-1 bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition">구독하기</a>
      {% endif %}
    {% else %}
      {% if has_purchased and (product.file_url or product.file_url2) %}
      <div class="flex-1 flex gap-2">
        {% if product.file_url %}
        <a href="{{ product.file_url }}" target="_blank" class="flex-1 bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition text-sm">{% if product.file_url2 %}{% if 'notion' in (product.file_url|lower) %}노션{% else %}링크{% endif %}{% else %}콘텐츠 열기{% endif %}</a>
        {% endif %}
        {% if product.file_url2 %}
        <a href="{{ product.file_url2 }}" target="_blank" class="flex-1 bg-white text-black font-black py-3 rounded-xl text-center hover:bg-zinc-200 transition text-sm">{% if 'pdf' in (product.file_url2|lower) %}PDF{% else %}다운로드{% endif %}</a>
        {% endif %}
      </div>
      {% elif has_purchased %}
      <span class="flex-1 text-center text-green-400 font-bold py-3">✅ 구매 완료 (준비 중)</span>
      {% elif session.get('user_id') %}
      <button onclick="location.href='/store/checkout/{{ product.id }}'" class="flex-1 bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition">구매하기</button>
      {% else %}
      <a href="/login?next=/store/{{ product.id }}" class="flex-1 bg-[#c4ff00] text-black font-black py-3 rounded-xl text-center hover:bg-white transition">로그인 후 구매</a>
      {% endif %}
    {% endif %}
  </div>
</div>

{% endblock %}