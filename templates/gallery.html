{% extends "base.html" %}

{% block main_class %}max-w-7xl mx-auto px-4 md:px-6 pt-24 md:pt-28 pb-20{% endblock %}

{% block content %}

<style>
/* ===== ì»¬ëŸ¬ ë³€ìˆ˜ ===== */
:root {
  --neon-lime: #c4ff00;
}

/* ===== í•„í„° ë²„íŠ¼ ===== */
.filter-btn{
  background: rgba(39, 39, 42, 0.5);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  color: #a1a1aa;
  transition: all .2s ease;
}

.filter-btn:hover{
  background: rgba(63, 63, 70, 0.6);
  border-color: rgba(255,255,255,0.2);
  color: #fff;
}

.filter-btn.active{
  background: #fff;
  border-color: #fff;
  color: #000;
  font-weight: 700;
}

/* ===== ê°¤ëŸ¬ë¦¬ ì¹´ë“œ ===== */
.gallery-card {
  background: transparent;
  transition: all 0.15s ease-out;
}

.gallery-card:hover {
  transform: translateY(-4px);
}

.gallery-card .relative {
  aspect-ratio: 9/16;
  border-radius: 0.5rem;
  overflow: hidden;
  background: rgba(24, 24, 27, 0.8);
  border: 1px solid rgba(255,255,255,0.05);
}

.gallery-card:hover .relative {
  border-color: rgba(255,255,255,0.2);
  box-shadow: 0 12px 24px rgba(0,0,0,0.3);
}

/* ===== ìº¡ì²˜ ì´ë¯¸ì§€ ê·¸ë¦¬ë“œ ===== */
.capture-row{
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 16px;
}

@media (max-width: 1024px) {
  .capture-row {
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
}

@media (max-width: 768px) {
  .capture-row {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
}

.capture-item{
  aspect-ratio: 9/16;
  transition: all 0.3s ease;
}

.capture-item:hover {
  transform: scale(1.03);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

@media (min-width: 768px) {
  .capture-item {
    min-height: 400px;
  }
}

.capture-item img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* ===== ë·° ë°°ì§€ ===== */
.view-badge {
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.1);
}

/* ===== ë¶ë§ˆí¬ ë²„íŠ¼ ===== */
.bookmark-btn {
  transition: all 0.2s ease;
}
.bookmark-btn:hover {
  transform: scale(1.15);
}
.bookmark-btn.active {
  color: #ef4444;
  text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

/* ===== ì¹´ë“œ ë¶ë§ˆí¬ ë²„íŠ¼ ===== */
.card-bookmark-btn {
  backdrop-filter: blur(8px);
}

/* ===== ëª¨ë‹¬ ===== */
.modal-backdrop {
  background: rgba(0, 0, 0, 0.85);
}

#detailBox {
  background: linear-gradient(135deg, rgba(24, 24, 27, 0.95), rgba(9, 9, 11, 0.98));
  border: 1px solid rgba(255,255,255,0.1);
}

/* ===== FREE ë°°ì§€ ===== */
.free-badge {
  background: var(--neon-lime);
}

/* ===== í˜ì´ì§€ ì œëª© ===== */
.text-highlight {
  color: var(--neon-lime);
}

/* ===== ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° ===== */
.no-scrollbar::-webkit-scrollbar { display: none; }
.no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

/* ===== êµ¬ë… ëª¨ë‹¬ ===== */
#subscribeBox {
  background: linear-gradient(135deg, rgba(24, 24, 27, 0.98), rgba(9, 9, 11, 0.99));
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 25px 50px rgba(0,0,0,0.5);
}

/* ===== ë¹ˆ ìƒíƒœ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ ===== */
#emptyBookmark .text-4xl,
#emptyRecent .text-4xl {
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
</style>

  <!-- í—¤ë” -->
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl md:text-4xl font-black mb-2">
  ì˜ìƒ <span class="text-white">ê°¤ëŸ¬ë¦¬</span>
</h1>
<p class="text-zinc-400 text-sm md:text-base">í•˜ì´ë¼ì´íŠ¸ ìº¡ì²˜ë¡œë§Œ ë¹ ë¥´ê²Œ íŒë‹¨í•˜ê³ ,<br class="md:hidden"> ë°”ë¡œ ì œì‘ìœ¼ë¡œ ë„˜ì–´ê°€ì„¸ìš”.
</p>
    </div>

    <div class="flex gap-2 shrink-0">
      <!-- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì°œí•œ ì˜ìƒ íƒ­ì¼ ë•Œë§Œ í‘œì‹œ) -->
      <button id="excelDownloadBtn" onclick="exportBookmarksToExcel()" class="hidden bg-[#c4ff00] text-black font-bold px-4 py-2 rounded-md hover:bg-white transition flex items-center gap-2">
        <i class="fas fa-file-excel"></i> <span class="hidden md:inline">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span><span class="md:hidden">ì—‘ì…€</span>
      </button>
      {% if session.get("admin") %}
        <a href="/admin/gallery/bulk" class="bg-zinc-700 text-white font-bold px-4 py-2 rounded-md hover:bg-zinc-600 transition">ğŸ“¦ ëŒ€ëŸ‰ë“±ë¡</a>
        <a href="/admin/upload" class="bg-highlight text-black font-black px-4 py-2 rounded-md hover:bg-white transition">+ ê²Œì‹œë¬¼ ì¶”ê°€</a>
      {% elif session.get("is_seller") %}
        <a href="/seller/upload" class="bg-purple-600 text-white font-bold px-4 py-2 rounded-md hover:bg-purple-500 transition">ğŸ“¸ ì§ì´¬ ì—…ë¡œë“œ</a>
        {% if session.get("subscriber") or session.get("is_trial") %}
        <span class="bg-zinc-800 text-zinc-400 font-bold px-4 py-2 rounded-md border border-zinc-700">
          {% if session.get("is_trial") %}ğŸ ì²´í—˜ì¤‘{% else %}âœ… êµ¬ë…ì¤‘{% endif %}
        </span>
        {% endif %}
      {% elif session.get("subscriber") or session.get("is_trial") %}
        <span class="bg-zinc-800 text-zinc-400 font-bold px-4 py-2 rounded-md border border-zinc-700">
          {% if session.get("is_trial") %}ğŸ ì²´í—˜ì¤‘{% else %}âœ… êµ¬ë…ì¤‘{% endif %}
        </span>
      {% elif session.get("user_id") %}
        <a href="/free-trial" class="bg-zinc-800 text-white font-bold px-4 py-2 rounded-md border border-zinc-700 hover:border-highlight hover:text-highlight transition">ğŸ 3ì¼ ë¬´ë£Œì²´í—˜</a>
        <a href="/pricing" class="bg-highlight text-black font-black px-4 py-2 rounded-md hover:bg-white transition">êµ¬ë…í•˜ê¸°</a>
      {% else %}
        <a href="/login?next=/gallery" class="bg-zinc-800 text-white font-bold px-4 py-2 rounded-md border border-zinc-700 hover:border-highlight hover:text-highlight transition">ğŸ 3ì¼ ë¬´ë£Œì²´í—˜</a>
        <a href="/pricing" class="bg-highlight text-black font-black px-4 py-2 rounded-md hover:bg-white transition">êµ¬ë…í•˜ê¸°</a>
      {% endif %}
    </div>
  </div>

  <!-- ì¹´í…Œê³ ë¦¬ í•„í„° + ê²€ìƒ‰ -->
  <div class="flex items-center gap-3 mb-8">
    <div class="flex gap-2 overflow-x-auto no-scrollbar flex-1">
      <button class="filter-btn active px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="all" onclick="filterGallery('all', this)">ì „ì²´ë³´ê¸°</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="popular" onclick="filterGallery('popular', this)">ì¸ê¸°ìˆœ</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="bookmark" onclick="filterGallery('bookmark', this)">ì°œí•œ ì˜ìƒ</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="recent" onclick="filterGallery('recent', this)">ìµœê·¼ ë³¸</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="seller" onclick="filterGallery('seller', this)">íŒë§¤ì ì§ì´¬</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="beauty" onclick="filterGallery('beauty', this)">Beauty</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="living" onclick="filterGallery('living', this)">Living</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="food" onclick="filterGallery('food', this)">Food</button>
      <button class="filter-btn px-5 py-2 rounded-full text-sm whitespace-nowrap" data-cat="tech" onclick="filterGallery('tech', this)">Tech</button>
    </div>
    
    <!-- ê²€ìƒ‰ (PC) -->
    <div class="relative shrink-0 hidden md:block">
      <input type="text" id="gallerySearch" placeholder="ê²€ìƒ‰" onkeyup="searchGallery(this.value)"
             class="w-32 focus:w-48 bg-zinc-900 border border-zinc-700 rounded-full px-4 py-2 pr-9 text-white text-sm placeholder:text-zinc-500 focus:border-zinc-500 focus:outline-none transition-all duration-300">
      <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-400 hover:text-white">
        <i class="fas fa-search text-sm"></i>
      </button>
    </div>
  </div>

  <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6"></div>

  <div id="emptyState" class="hidden text-center text-zinc-500 font-bold py-20">ì•„ì§ ë“±ë¡ëœ ê°¤ëŸ¬ë¦¬ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
  <div id="emptyBookmark" class="hidden text-center py-20">
    <div class="text-4xl mb-4">â¤ï¸</div>
    <div class="text-zinc-500 font-bold">ì°œí•œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>
    <p class="text-zinc-600 text-sm mt-2">ë§ˆìŒì— ë“œëŠ” ì˜ìƒì— í•˜íŠ¸ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
  </div>
  
  
  <div id="emptyRecent" class="hidden text-center py-20">
    <div class="text-4xl mb-4">ğŸ•</div>
    <div class="text-zinc-500 font-bold">ìµœê·¼ ë³¸ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>
    <p class="text-zinc-600 text-sm mt-2">ì˜ìƒì„ í´ë¦­í•´ì„œ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
  </div>

<div id="detailModal" class="fixed inset-0 z-[999] hidden items-center justify-center modal-backdrop backdrop-blur-xl md:p-4">
  <div id="detailBox" class="bg-zinc-950 w-full md:max-w-7xl h-full md:h-auto md:max-h-[92vh] md:rounded-2xl overflow-hidden shadow-2xl border border-zinc-800/50 relative flex flex-col">
    <div class="absolute top-4 left-4 md:top-6 md:left-6 z-50">
  <span id="modalViews" class="text-zinc-400 text-sm bg-black/50 px-3 py-1.5 rounded-full backdrop-blur-sm">ğŸ‘ 0íšŒ</span>
</div>
<div class="absolute top-4 right-4 md:top-6 md:right-6 z-50 flex gap-2">
      <button id="modalBookmarkBtn" class="bookmark-btn bg-zinc-800/80 hover:bg-zinc-700 w-10 h-10 rounded-md flex items-center justify-center border border-zinc-700 transition text-white" title="ì°œí•˜ê¸°">
        <i class="fas fa-heart text-lg"></i>
      </button>
      <button id="editBtn" class="hidden bg-zinc-800/80 hover:bg-highlight hover:text-black w-10 h-10 rounded-md flex items-center justify-center border border-zinc-700 transition" title="ìˆ˜ì •">
        <i class="fas fa-pen text-sm"></i>
      </button>
      <button type="button" id="detailCloseBtn" class="bg-zinc-900/80 hover:bg-red-500 w-10 h-10 rounded-md flex items-center justify-center border border-zinc-800 transition" title="ë‹«ê¸°">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto p-4 md:p-10">
      <div class="w-full max-w-3xl mx-auto mt-12 md:mt-4 mb-6">
        <div class="text-center px-4">
          <h2 id="modalTitle" class="text-2xl md:text-4xl font-black text-white mb-4 leading-[1.2] tracking-tight">ì œëª©</h2>
          
          
        </div>
       <div class="w-full flex flex-col items-center gap-4 mt-6">
  <p class="text-zinc-400 text-sm text-center mb-3">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì›ë³¸ ì˜ìƒì„ í™•ì¸í•˜ì„¸ìš”.</p>
  <div id="videoLinkGroup" class="flex justify-center gap-2 md:gap-3"></div>
</div>
<div class="mt-6 mb-2 text-center">
  <p class="text-zinc-400 text-sm text-center">âš¡ ìº¡ì²˜ë§Œ ë³´ê³  ë¹ ë¥´ê²Œ íŒë‹¨í•˜ì„¸ìš”.<br class="md:hidden"> ì˜ìƒë³´ëŠ” ì‹œê°„ ì¡°ì°¨ ì•„ê»´ë“œë¦½ë‹ˆë‹¤.</p>
</div>
      </div>
      <div id="imageRowsContainer" class="space-y-6"></div>
    </div>
  </div>
</div>

<div id="subscribeModal" class="hidden fixed inset-0 z-[1000] items-center justify-center bg-black/80 backdrop-blur-sm">
  <div id="subscribeBox" class="w-full max-w-md mx-4 rounded-2xl border border-zinc-700 bg-zinc-950 shadow-2xl overflow-hidden">
    <div class="p-6 flex items-start justify-between gap-4">
      <div>
        <h3 class="text-xl font-black text-white">êµ¬ë…ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
        <p class="text-zinc-400 text-sm mt-2 leading-relaxed">ì´ ì¹´ë“œëŠ” <span class="text-white font-bold">êµ¬ë…ì ì „ìš© ìƒì„¸ì •ë³´</span>ì…ë‹ˆë‹¤.<br>êµ¬ë…í•˜ë©´ ëª¨ë“  ì˜ìƒ ì†ŒìŠ¤ + ì¿ íŒ¡ ë§í¬ë¥¼ ë°”ë¡œ ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
      </div>
      <button type="button" id="subCloseBtn" class="text-zinc-400 hover:text-white text-2xl leading-none">Ã—</button>
    </div>
    <div class="px-6 pb-6 flex flex-col gap-3">
      <a href="/pricing" class="bg-lime-400 text-black font-black py-3 rounded-md text-center hover:bg-white transition">ìš”ê¸ˆì œ ë³´ëŸ¬ê°€ê¸°</a>
      <button type="button" id="subLaterBtn" class="bg-zinc-900 hover:bg-zinc-800 text-white font-bold py-3 rounded-md border border-zinc-800">ì§€ê¸ˆì€ ê·¸ëƒ¥ ë‘˜ëŸ¬ë³¼ê²Œìš”</button>
    </div>
  </div>
</div>
<script>
const IS_ADMIN = {{ session.get("admin", false) | tojson }};
const IS_SUBSCRIBER = {{ session.get("subscriber", false) | tojson }};
const IS_TRIAL = {{ session.get("is_trial", false) | tojson }};

let currentPage = 1;
let isLoading = false;
let hasMore = true;
let currentFilter = 'all';
let allPosts = [];
let currentModalItem = null;

// ===== ë¶ë§ˆí¬ ê´€ë ¨ =====
function getBookmarks() { try { return JSON.parse(localStorage.getItem('gallery_bookmarks') || '[]'); } catch { return []; } }
function saveBookmarks(ids) { localStorage.setItem('gallery_bookmarks', JSON.stringify(ids)); }
function isBookmarked(id) { return getBookmarks().includes(id); }
function toggleBookmark(id) {
  let bookmarks = getBookmarks();
  if (bookmarks.includes(id)) { bookmarks = bookmarks.filter(b => b !== id); }
  else { bookmarks.unshift(id); }
  saveBookmarks(bookmarks);
  return bookmarks.includes(id);
}

// ===== ìµœê·¼ ë³¸ ê´€ë ¨ =====
function getRecentViewed() { try { return JSON.parse(localStorage.getItem('gallery_recent') || '[]'); } catch { return []; } }
function saveRecentViewed(ids) { localStorage.setItem('gallery_recent', JSON.stringify(ids.slice(0, 20))); }
function addRecentViewed(id) {
  let recent = getRecentViewed();
  recent = recent.filter(r => r !== id);
  recent.unshift(id);
  saveRecentViewed(recent);
}

// ===== ìœ í‹¸ë¦¬í‹° =====
function normalizeUrl(u) { if (!u) return ""; let s = (u || "").trim(); if (!s) return ""; if (!/^https?:\/\//i.test(s)) s = "https://" + s.replace(/^\/+/, ""); return s; }
function escapeHtml(str) { return (str || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

function getPlatformInfo(url) {
  const u = (url || "").toLowerCase();
  // SNS í”Œë«í¼
  if (u.includes("instagram.com") || u.includes("instagr.am")) return { name: "Instagram", icon: "fab fa-instagram", color: "bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500" };
  if (u.includes("xiaohongshu.com") || u.includes("xhslink.com")) return { name: "å°çº¢ä¹¦", icon: "fas fa-book", color: "bg-red-500" };
  if (u.includes("tiktok.com") || u.includes("tiktok")) return { name: "TikTok", icon: "fab fa-tiktok", color: "bg-black border border-white/20" };
  if (u.includes("douyin.com") || u.includes("iesdouyin.com")) return { name: "æŠ–éŸ³", icon: "fab fa-tiktok", color: "bg-black border border-white/20" };
  if (u.includes("youtube.com") || u.includes("youtu.be")) return { name: "YouTube", icon: "fab fa-youtube", color: "bg-red-600" };
  if (u.includes("twitter.com") || u.includes("x.com")) return { name: "X", icon: "fab fa-x-twitter", color: "bg-black border border-white/20" };
  if (u.includes("facebook.com") || u.includes("fb.com")) return { name: "Facebook", icon: "fab fa-facebook", color: "bg-blue-600" };
  if (u.includes("threads.net")) return { name: "Threads", icon: "fas fa-at", color: "bg-black border border-white/20" };
  // í´ë¼ìš°ë“œ/íŒŒì¼ ê³µìœ 
  if (u.includes("mybox.naver.com")) return { name: "ë„¤ì´ë²„ MYBOX", icon: "fas fa-cloud", color: "bg-green-500" };
  if (u.includes("naver.com") || u.includes("naver.me")) return { name: "ë„¤ì´ë²„", icon: "fas fa-n", color: "bg-green-500" };
  if (u.includes("drive.google.com")) return { name: "Google Drive", icon: "fab fa-google-drive", color: "bg-yellow-500" };
  if (u.includes("dropbox.com")) return { name: "Dropbox", icon: "fab fa-dropbox", color: "bg-blue-500" };
  if (u.includes("onedrive.com") || u.includes("1drv.ms")) return { name: "OneDrive", icon: "fab fa-microsoft", color: "bg-blue-400" };
  if (u.includes("mega.nz")) return { name: "MEGA", icon: "fas fa-cloud", color: "bg-red-600" };
  // ê¸°íƒ€ ë§í¬
  return { name: "ì˜ìƒë§í¬", icon: "fas fa-play-circle", color: "bg-zinc-600" };
}

// ===== êµ¬ë… ëª¨ë‹¬ =====
function openSubscribeModal() { const m = document.getElementById("subscribeModal"); m.classList.remove("hidden"); m.classList.add("flex"); document.body.style.overflow = "hidden"; }
function closeSubscribeModal() { const m = document.getElementById("subscribeModal"); m.classList.add("hidden"); m.classList.remove("flex"); document.body.style.overflow = ""; }

// ===== ì¡°íšŒìˆ˜ ì¦ê°€ =====
async function incrementViewCount(postId) { try { const res = await fetch(`/api/gallery/${postId}/view`, { method: 'POST' }); const data = await res.json(); return data.view_count || 0; } catch (e) { return 0; } }

// ===== ê°¤ëŸ¬ë¦¬ ë¡œë“œ (ë¬´í•œìŠ¤í¬ë¡¤) =====
async function loadGallery(reset = false) {
  if (isLoading || (!hasMore && !reset)) return;
  
  if (reset) {
    currentPage = 1;
    hasMore = true;
    allPosts = [];
    document.getElementById('gallery-grid').innerHTML = '';
  }
  
  isLoading = true;
  showLoadingSpinner();
  
  try {
    const category = (currentFilter === 'all' || currentFilter === 'bookmark' || currentFilter === 'recent' || currentFilter === 'popular') ? '' : currentFilter;
    const res = await fetch(`/api/gallery?page=${currentPage}&category=${category}&t=${Date.now()}`);
    const data = await res.json();
    
    allPosts = [...allPosts, ...data.posts];
    hasMore = data.has_next;
    currentPage++;
    
    appendGalleryItems(data.posts);
  } catch (e) {
    console.error('Gallery load error:', e);
  } finally {
    isLoading = false;
    hideLoadingSpinner();
  }
}

// ===== ì¹´ë“œ ì¶”ê°€ =====
function appendGalleryItems(list) {
  const grid = document.getElementById('gallery-grid');
  const empty = document.getElementById('emptyState');
  
  if (allPosts.length === 0 && list.length === 0) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");
  list.forEach((item) => grid.appendChild(createGalleryCard(item)));
}

// ===== ì¹´ë“œ ìƒì„± =====
function createGalleryCard(item) {
  const imgs = Array.isArray(item.images) ? item.images : [];
  const thumb = imgs.length ? (imgs[0] || "") : "";
  const thumbUrl = thumb ? (thumb.startsWith("http") || thumb.startsWith("/r2/") ? thumb : `/static/uploads/${thumb}`) : "";
  const viewCount = item.view_count || 0;
  const bookmarked = isBookmarked(item.id);
  const canAccess = IS_ADMIN || IS_SUBSCRIBER || IS_TRIAL || item.is_free;
  const titleSafe = escapeHtml(item.title || "");

  const card = document.createElement('div');
  card.className = 'gallery-card cursor-pointer group';
  card.dataset.category = (item.category || "all").toLowerCase();
  card.dataset.id = item.id;

  card.addEventListener("click", (e) => {
    if (e.target.closest('.card-bookmark-btn')) return;
    e.preventDefault(); e.stopPropagation();
    if (canAccess) return openDetailModal(item);
    return openSubscribeModal();
  });

  const adminEditBtn = IS_ADMIN ? `<a href="/admin/posts/${item.id}/edit?next=/gallery" class="absolute top-2 right-2 z-20 w-9 h-9 rounded-lg bg-black/60 hover:bg-highlight text-white hover:text-black flex items-center justify-center border border-white/10" title="ìˆ˜ì •" onclick="event.stopPropagation();"><i class="fas fa-pen text-sm"></i></a>` : "";

  card.innerHTML = `
    <div class="relative aspect-shorts rounded-lg overflow-hidden bg-zinc-900 border border-white/5 group-hover:border-white/20 transition-all duration-150">
      ${adminEditBtn}
      <img src="${thumbUrl}" class="w-full h-full object-cover transition-all duration-150" alt="${titleSafe}" loading="lazy">
      <button class="card-bookmark-btn absolute top-2 ${IS_ADMIN ? 'right-12' : 'right-2'} z-20 w-8 h-8 rounded-lg bg-black/60 hover:bg-black/80 flex items-center justify-center border border-white/10 transition ${bookmarked ? 'text-red-500' : 'text-white/60 hover:text-red-400'}" onclick="event.stopPropagation(); handleCardBookmark(${item.id}, this);" title="${bookmarked ? 'ì°œ í•´ì œ' : 'ì°œí•˜ê¸°'}"><i class="fas fa-heart text-sm"></i></button>
      ${item.is_free ? `<div class="absolute top-2 left-2 px-2 py-1 rounded bg-red-500 text-white text-xs font-bold">ë¬´ë£Œ</div>` : (viewCount >= 50 ? `<div class="absolute top-2 left-2 px-2 py-1 rounded bg-orange-500 text-white text-xs font-bold flex items-center gap-1">ğŸ”¥ HOT</div>` : '')}
      ${!canAccess ? `<div class="absolute inset-0 bg-black/40 flex items-center justify-center"><span class="text-2xl">ğŸ”’</span></div>` : ''}
    </div>
    <div class="mt-2 px-1">
      <div class="text-white text-sm font-bold truncate">${titleSafe}</div>
      <div class="text-zinc-500 text-xs mt-1 flex items-center gap-1">
        <i class="far fa-eye"></i> ${viewCount}
      </div>
    </div>
  `;
  
  return card;
}



// ===== ë¡œë”© ìŠ¤í”¼ë„ˆ =====
function showLoadingSpinner() {
  let spinner = document.getElementById('loadingSpinner');
  if (!spinner) {
    spinner = document.createElement('div');
    spinner.id = 'loadingSpinner';
    spinner.className = 'col-span-full flex justify-center py-8';
    spinner.innerHTML = '<div class="w-8 h-8 border-2 border-white/20 border-t-[#c4ff00] rounded-full animate-spin"></div>';
    document.getElementById('gallery-grid').appendChild(spinner);
  }
  spinner.classList.remove('hidden');
}

function hideLoadingSpinner() {
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) spinner.classList.add('hidden');
}

// ===== ë¬´í•œ ìŠ¤í¬ë¡¤ ê°ì§€ =====
function handleScroll() {
  if (currentFilter === 'bookmark' || currentFilter === 'recent' || currentFilter === 'popular') return;
  const scrollY = window.scrollY;
  const windowHeight = window.innerHeight;
  const docHeight = document.documentElement.scrollHeight;
  if (scrollY + windowHeight >= docHeight - 500) loadGallery();
}

// ===== ê²€ìƒ‰ =====
function searchGallery(query) {
  const cards = document.querySelectorAll('.gallery-card');
  const q = query.toLowerCase().trim();
  
  cards.forEach(card => {
    const title = card.querySelector('.text-white')?.textContent?.toLowerCase() || '';
    if (q === '' || title.includes(q)) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}
  
// ===== í•„í„° =====
function filterGallery(category, btn) {
  currentFilter = category;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('emptyBookmark').classList.add('hidden');
  document.getElementById('emptyRecent').classList.add('hidden');
  document.getElementById('excelDownloadBtn').classList.add('hidden');

  if (category === 'bookmark') renderBookmarkedItems();
  else if (category === 'recent') renderRecentItems();
  else if (category === 'popular') renderPopularItems();
  else loadGallery(true);
}

async function renderBookmarkedItems() {
  const bookmarks = getBookmarks();
  const grid = document.getElementById('gallery-grid');
  const excelBtn = document.getElementById('excelDownloadBtn');
  grid.innerHTML = '';
  
  if (bookmarks.length === 0) { 
    document.getElementById('emptyBookmark').classList.remove('hidden'); 
    excelBtn.classList.add('hidden');
    return; 
  }
  
  // ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
  showLoadingSpinner();
  try {
    const res = await fetch(`/api/gallery?page=1&per_page=100&t=${Date.now()}`);
    const data = await res.json();
    const allData = data.posts || [];
    
    const bookmarkedPosts = allData.filter(p => bookmarks.includes(p.id));
    
    hideLoadingSpinner();
    
    if (bookmarkedPosts.length === 0) { 
      document.getElementById('emptyBookmark').classList.remove('hidden'); 
      excelBtn.classList.add('hidden');
      return; 
    }
    
    document.getElementById('emptyBookmark').classList.add('hidden');
    excelBtn.classList.remove('hidden');
    
    bookmarkedPosts.sort((a, b) => bookmarks.indexOf(a.id) - bookmarks.indexOf(b.id));
    bookmarkedPosts.forEach(item => grid.appendChild(createGalleryCard(item)));
    
    // allPosts ì—…ë°ì´íŠ¸ (ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš©)
    allPosts = allData;
  } catch (e) {
    hideLoadingSpinner();
    console.error('Bookmark load error:', e);
  }
}

async function renderRecentItems() {
  const recent = getRecentViewed();
  const grid = document.getElementById('gallery-grid');
  grid.innerHTML = '';
  
  if (recent.length === 0) { 
    document.getElementById('emptyRecent').classList.remove('hidden'); 
    return; 
  }
  
  // ì „ì²´ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
  showLoadingSpinner();
  try {
    const res = await fetch(`/api/gallery?page=1&per_page=100&t=${Date.now()}`);
    const data = await res.json();
    const allData = data.posts || [];
    
    const recentPosts = allData.filter(p => recent.includes(p.id));
    
    hideLoadingSpinner();
    
    if (recentPosts.length === 0) { 
      document.getElementById('emptyRecent').classList.remove('hidden'); 
      return; 
    }
    
    document.getElementById('emptyRecent').classList.add('hidden');
    recentPosts.sort((a, b) => recent.indexOf(a.id) - recent.indexOf(b.id));
    recentPosts.forEach(item => grid.appendChild(createGalleryCard(item)));
    
    // allPosts ì—…ë°ì´íŠ¸
    allPosts = allData;
  } catch (e) {
    hideLoadingSpinner();
    console.error('Recent load error:', e);
  }
}


function renderPopularItems() {
  const grid = document.getElementById('gallery-grid');
  grid.innerHTML = '';
  const sorted = [...allPosts].sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
  sorted.forEach(item => grid.appendChild(createGalleryCard(item)));
}

// ===== ë¶ë§ˆí¬ í•¸ë“¤ëŸ¬ =====
function handleCardBookmark(id, btn) {
  const isNowBookmarked = toggleBookmark(id);
  if (isNowBookmarked) { btn.classList.remove('text-white/60', 'hover:text-red-400'); btn.classList.add('text-red-500'); btn.title = 'ì°œ í•´ì œ'; }
  else { 
    btn.classList.add('text-white/60', 'hover:text-red-400'); btn.classList.remove('text-red-500'); btn.title = 'ì°œí•˜ê¸°';
    if (currentFilter === 'bookmark') { btn.closest('.gallery-card').remove(); if (getBookmarks().length === 0) document.getElementById('emptyBookmark').classList.remove('hidden'); }
  }
}

// ===== ìƒì„¸ ëª¨ë‹¬ =====
async function openDetailModal(item) {
  currentModalItem = item;
  const modal = document.getElementById('detailModal');
  modal.classList.remove("hidden"); modal.classList.add("flex");
  document.body.style.overflow = "hidden";

  addRecentViewed(item.id);
  const newViewCount = await incrementViewCount(item.id);
  document.getElementById('modalViews').innerText = `ğŸ‘ ${newViewCount}íšŒ`;
  const card = document.querySelector(`.gallery-card[data-id="${item.id}"] .view-count`);
  if (card) card.innerText = newViewCount;

  document.getElementById('modalTitle').innerText = item.title || "";
  updateModalBookmarkBtn(item.id);

  

  const editBtn = document.getElementById("editBtn");
  if (IS_ADMIN && item.id) { editBtn.classList.remove("hidden"); editBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); window.location.href = `/admin/posts/${item.id}/edit?next=/gallery`; }; }
  else { editBtn.classList.add("hidden"); editBtn.onclick = null; }

  const links = (item.links || []).filter(x => (x||"").trim().length > 0).slice(0,3);
  const coupang = normalizeUrl(item.coupang_link || "");
  const group = document.getElementById('videoLinkGroup');
  group.innerHTML = "";
  
   
  if (links.length === 0 && !coupang) { group.innerHTML = `<div class="text-zinc-600 text-xs font-bold">ë“±ë¡ëœ ì°¸ê³  ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; }
  else { 
    links.forEach((u) => { 
      const platform = getPlatformInfo(u);
      const a = document.createElement("a"); 
      a.href = normalizeUrl(u); 
      a.target = "_blank"; 
      a.rel = "noopener noreferrer"; 
      a.className = `${platform.color} hover:opacity-80 text-white px-3 py-2 md:px-6 md:py-3 rounded-lg md:rounded-md text-xs md:text-sm font-bold transition-all duration-150 flex items-center gap-1 md:gap-2 shadow-lg`; 
      a.innerHTML = `<i class="${platform.icon} text-lg"></i> ${platform.name}`; 
      group.appendChild(a); 
    }); 
  }

  const images = (Array.isArray(item.images) ? item.images : []).slice(0,5);
  const rowContainer = document.getElementById('imageRowsContainer');
  rowContainer.innerHTML = "";
  const rowDiv = document.createElement("div");
  rowDiv.className = "glass-panel p-5 md:p-8 rounded-md relative";

  let html = coupang ? `<div class="absolute top-5 right-5 z-10 hidden md:block"><a href="${coupang}" target="_blank" rel="noopener noreferrer" class="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2.5 rounded-md font-bold text-sm flex items-center gap-2 border border-zinc-600 transition">ğŸš€ ì¿ íŒ¡ ë§í¬ ë³´ê¸°</a></div>` : "";
  html += `<div class="flex items-center gap-3 mb-6"><div class="w-9 h-9 bg-highlight rounded-lg flex items-center justify-center text-black font-black text-sm shadow-lg">ğŸ“¸</div><div><h4 class="text-white font-black text-base md:text-lg">í•˜ì´ë¼ì´íŠ¸ ìº¡ì²˜</h4><p class="text-zinc-500 text-sm font-bold">ìµœëŒ€ 5ì¥ì˜ í•µì‹¬ ì¥ë©´</p></div></div>`;
  html += coupang ? `<div class="md:hidden w-full mb-5"><a href="${coupang}" target="_blank" rel="noopener noreferrer" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-md font-bold flex justify-center items-center gap-2 text-sm border border-zinc-600 transition">ğŸš€ ì¿ íŒ¡ ë§í¬ ë³´ê¸°</a></div>` : "";

  if (images.length === 0) { html += `<div class="text-zinc-600 text-sm font-bold">ë“±ë¡ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; }
  else {
    html += `<div class="capture-row">`;
    images.forEach((img, i) => {
      const safeImg = (img || "").trim();
      const url = safeImg.startsWith("http") || safeImg.startsWith("/r2/") ? safeImg : `/static/uploads/${safeImg}`;
      html += `<div class="capture-item aspect-shorts rounded-lg overflow-hidden ${i===0 ? "border-2 border-highlight" : "border border-white/10"} bg-zinc-900 transition-all duration-150 hover:border-white/30 relative"><img src="${url}" class="w-full h-full object-cover ${i===0 ? "opacity-95" : "opacity-80 hover:opacity-100"} transition-opacity duration-150">${i===0 ? `<div class="absolute top-3 left-3 bg-highlight text-black text-[8px] font-black px-2 py-0.5 rounded-sm shadow-md uppercase tracking-tighter">Main</div>` : ""}</div>`;
    });
    html += `</div>`;
  }
  rowDiv.innerHTML = html;
  rowContainer.appendChild(rowDiv);
}

function updateModalBookmarkBtn(id) {
  const btn = document.getElementById('modalBookmarkBtn');
  if (isBookmarked(id)) { btn.classList.add('active'); btn.title = 'ì°œ í•´ì œ'; }
  else { btn.classList.remove('active'); btn.title = 'ì°œí•˜ê¸°'; }
}

function closeDetailModal() { 
  const modal = document.getElementById('detailModal'); 
  modal.classList.add('hidden'); 
  modal.classList.remove('flex'); 
  document.body.style.overflow = ''; 
  currentModalItem = null; 
}
  
// ===== ì—‘ì…€ ë‹¤ìš´ë¡œë“œ =====
function exportBookmarksToExcel() {
  const bookmarks = getBookmarks();
  const bookmarkedPosts = allPosts.filter(p => bookmarks.includes(p.id));
  
  if (bookmarkedPosts.length === 0) {
    alert('ì°œí•œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // CSV ë°ì´í„° ìƒì„± (ì›ë³¸ë§í¬ 3ê°œ ê°ê° ì—´ë¡œ)
  let csv = '\uFEFFì œëª©,ì›ë³¸ë§í¬1,ì›ë³¸ë§í¬2,ì›ë³¸ë§í¬3,ì¿ íŒ¡ë§í¬,ì¹´í…Œê³ ë¦¬\n';
  
  bookmarkedPosts.forEach(item => {
    const title = (item.title || '').replace(/,/g, ' ');
    const links = (item.links || []).filter(x => x);
    const link1 = links[0] || '';
    const link2 = links[1] || '';
    const link3 = links[2] || '';
    const coupang = item.coupang_link || '';
    const category = item.category || '';
    csv += `"${title}","${link1}","${link2}","${link3}","${coupang}","${category}"\n`;
  });
  
  // ë‹¤ìš´ë¡œë“œ
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `moneying_ì°œëª©ë¡_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
// ===== ì´ˆê¸°í™” =====
window.addEventListener("load", () => {
  loadGallery();
  window.addEventListener('scroll', handleScroll);

  document.getElementById('modalBookmarkBtn')?.addEventListener('click', (e) => {
    e.preventDefault(); e.stopPropagation();
    if (!currentModalItem) return;
    const isNowBookmarked = toggleBookmark(currentModalItem.id);
    updateModalBookmarkBtn(currentModalItem.id);
    const cardBtn = document.querySelector(`.gallery-card[data-id="${currentModalItem.id}"] .card-bookmark-btn`);
    if (cardBtn) {
      if (isNowBookmarked) { cardBtn.classList.remove('text-white/60', 'hover:text-red-400'); cardBtn.classList.add('text-red-500'); }
      else { cardBtn.classList.add('text-white/60', 'hover:text-red-400'); cardBtn.classList.remove('text-red-500'); }
    }
  });

  document.getElementById("detailCloseBtn")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); closeDetailModal(); });
  const detailModal = document.getElementById("detailModal");
  const detailBox = document.getElementById("detailBox");
  detailModal?.addEventListener("click", (e) => { if (e.target === detailModal) closeDetailModal(); });
  detailBox?.addEventListener("click", (e) => e.stopPropagation());

  const subModal = document.getElementById("subscribeModal");
  const subBox = document.getElementById("subscribeBox");
  subModal?.addEventListener("click", (e) => { if (e.target === subModal) closeSubscribeModal(); });
  subBox?.addEventListener("click", (e) => e.stopPropagation());

  document.getElementById("subCloseBtn")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); closeSubscribeModal(); });
  document.getElementById("subLaterBtn")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); closeSubscribeModal(); });

  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (subModal && !subModal.classList.contains("hidden")) return closeSubscribeModal();
    if (detailModal && !detailModal.classList.contains("hidden")) return closeDetailModal();
  });
});
</script>

{% endblock %}
