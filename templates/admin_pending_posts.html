{% extends "admin_base.html" %}
{% block title %}íŒë§¤ì ê²Œì‹œë¬¼ ìŠ¹ì¸ - MONEYING Admin{% endblock %}

{% block page_title %}ğŸ“¸ íŒë§¤ì ê²Œì‹œë¬¼ ìŠ¹ì¸{% endblock %}
{% block page_desc %}íŒë§¤ìê°€ ë“±ë¡í•œ ê²Œì‹œë¬¼ì„ ê²€í† í•˜ê³  ìŠ¹ì¸í•´ì£¼ì„¸ìš”.{% endblock %}

{% block content_admin %}

{% if posts %}
<div class="space-y-4">
  {% for post in posts %}
  <div id="post-{{ post.id }}" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-5">
    <div class="flex flex-col md:flex-row gap-5">
      
      <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
      <div class="shrink-0">
        <div class="grid grid-cols-3 gap-2 w-48">
          {% for img in post.to_dict().images[:3] %}
          <div class="aspect-[9/16] rounded-lg overflow-hidden bg-zinc-800">
            <img src="/static/uploads/{{ img }}" class="w-full h-full object-cover" alt="">
          </div>
          {% else %}
          <div class="aspect-[9/16] rounded-lg bg-zinc-800 flex items-center justify-center col-span-3">
            <i class="fas fa-image text-zinc-600 text-2xl"></i>
          </div>
          {% endfor %}
        </div>
        {% if post.to_dict().images | length > 3 %}
        <p class="text-zinc-500 text-xs text-center mt-1">+{{ post.to_dict().images | length - 3 }}ì¥ ë”</p>
        {% endif %}
      </div>
      
      <!-- ì •ë³´ -->
      <div class="flex-1">
        <div class="flex items-start justify-between mb-3">
          <div>
            <h3 class="font-black text-white text-lg">{{ post.title }}</h3>
            <p class="text-zinc-500 text-sm mt-1">
              íŒë§¤ì ID: {{ post.seller_id }} Â· 
              {{ post.created_at.strftime('%Y-%m-%d %H:%M') if post.created_at else '' }}
            </p>
          </div>
          <span class="px-2 py-1 bg-orange-500/20 text-orange-400 text-xs font-bold rounded-full">ìŠ¹ì¸ëŒ€ê¸°</span>
        </div>
        
        <!-- ì¿ íŒ¡ ë§í¬ -->
        <div class="mb-3">
          <p class="text-xs text-zinc-500 mb-1">ì¿ íŒ¡ ë§í¬</p>
          {% if post.coupang_link %}
          <a href="{{ post.coupang_link }}" target="_blank" class="text-blue-400 text-sm hover:underline break-all">
            {{ post.coupang_link[:60] }}{% if post.coupang_link|length > 60 %}...{% endif %}
          </a>
          {% else %}
          <span class="text-red-400 text-sm">ì—†ìŒ</span>
          {% endif %}
        </div>
        
        <!-- ì˜ìƒ ë§í¬ -->
        <div class="mb-4">
          <p class="text-xs text-zinc-500 mb-1">ì˜ìƒ ë§í¬</p>
          <div class="flex flex-wrap gap-2">
            {% if post.video_url %}
            <a href="{{ post.video_url }}" target="_blank" class="px-2 py-1 bg-zinc-800 text-zinc-300 text-xs rounded hover:bg-zinc-700">
              <i class="fas fa-external-link-alt mr-1"></i>ë§í¬ 1
            </a>
            {% endif %}
            {% if post.video_url2 %}
            <a href="{{ post.video_url2 }}" target="_blank" class="px-2 py-1 bg-zinc-800 text-zinc-300 text-xs rounded hover:bg-zinc-700">
              <i class="fas fa-external-link-alt mr-1"></i>ë§í¬ 2
            </a>
            {% endif %}
            {% if post.video_url3 %}
            <a href="{{ post.video_url3 }}" target="_blank" class="px-2 py-1 bg-zinc-800 text-zinc-300 text-xs rounded hover:bg-zinc-700">
              <i class="fas fa-external-link-alt mr-1"></i>ë§í¬ 3
            </a>
            {% endif %}
            {% if not post.video_url and not post.video_url2 and not post.video_url3 %}
            <span class="text-zinc-500 text-xs">ì—†ìŒ</span>
            {% endif %}
          </div>
        </div>
        
        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="flex gap-2">
          <button onclick="openModal('approve', {{ post.id }}, '{{ post.title | e }}')" 
                  class="px-4 py-2 bg-green-600 text-white font-bold rounded-xl hover:bg-green-500 transition text-sm">
            <i class="fas fa-check mr-1"></i>ìŠ¹ì¸
          </button>
          <button onclick="openModal('reject', {{ post.id }}, '{{ post.title | e }}')" 
                  class="px-4 py-2 bg-red-600 text-white font-bold rounded-xl hover:bg-red-500 transition text-sm">
            <i class="fas fa-times mr-1"></i>ë°˜ë ¤
          </button>
        </div>
      </div>
      
    </div>
  </div>
  {% endfor %}
</div>

{% else %}
<div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-12 text-center">
  <div class="w-16 h-16 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4">
    <i class="fas fa-check-circle text-2xl text-green-500"></i>
  </div>
  <p class="text-zinc-400">ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì¸ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
</div>
{% endif %}

<!-- í™•ì¸ ëª¨ë‹¬ -->
<div id="confirmModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 w-full max-w-md">
    <div id="modalIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"></div>
    <h3 id="modalTitle" class="text-xl font-black text-center mb-2"></h3>
    <p id="modalDesc" class="text-zinc-400 text-center mb-6"></p>
    
    <div class="flex gap-3">
      <button onclick="closeModal()" class="flex-1 py-3 bg-zinc-800 text-white font-bold rounded-xl hover:bg-zinc-700 transition">
        ì·¨ì†Œ
      </button>
      <button id="modalConfirmBtn" class="flex-1 py-3 font-black rounded-xl transition">
        í™•ì¸
      </button>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
  <div class="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 w-full max-w-md text-center">
    <div id="resultIcon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"></div>
    <h3 id="resultTitle" class="text-xl font-black mb-2"></h3>
    <p id="resultDesc" class="text-zinc-400 mb-6"></p>
    <button onclick="closeResultModal()" class="w-full py-3 bg-[#c4ff00] text-black font-black rounded-xl hover:bg-white transition">
      í™•ì¸
    </button>
  </div>
</div>

<script>
let currentAction = '';
let currentPostId = null;

function openModal(action, postId, title) {
  currentAction = action;
  currentPostId = postId;
  
  const modal = document.getElementById('confirmModal');
  const icon = document.getElementById('modalIcon');
  const titleEl = document.getElementById('modalTitle');
  const desc = document.getElementById('modalDesc');
  const confirmBtn = document.getElementById('modalConfirmBtn');
  
  if (action === 'approve') {
    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-green-500/20';
    icon.innerHTML = '<i class="fas fa-check text-3xl text-green-400"></i>';
    titleEl.textContent = 'ê²Œì‹œë¬¼ ìŠ¹ì¸';
    desc.innerHTML = '<strong class="text-white">"' + title + '"</strong><br>ì´ ê²Œì‹œë¬¼ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-green-400">ìŠ¹ì¸ ì‹œ ê°¤ëŸ¬ë¦¬ì— ë°”ë¡œ ë…¸ì¶œë©ë‹ˆë‹¤.</span>';
    confirmBtn.className = 'flex-1 py-3 font-black rounded-xl transition bg-green-600 text-white hover:bg-green-500';
    confirmBtn.textContent = 'ìŠ¹ì¸í•˜ê¸°';
  } else {
    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-red-500/20';
    icon.innerHTML = '<i class="fas fa-times text-3xl text-red-400"></i>';
    titleEl.textContent = 'ê²Œì‹œë¬¼ ë°˜ë ¤';
    desc.innerHTML = '<strong class="text-white">"' + title + '"</strong><br>ì´ ê²Œì‹œë¬¼ì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-red-400">íŒë§¤ìì—ê²Œ ë°˜ë ¤ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</span>';
    confirmBtn.className = 'flex-1 py-3 font-black rounded-xl transition bg-red-600 text-white hover:bg-red-500';
    confirmBtn.textContent = 'ë°˜ë ¤í•˜ê¸°';
  }
  
  confirmBtn.onclick = handleConfirm;
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeModal() {
  const modal = document.getElementById('confirmModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  currentAction = '';
  currentPostId = null;
}

function showResult(success, action) {
  closeModal();
  
  const modal = document.getElementById('resultModal');
  const icon = document.getElementById('resultIcon');
  const title = document.getElementById('resultTitle');
  const desc = document.getElementById('resultDesc');
  
  if (success) {
    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-green-500/20';
    icon.innerHTML = '<i class="fas fa-check text-3xl text-green-400"></i>';
    title.textContent = action === 'approve' ? 'ìŠ¹ì¸ ì™„ë£Œ' : 'ë°˜ë ¤ ì™„ë£Œ';
    desc.textContent = action === 'approve' ? 'ê²Œì‹œë¬¼ì´ ê°¤ëŸ¬ë¦¬ì— ë…¸ì¶œë©ë‹ˆë‹¤.' : 'íŒë§¤ìì—ê²Œ ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
  } else {
    icon.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-red-500/20';
    icon.innerHTML = '<i class="fas fa-exclamation text-3xl text-red-400"></i>';
    title.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
    desc.textContent = 'ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
  }
  
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeResultModal() {
  const modal = document.getElementById('resultModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

async function handleConfirm() {
  const action = currentAction;
  const postId = currentPostId;
  
  const confirmBtn = document.getElementById('modalConfirmBtn');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
  
  try {
    const endpoint = action === 'approve' 
      ? '/admin/pending-posts/' + postId + '/approve'
      : '/admin/pending-posts/' + postId + '/reject';
    
    const res = await fetch(endpoint, { method: 'POST' });
    const data = await res.json();
    
    if (data.ok) {
      document.getElementById('post-' + postId).remove();
      showResult(true, action);
      
      // ë‚¨ì€ ê²Œì‹œë¬¼ ì—†ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
      setTimeout(function() {
        if (!document.querySelector('[id^="post-"]')) {
          location.reload();
        }
      }, 1500);
    } else {
      showResult(false, action);
    }
  } catch (e) {
    showResult(false, action);
  }
  
  confirmBtn.disabled = false;
}
</script>

{% endblock %}